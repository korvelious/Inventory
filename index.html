<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }

        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .setup-credentials {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .setup-credentials h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .setup-credentials p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }

        .scanner-frame {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        #scanner-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: #000;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scanner-target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 3px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .scanner-instructions {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 0 0 15px 15px;
        }

        .scanner-instructions p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .scanner-status {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .scanner-status p {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
        }

        .camera-controls {
            margin: 20px 0;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .inventory-table th,
        .inventory-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
        }

        .inventory-table tr:hover {
            background: #f8f9fa;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .barcode {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid #e9ecef;
            margin: 10px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .settings-section p {
            margin: 10px 0;
            color: #6c757d;
        }

        .settings-section .btn {
            margin: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .inventory-table {
                font-size: 0.9em;
            }

            .inventory-table th,
            .inventory-table td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h1>🔐 Inventory System</h1>
        <form class="login-form" id="login-form">
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="login-btn">Login</button>
        </form>
        
        <div class="setup-credentials" id="setup-credentials">
            <h3>First Time Setup</h3>
            <p>Set up your username and password to secure your inventory system.</p>
            <form class="login-form" id="setup-form">
                <input type="text" id="setup-username" placeholder="Choose Username" required>
                <input type="password" id="setup-password" placeholder="Choose Password" required>
                <input type="password" id="setup-confirm-password" placeholder="Confirm Password" required>
                <button type="submit" class="login-btn">Set Up Account</button>
            </form>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="main-app" class="container hidden">
        <button class="logout-btn" onclick="logout()">🚪 Logout</button>
        
        <div class="header">
            <h1>📦 Inventory Management System</h1>
            <p>Scan, Track, and Manage Your Inventory with Ease</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="nav-tab" onclick="showTab('add-item')">➕ Add Item</button>
            <button class="nav-tab" onclick="showTab('inventory')">📋 Inventory</button>
            <button class="nav-tab" onclick="showTab('scanner')">📱 Scanner</button>
            <button class="nav-tab" onclick="showTab('reports')">📄 Reports</button>
            <button class="nav-tab" onclick="showTab('settings')">⚙️ Settings</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="total-items">0</h3>
                    <p>Total Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="low-stock">0</h3>
                    <p>Low Stock Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-value">$0</h3>
                    <p>Total Value</p>
                </div>
                <div class="stat-card">
                    <h3 id="categories">0</h3>
                    <p>Categories</p>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="dashboard-search" placeholder="Search inventory..." onkeyup="searchInventory(this.value)">
            </div>

            <div id="recent-items">
                <h3>Recent Items</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Barcode</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody id="recent-items-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Item Tab -->
        <div id="add-item" class="tab-content">
            <h2>Add New Item</h2>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-name">Item Name *</label>
                    <input type="text" id="item-name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="item-barcode">Barcode</label>
                    <input type="text" id="item-barcode" class="form-control" placeholder="Scan or enter barcode">
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="item-category">Category</label>
                    <select id="item-category" class="form-control">
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Food">Food</option>
                        <option value="Tools">Tools</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="item-quantity">Quantity *</label>
                    <input type="number" id="item-quantity" class="form-control" min="0" required>
                </div>

                <div class="form-group">
                    <label for="item-price">Price ($)</label>
                    <input type="number" id="item-price" class="form-control" min="0" step="0.01">
                </div>

                <div class="form-group">
                    <label for="item-image">Item Image</label>
                    <input type="file" id="item-image" class="form-control" accept="image/*" onchange="previewImage(this)">
                    <img id="image-preview" class="image-preview" style="display: none;">
                </div>

                <div class="form-group">
                    <label for="item-location">Location</label>
                    <input type="text" id="item-location" class="form-control" placeholder="e.g., Warehouse A, Shelf 3">
                </div>

                <div class="form-group">
                    <label for="item-min-stock">Minimum Stock Level</label>
                    <input type="number" id="item-min-stock" class="form-control" min="0" value="5">
                </div>

                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>Inventory List</h2>
            <div class="search-box">
                <input type="text" id="inventory-search" placeholder="Search by name, barcode, or category..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Barcode</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-body">
                </tbody>
            </table>
        </div>

        <!-- Scanner Tab -->
        <div id="scanner" class="tab-content">
            <h2>Barcode Scanner</h2>
            <div class="scanner-container">
                <div class="scanner-frame">
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scanner-target"></div>
                        <div class="scanner-instructions">
                            <p>📱 Point camera at barcode</p>
                            <p>📷 Hold steady for best results</p>
                        </div>
                    </div>
                </div>
                <div class="camera-controls">
                    <button class="btn btn-primary" onclick="startScanner()">Start Scanner</button>
                    <button class="btn btn-danger" onclick="stopScanner()" disabled>Stop Scanner</button>
                </div>
                <div class="scanner-status">
                    <p id="scanner-status-text">Ready to scan</p>
                </div>
                <div id="scan-result" class="alert" style="display: none;"></div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Generate Reports</h2>
            <div class="report-options">
                <div class="checkbox-group">
                    <input type="checkbox" id="include-images" checked>
                    <label for="include-images">Include Images</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-barcodes" checked>
                    <label for="include-barcodes">Include Barcodes</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-prices" checked>
                    <label for="include-prices">Include Prices</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-locations" checked>
                    <label for="include-locations">Include Locations</label>
                </div>
            </div>

            <div class="form-group">
                <label for="report-type">Report Type</label>
                <select id="report-type" class="form-control">
                    <option value="all">All Items</option>
                    <option value="low-stock">Low Stock Items</option>
                    <option value="category">By Category</option>
                    <option value="value">High Value Items</option>
                </select>
            </div>

            <div class="form-group" id="category-filter" style="display: none;">
                <label for="report-category">Category</label>
                <select id="report-category" class="form-control">
                </select>
            </div>

            <button class="btn btn-primary" onclick="generateReport()">Generate PDF Report</button>
            <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>User Settings</h2>
            
            <div class="settings-section">
                <h3>👤 Account Information</h3>
                <div class="form-group">
                    <label for="current-username">Current Username</label>
                    <input type="text" id="current-username" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="user-email">Email Address</label>
                    <input type="email" id="user-email" class="form-control" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="user-fullname">Full Name</label>
                    <input type="text" id="user-fullname" class="form-control" placeholder="Enter your full name">
                </div>
            </div>

            <div class="settings-section">
                <h3>🔐 Change Password</h3>
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control" placeholder="Confirm new password">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>

            <div class="settings-section">
                <h3>🎨 Appearance</h3>
                <div class="form-group">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select" class="form-control" onchange="changeTheme(this.value)">
                        <option value="default">Default Theme</option>
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="language-select">Language</label>
                    <select id="theme-select" class="form-control">
                        <option value="en">English</option>
                        <option value="es">Español</option>
                        <option value="fr">Français</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>📊 System Preferences</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="auto-logout" checked>
                    <label for="auto-logout">Auto-logout after 24 hours</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="notifications" checked>
                    <label for="notifications">Show notifications</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="low-stock-alerts" checked>
                    <label for="low-stock-alerts">Low stock alerts</label>
                </div>
            </div>

            <div class="settings-section">
                <h3>💾 Data Management</h3>
                <button class="btn btn-success" onclick="exportUserData()">Export My Data</button>
                <button class="btn btn-warning" onclick="importUserData()">Import Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
            </div>

            <div class="settings-section">
                <h3>ℹ️ About</h3>
                <p><strong>Version:</strong> 1.0.0</p>
                <p><strong>Last Login:</strong> <span id="last-login">Never</span></p>
                <p><strong>Total Items:</strong> <span id="total-items-settings">0</span></p>
                <p><strong>Account Created:</strong> <span id="account-created">Unknown</span></p>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Item</h2>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <div class="form-group">
                    <label for="edit-item-name">Item Name</label>
                    <input type="text" id="edit-item-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-item-quantity">Quantity</label>
                    <input type="number" id="edit-item-quantity" class="form-control" min="0" required>
                </div>
                <div class="form-group">
                    <label for="edit-item-price">Price ($)</label>
                    <input type="number" id="edit-item-price" class="form-control" min="0" step="0.01">
                </div>
                <button type="submit" class="btn btn-primary">Update Item</button>
            </form>
        </div>
    </div>

    <script>
        // Authentication variables
        let isAuthenticated = false;
        let currentUser = null;
        let inventory = [];
        let scanner = null;
        let stream = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            setupAuthEventListeners();
        });

        function checkAuthentication() {
            const credentials = localStorage.getItem('inventory_credentials');
            const session = localStorage.getItem('inventory_session');
            
            if (credentials && session) {
                try {
                    const creds = JSON.parse(credentials);
                    const sessionData = JSON.parse(session);
                    
                    // Check if session is still valid (24 hours)
                    if (Date.now() - sessionData.timestamp < 24 * 60 * 60 * 1000) {
                        isAuthenticated = true;
                        currentUser = sessionData.username;
                        showMainApp();
                        loadInventory();
                        return;
                    }
                } catch (e) {
                    console.log('Session expired or invalid');
                }
            }
            
            // Check if credentials exist for first-time setup
            if (credentials) {
                document.getElementById('setup-credentials').style.display = 'none';
            } else {
                document.getElementById('setup-credentials').style.display = 'block';
            }
            
            showLoginScreen();
        }

        function setupAuthEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });

            // Setup form
            document.getElementById('setup-form').addEventListener('submit', function(e) {
                e.preventDefault();
                setupCredentials();
            });
        }

        function setupCredentials() {
            const username = document.getElementById('setup-username').value;
            const password = document.getElementById('setup-password').value;
            const confirmPassword = document.getElementById('setup-confirm-password').value;

            if (password !== confirmPassword) {
                showAlert('Passwords do not match!', 'error');
                return;
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long!', 'error');
                return;
            }

            // Hash the password (simple hash for demo - in production use bcrypt)
            const hashedPassword = btoa(password + 'salt123');
            
            const credentials = {
                username: username,
                password: hashedPassword
            };

            localStorage.setItem('inventory_credentials', JSON.stringify(credentials));
            
            // Auto-login after setup
            isAuthenticated = true;
            currentUser = username;
            showMainApp();
            showAlert('Account created successfully! Welcome to your inventory system.', 'success');
        }

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const hashedPassword = btoa(password + 'salt123');

            const storedCredentials = localStorage.getItem('inventory_credentials');
            
            if (!storedCredentials) {
                showLoginError('No account found. Please set up your credentials first.');
                return;
            }

            try {
                const credentials = JSON.parse(storedCredentials);
                
                if (credentials.username === username && credentials.password === hashedPassword) {
                    isAuthenticated = true;
                    currentUser = username;
                    
                    // Create session
                    const session = {
                        username: username,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('inventory_session', JSON.stringify(session));
                    
                    showMainApp();
                    loadInventory();
                    showAlert('Login successful!', 'success');
                } else {
                    showLoginError('Invalid username or password!');
                }
            } catch (e) {
                showLoginError('Error during login. Please try again.');
            }
        }

        function logout() {
            isAuthenticated = false;
            currentUser = null;
            localStorage.removeItem('inventory_session');
            showLoginScreen();
            showAlert('Logged out successfully!', 'success');
        }

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            setupEventListeners();
            updateDashboard();
            loadInventoryTable();
            loadUserSettings();
        }

        function loadInventory() {
            const storedInventory = localStorage.getItem('inventory');
            if (storedInventory) {
                try {
                    inventory = JSON.parse(storedInventory);
                } catch (e) {
                    inventory = [];
                }
            }
        }

        function setupEventListeners() {
            // Add item form
            document.getElementById('add-item-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addItem();
            });

            // Edit item form
            document.getElementById('edit-item-form').addEventListener('submit', function(e) {
                e.preventDefault();
                updateItem();
            });

            // Report type change
            document.getElementById('report-type').addEventListener('change', function() {
                const categoryFilter = document.getElementById('category-filter');
                if (this.value === 'category') {
                    categoryFilter.style.display = 'block';
                    loadCategories();
                } else {
                    categoryFilter.style.display = 'none';
                }
            });

            // Settings auto-save
            document.getElementById('user-email').addEventListener('blur', saveUserProfile);
            document.getElementById('user-fullname').addEventListener('blur', saveUserProfile);
            document.getElementById('auto-logout').addEventListener('change', savePreferences);
            document.getElementById('notifications').addEventListener('change', savePreferences);
            document.getElementById('low-stock-alerts').addEventListener('change', savePreferences);
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Update dashboard if showing dashboard tab
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        function addItem() {
            const name = document.getElementById('item-name').value;
            const barcode = document.getElementById('item-barcode').value;
            const description = document.getElementById('item-description').value;
            const category = document.getElementById('item-category').value;
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            const location = document.getElementById('item-location').value;
            const minStock = parseInt(document.getElementById('item-min-stock').value) || 5;

            // Get image data
            const imageFile = document.getElementById('item-image').files[0];
            let imageData = null;
            if (imageFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageData = e.target.result;
                    saveItem(name, barcode, description, category, quantity, price, location, minStock, imageData);
                };
                reader.readAsDataURL(imageFile);
            } else {
                saveItem(name, barcode, description, category, quantity, price, location, minStock, null);
            }
        }

        function saveItem(name, barcode, description, category, quantity, price, location, minStock, imageData) {
            const item = {
                id: Date.now(),
                name: name,
                barcode: barcode,
                description: description,
                category: category,
                quantity: quantity,
                price: price,
                location: location,
                minStock: minStock,
                image: imageData,
                dateAdded: new Date().toISOString()
            };

            inventory.push(item);
            localStorage.setItem('inventory', JSON.stringify(inventory));

            // Reset form
            document.getElementById('add-item-form').reset();
            document.getElementById('image-preview').style.display = 'none';

            // Show success message
            showAlert('Item added successfully!', 'success');

            // Update displays
            updateDashboard();
            loadInventoryTable();
        }

        function loadInventoryTable() {
            const tbody = document.getElementById('inventory-body');
            const recentTbody = document.getElementById('recent-items-body');
            
            tbody.innerHTML = '';
            recentTbody.innerHTML = '';

            inventory.forEach(item => {
                const row = createInventoryRow(item);
                tbody.appendChild(row);

                // Add to recent items (last 5)
                if (recentTbody.children.length < 5) {
                    const recentRow = createInventoryRow(item);
                    recentTbody.appendChild(recentRow);
                }
            });
        }

        function createInventoryRow(item) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    ${item.image ? `<img src="${item.image}" class="item-image" alt="${item.name}">` : '📦'}
                </td>
                <td>${item.name}</td>
                <td><span class="barcode">${item.barcode || 'N/A'}</span></td>
                <td>
                    <span style="color: ${item.quantity <= item.minStock ? '#dc3545' : '#28a745'}">
                        ${item.quantity}
                    </span>
                </td>
                <td>$${item.price.toFixed(2)}</td>
                <td>${item.category || 'Uncategorized'}</td>
                <td>${item.location || 'N/A'}</td>
                <td>
                    <button class="btn btn-warning" onclick="editItem(${item.id})" style="padding: 5px 10px; margin: 2px;">✏️</button>
                    <button class="btn btn-danger" onclick="deleteItem(${item.id})" style="padding: 5px 10px; margin: 2px;">🗑️</button>
                </td>
            `;
            return row;
        }

        function updateDashboard() {
            const totalItems = inventory.length;
            const lowStock = inventory.filter(item => item.quantity <= item.minStock).length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const categories = new Set(inventory.map(item => item.category).filter(cat => cat)).size;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('low-stock').textContent = lowStock;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('categories').textContent = categories;
        }

        function searchInventory(query) {
            const rows = document.querySelectorAll('#inventory-body tr, #recent-items-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function editItem(id) {
            const item = inventory.find(item => item.id === id);
            if (!item) return;

            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-quantity').value = item.quantity;
            document.getElementById('edit-item-price').value = item.price;

            document.getElementById('edit-modal').style.display = 'block';
        }

        function updateItem() {
            const id = parseInt(document.getElementById('edit-item-id').value);
            const name = document.getElementById('edit-item-name').value;
            const quantity = parseInt(document.getElementById('edit-item-quantity').value);
            const price = parseFloat(document.getElementById('edit-item-price').value) || 0;

            const itemIndex = inventory.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                inventory[itemIndex].name = name;
                inventory[itemIndex].quantity = quantity;
                inventory[itemIndex].price = price;

                localStorage.setItem('inventory', JSON.stringify(inventory));
                closeEditModal();
                updateDashboard();
                loadInventoryTable();
                showAlert('Item updated successfully!', 'success');
            }
        }

        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                inventory = inventory.filter(item => item.id !== id);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                updateDashboard();
                loadInventoryTable();
                showAlert('Item deleted successfully!', 'success');
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Barcode Scanner Functions
        let isScanning = false;
        let lastScannedCode = '';
        let scanTimeout = null;

        async function startScanner() {
            if (isScanning) {
                showAlert('Scanner is already running!', 'error');
                return;
            }

            try {
                // Stop any existing scanner
                stopScanner();
                
                // Reset scanning state
                isScanning = true;
                lastScannedCode = '';
                
                // Request camera access with iPhone-optimized settings
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920, max: 1920 },
                        height: { ideal: 1080, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    } 
                });
                
                const video = document.getElementById('scanner-video');
                video.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                // Initialize ZXing scanner with better settings
                const codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Configure scanner for better iPhone performance
                codeReader.hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                codeReader.hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                
                codeReader.decodeFromVideoDevice(null, 'scanner-video', (result, err) => {
                    if (result && isScanning) {
                        const scannedCode = result.text.trim();
                        
                        // Prevent duplicate scans of the same code
                        if (scannedCode === lastScannedCode) {
                            return;
                        }
                        
                        // Clear any existing timeout
                        if (scanTimeout) {
                            clearTimeout(scanTimeout);
                        }
                        
                        // Set the scanned code
                        lastScannedCode = scannedCode;
                        document.getElementById('item-barcode').value = scannedCode;
                        
                        // Show success message
                        showAlert(`Barcode scanned: ${scannedCode}`, 'success');
                        
                        // Stop scanner after a short delay to prevent immediate re-scanning
                        scanTimeout = setTimeout(() => {
                            stopScanner();
                        }, 1000);
                    }
                });

                scanner = codeReader;
                
                // Update UI
                document.querySelector('button[onclick="startScanner()"]').textContent = 'Scanning...';
                document.querySelector('button[onclick="stopScanner()"]').disabled = false;
                document.getElementById('scanner-status-text').textContent = 'Camera active - scanning for barcodes...';
                
            } catch (error) {
                isScanning = false;
                console.error('Scanner error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showAlert('Camera access denied. Please allow camera permissions and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showAlert('No camera found. Please check your device has a camera.', 'error');
                } else {
                    showAlert('Error accessing camera: ' + error.message, 'error');
                }
            }
        }

        function stopScanner() {
            isScanning = false;
            
            // Clear any pending timeout
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // Reset scanner
            if (scanner) {
                try {
                    scanner.reset();
                } catch (e) {
                    console.log('Scanner reset error:', e);
                }
                scanner = null;
            }
            
            // Stop video stream
            if (stream) {
                try {
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                } catch (e) {
                    console.log('Stream stop error:', e);
                }
                stream = null;
            }
            
            // Clear video element
            const video = document.getElementById('scanner-video');
            if (video) {
                video.srcObject = null;
            }
            
            // Reset UI
            document.querySelector('button[onclick="startScanner()"]').textContent = 'Start Scanner';
            document.querySelector('button[onclick="stopScanner()"]').disabled = true;
            document.getElementById('scanner-status-text').textContent = 'Ready to scan';
            
            // Clear last scanned code after a delay
            setTimeout(() => {
                lastScannedCode = '';
            }, 2000);
        }

        // Report Generation Functions
        function generateReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const includeImages = document.getElementById('include-images').checked;
            const includeBarcodes = document.getElementById('include-barcodes').checked;
            const includePrices = document.getElementById('include-prices').checked;
            const includeLocations = document.getElementById('include-locations').checked;
            const reportType = document.getElementById('report-type').value;

            let filteredInventory = [...inventory];

            // Filter based on report type
            switch (reportType) {
                case 'low-stock':
                    filteredInventory = inventory.filter(item => item.quantity <= item.minStock);
                    break;
                case 'category':
                    const category = document.getElementById('report-category').value;
                    if (category) {
                        filteredInventory = inventory.filter(item => item.category === category);
                    }
                    break;
                case 'value':
                    filteredInventory = inventory.filter(item => item.price > 100);
                    break;
            }

            // Add title
            doc.setFontSize(20);
            doc.text('Inventory Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            doc.text(`Total Items: ${filteredInventory.length}`, 105, 40, { align: 'center' });

            // Prepare table data
            const tableData = filteredInventory.map(item => {
                const row = [
                    item.name,
                    item.quantity.toString(),
                    item.category || 'N/A'
                ];

                if (includePrices) {
                    row.push(`$${item.price.toFixed(2)}`);
                }
                if (includeLocations) {
                    row.push(item.location || 'N/A');
                }
                if (includeBarcodes) {
                    row.push(item.barcode || 'N/A');
                }

                return row;
            });

            // Define headers
            const headers = ['Name', 'Quantity', 'Category'];
            if (includePrices) headers.push('Price');
            if (includeLocations) headers.push('Location');
            if (includeBarcodes) headers.push('Barcode');

            // Add table
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 50,
                styles: {
                    fontSize: 10,
                    cellPadding: 5
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: 255
                }
            });

            // Add images if requested
            if (includeImages) {
                let yPosition = doc.lastAutoTable.finalY + 20;
                filteredInventory.forEach((item, index) => {
                    if (item.image && yPosition < 250) {
                        try {
                            doc.addImage(item.image, 'JPEG', 20, yPosition, 30, 30);
                            yPosition += 40;
                        } catch (e) {
                            console.log('Error adding image:', e);
                        }
                    }
                });
            }

            // Save the PDF
            doc.save(`inventory-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showAlert('PDF report generated successfully!', 'success');
        }

        function exportToCSV() {
            const headers = ['Name', 'Barcode', 'Description', 'Category', 'Quantity', 'Price', 'Location', 'Date Added'];
            const csvContent = [
                headers.join(','),
                ...inventory.map(item => [
                    `"${item.name}"`,
                    `"${item.barcode || ''}"`,
                    `"${item.description || ''}"`,
                    `"${item.category || ''}"`,
                    item.quantity,
                    item.price,
                    `"${item.location || ''}"`,
                    `"${item.dateAdded}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('CSV file exported successfully!', 'success');
        }

        function loadCategories() {
            const categories = [...new Set(inventory.map(item => item.category).filter(cat => cat))];
            const select = document.getElementById('report-category');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container') || document.querySelector('.login-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showLoginError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.textContent = message;
            errorDiv.style.marginTop = '10px';
            
            const loginForm = document.getElementById('login-form');
            loginForm.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Settings Functions
        function loadUserSettings() {
            const userProfile = JSON.parse(localStorage.getItem('user_profile')) || {};
            const credentials = JSON.parse(localStorage.getItem('inventory_credentials')) || {};
            
            // Load account information
            document.getElementById('current-username').value = currentUser || '';
            document.getElementById('user-email').value = userProfile.email || '';
            document.getElementById('user-fullname').value = userProfile.fullname || '';
            
            // Load preferences
            const preferences = JSON.parse(localStorage.getItem('user_preferences')) || {};
            document.getElementById('auto-logout').checked = preferences.autoLogout !== false;
            document.getElementById('notifications').checked = preferences.notifications !== false;
            document.getElementById('low-stock-alerts').checked = preferences.lowStockAlerts !== false;
            
            // Load theme
            const currentTheme = localStorage.getItem('theme') || 'default';
            document.getElementById('theme-select').value = currentTheme;
            
            // Update about section
            document.getElementById('total-items-settings').textContent = inventory.length;
            document.getElementById('last-login').textContent = new Date().toLocaleString();
            document.getElementById('account-created').textContent = userProfile.created || 'Unknown';
        }

        function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Please fill in all password fields!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('New password must be at least 6 characters long!', 'error');
                return;
            }
            
            // Verify current password
            const storedCredentials = JSON.parse(localStorage.getItem('inventory_credentials'));
            const currentHashedPassword = btoa(currentPassword + 'salt123');
            
            if (storedCredentials.password !== currentHashedPassword) {
                showAlert('Current password is incorrect!', 'error');
                return;
            }
            
            // Update password
            const newHashedPassword = btoa(newPassword + 'salt123');
            storedCredentials.password = newHashedPassword;
            localStorage.setItem('inventory_credentials', JSON.stringify(storedCredentials));
            
            // Clear form
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            showAlert('Password changed successfully!', 'success');
        }

        function changeTheme(theme) {
            localStorage.setItem('theme', theme);
            
            // Remove existing theme classes
            document.body.classList.remove('theme-dark', 'theme-light');
            
            // Apply new theme
            if (theme === 'dark') {
                document.body.classList.add('theme-dark');
            } else if (theme === 'light') {
                document.body.classList.add('theme-light');
            }
            
            showAlert('Theme changed successfully!', 'success');
        }

        function exportUserData() {
            const userData = {
                inventory: inventory,
                userProfile: JSON.parse(localStorage.getItem('user_profile')) || {},
                preferences: JSON.parse(localStorage.getItem('user_preferences')) || {},
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('Data exported successfully!', 'success');
        }

        function importUserData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const userData = JSON.parse(e.target.result);
                        
                        if (userData.inventory) {
                            inventory = userData.inventory;
                            localStorage.setItem('inventory', JSON.stringify(inventory));
                        }
                        
                        if (userData.userProfile) {
                            localStorage.setItem('user_profile', JSON.stringify(userData.userProfile));
                        }
                        
                        if (userData.preferences) {
                            localStorage.setItem('user_preferences', JSON.stringify(userData.preferences));
                        }
                        
                        updateDashboard();
                        loadInventoryTable();
                        loadUserSettings();
                        showAlert('Data imported successfully!', 'success');
                    } catch (error) {
                        showAlert('Error importing data. Please check the file format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone!')) {
                localStorage.clear();
                inventory = [];
                showAlert('All data cleared successfully!', 'success');
                logout();
            }
        }

        // Save user profile when fields change
        function saveUserProfile() {
            const userProfile = {
                email: document.getElementById('user-email').value,
                fullname: document.getElementById('user-fullname').value,
                created: document.getElementById('account-created').textContent === 'Unknown' ? 
                    new Date().toLocaleDateString() : document.getElementById('account-created').textContent
            };
            
            localStorage.setItem('user_profile', JSON.stringify(userProfile));
        }

        // Save preferences when checkboxes change
        function savePreferences() {
            const preferences = {
                autoLogout: document.getElementById('auto-logout').checked,
                notifications: document.getElementById('notifications').checked,
                lowStockAlerts: document.getElementById('low-stock-alerts').checked
            };
            
            localStorage.setItem('user_preferences', JSON.stringify(preferences));
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html> 