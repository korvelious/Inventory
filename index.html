<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Management System</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
      import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBVi2H979UqIc0D6t58Z_GwB8ax94UMkak",
        authDomain: "farhop-inventory.firebaseapp.com",
        projectId: "farhop-inventory",
        storageBucket: "farhop-inventory.firebasestorage.app",
        messagingSenderId: "1032603057511",
        appId: "1:1032603057511:web:d3fc28572e40889a8c03c2"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const functions = getFunctions(app);

      // Make Firebase available globally
      window.firebase = {
        auth,
        db,
        functions,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        sendPasswordResetEmail,
        EmailAuthProvider,
        reauthenticateWithCredential,
        updatePassword,
        collection,
        addDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        doc,
        query,
        where,
        onSnapshot
      };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }

        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-link {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 5px;
        }

        .btn-link:hover {
            color: #764ba2;
        }

        .security-questions {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .security-questions h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .setup-credentials {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .setup-credentials h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .setup-credentials p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }

        .scanner-frame {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        #scanner-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: #000;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scanner-target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 3px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .scanner-instructions {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 0 0 15px 15px;
        }

        .scanner-instructions p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .scanner-status {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .scanner-status p {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
        }

        .camera-controls {
            margin: 20px 0;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .inventory-table th,
        .inventory-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
        }

        .inventory-table tr:hover {
            background: #f8f9fa;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .barcode {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid #e9ecef;
            margin: 10px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (max-width: 600px) {
          .modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            padding: 0 !important;
            overflow-y: auto !important;
          }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .settings-section p {
            margin: 10px 0;
            color: #6c757d;
        }

        .settings-section .btn {
            margin: 5px;
        }

        .barcode-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .barcode-input-group .form-control {
            flex: 1;
        }

        .barcode-scan-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .barcode-scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .barcode-scan-btn.scanning {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: pulse 1s infinite;
        }

        .scanner-modal-content {
            max-width: 500px;
            text-align: center;
        }

        .scanner-modal-content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .inventory-table {
                font-size: 0.9em;
            }

            .inventory-table th,
            .inventory-table td {
                padding: 10px 8px;
            }
        }

        @media (max-width: 600px) {
          .scanner-modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            padding: 0 !important;
          }
        }

        .image-gallery { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .image-gallery img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #e9ecef; }
        .tag-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
        .tag-chip { background: #667eea; color: #fff; border-radius: 12px; padding: 2px 10px; font-size: 0.9em; }
        .delete-image-btn {
            font-size: 1em;
            line-height: 1;
            padding: 0;
            margin: 0;
            z-index: 2;
        }
        .stat-card h3, .stat-card .total-value {
          word-break: break-all;
          overflow-wrap: break-word;
          max-width: 100%;
          font-size: 2.2em;
          white-space: normal;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h1>üîê Inventory System</h1>
        <form class="login-form" id="login-form">
            <input type="email" id="login-email" placeholder="Email Address" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="login-btn">Login</button>
            <button type="button" class="btn-link" onclick="showForgotPassword()">Forgot Password?</button>
        </form>
        
        <div class="setup-credentials" id="setup-credentials">
            <h3>First Time Setup</h3>
            <p>Set up your username and password to secure your inventory system.</p>
            <form class="login-form" id="setup-form">
                <input type="text" id="setup-username" placeholder="Choose Username" required>
                <input type="email" id="setup-email" placeholder="Your Email Address" required>
                <input type="password" id="setup-password" placeholder="Choose Password" required>
                <input type="password" id="setup-confirm-password" placeholder="Confirm Password" required>
                    
                <button type="submit" class="login-btn">Set Up Account</button>
            </form>
        </div>
    </div>

        <!-- Forgot Password Modal -->
        <div id="forgot-password-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeForgotPassword()">&times;</span>
                <h2>üîë Password Recovery</h2>
                
                <!-- Step 1: Enter Username -->
                <div id="forgot-step-1">
                    <p>Enter your username to recover your password.</p>
                    <div class="form-group">
                        <input type="text" id="recovery-username" class="form-control" placeholder="Enter your username">
                    </div>
                    <button class="btn btn-primary" onclick="sendPasswordReset()">Send Password Reset Email</button>
                </div>
                
                <!-- Step 2: Set New Password -->
                <div id="forgot-step-3" style="display: none;">
                    <p>Set your new password.</p>
                    <div class="form-group">
                        <input type="password" id="new-password-recovery" class="form-control" placeholder="New Password">
                    </div>
                    <div class="form-group">
                        <input type="password" id="confirm-new-password-recovery" class="form-control" placeholder="Confirm New Password">
                    </div>
                    <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
                </div>
            </div>
        </div>

    <!-- Main Application (Hidden until login) -->
    <div id="main-app" class="container hidden">
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        
        <div class="header">
            <h1>üì¶ Inventory Management System</h1>
            <p>Scan, Track, and Manage Your Inventory with Ease</p>
        </div>

        <div class="nav-tabs" id="main-nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('add-item')">‚ûï Add Item</button>
            <button class="nav-tab" onclick="showTab('inventory')">üìã Inventory</button>
            <button class="nav-tab" onclick="showTab('reports')">üìÑ Reports</button>
            <button class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            <!-- Admin tab will be injected by JS if user is admin -->
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="total-items">0</h3>
                    <p>Total Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="low-stock">0</h3>
                    <p>Low Stock Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-value">$0</h3>
                    <p>Total Value</p>
                </div>
                <div class="stat-card">
                    <h3 id="categories">0</h3>
                    <p>Categories</p>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="dashboard-search" placeholder="Search inventory..." onkeyup="searchInventory(this.value)">
            </div>

            <div id="recent-items">
                <h3>Recent Items</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Barcode</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recent-items-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Add Item Tab -->
        <div id="add-item" class="tab-content">
            <h2>Add New Item</h2>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-name">Item Name *</label>
                    <input type="text" id="item-name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="item-barcode">Barcode</label>
                    <div class="barcode-input-group">
                    <input type="text" id="item-barcode" class="form-control" placeholder="Scan or enter barcode">
                        <button type="button" class="barcode-scan-btn" onclick="activateScanner()" title="Scan Barcode">
                            üì∑
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="item-category">Category</label>
                    <select id="item-category" class="form-control">
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Food">Food</option>
                        <option value="Tools">Tools</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="item-quantity">Quantity *</label>
                    <input type="number" id="item-quantity" class="form-control" min="0" required inputmode="numeric">
                </div>

                <div class="form-group">
                    <label for="item-price">Price ($)</label>
                    <input type="number" id="item-price" class="form-control" min="0" step="0.01" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label for="item-images">Item Images</label>
                    <input type="file" id="item-images" class="form-control" accept="image/*" multiple onchange="previewImages(this, 'add')">
                    <div id="add-image-gallery" class="image-gallery"></div>
                </div>

                <div class="form-group">
                    <label for="item-location">Location</label>
                    <input type="text" id="item-location" class="form-control" placeholder="e.g., Warehouse A, Shelf 3">
                </div>

                <div class="form-group">
                    <label for="item-min-stock">Minimum Stock Level</label>
                    <input type="number" id="item-min-stock" class="form-control" min="0" value="5">
                </div>

                <div class="form-group">
                    <label for="item-tags">Tags</label>
                    <input type="text" id="item-tags" class="form-control" placeholder="Comma-separated tags (e.g. urgent, fragile)">
                    <div id="add-tag-chips" class="tag-chips"></div>
                </div>

                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>Inventory List</h2>
            <div class="search-box">
                <input type="text" id="inventory-search" placeholder="Search by name, barcode, or category..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Barcode</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-body">
                </tbody>
            </table>
        </div>



        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Generate Reports</h2>
            <div class="report-options">
                <div class="checkbox-group">
                    <input type="checkbox" id="include-images" checked>
                    <label for="include-images">Include Images</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-barcodes" checked>
                    <label for="include-barcodes">Include Barcodes</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-prices" checked>
                    <label for="include-prices">Include Prices</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-locations" checked>
                    <label for="include-locations">Include Locations</label>
                </div>
            </div>

            <div class="form-group">
                <label for="report-type">Report Type</label>
                <select id="report-type" class="form-control">
                    <option value="all">All Items</option>
                    <option value="low-stock">Low Stock Items</option>
                    <option value="category">By Category</option>
                    <option value="value">High Value Items</option>
                </select>
            </div>

            <div class="form-group" id="category-filter" style="display: none;">
                <label for="report-category">Category</label>
                <select id="report-category" class="form-control">
                </select>
            </div>

            <button class="btn btn-primary" onclick="generateReport()">Generate PDF Report</button>
            <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>User Settings</h2>
            
            <div class="settings-section">
                <h3>üë§ Account Information</h3>
                <div class="form-group">
                    <label for="current-username">Current Username</label>
                    <input type="text" id="current-username" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="user-email">Email Address</label>
                    <input type="email" id="user-email" class="form-control" placeholder="Enter your email" inputmode="email">
                </div>
                <div class="form-group">
                    <label for="user-fullname">Full Name</label>
                    <input type="text" id="user-fullname" class="form-control" placeholder="Enter your full name">
                </div>
            </div>

            <div class="settings-section">
                <h3>üîê Change Password</h3>
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control" placeholder="Confirm new password">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>

            <div class="settings-section">
                <h3>üé® Appearance</h3>
                <div class="form-group">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select" class="form-control" onchange="changeTheme(this.value)">
                        <option value="default">Default Theme</option>
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="language-select">Language</label>
                    <select id="theme-select" class="form-control">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>üìä System Preferences</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="auto-logout" checked>
                    <label for="auto-logout">Auto-logout after 24 hours</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="notifications" checked>
                    <label for="notifications">Show notifications</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="low-stock-alerts" checked>
                    <label for="low-stock-alerts">Low stock alerts</label>
                </div>
            </div>

            <div class="settings-section">
                <h3>üíæ Data Management</h3>
                <button class="btn btn-success" onclick="exportUserData()">Export Complete Data</button>
                <button class="btn btn-warning" onclick="importUserData()">Import Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
            </div>

            <div class="settings-section">
                <h3>üì± Multi-Device Setup</h3>
                <p><strong>To use on another device:</strong></p>
                <ol style="text-align: left; margin: 10px 0;">
                    <li>Export complete data from this device</li>
                    <li>Open inventory system on new device</li>
                    <li>Import the backup file</li>
                    <li>Login with your existing credentials</li>
                </ol>
                <button class="btn btn-primary" onclick="exportUserData()">Create Device Backup</button>
            </div>

            <div class="settings-section">
                <h3>‚ÑπÔ∏è About</h3>
                <p><strong>Version:</strong> 1.0.0</p>
                <p><strong>Last Login:</strong> <span id="last-login">Never</span></p>
                <p><strong>Total Items:</strong> <span id="total-items-settings">0</span></p>
                <p><strong>Account Created:</strong> <span id="account-created">Unknown</span></p>
            </div>

            <!-- In the Settings Tab, add a Manage Categories section -->
            <div class="settings-section">
                <h3>üìÇ Manage Categories</h3>
                <ul id="category-list"></ul>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <input type="text" id="new-category-input" class="form-control" placeholder="Add new category">
                    <button class="btn btn-success" onclick="addCategory()">Add</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>üé® Branding</h3>
                <div class="form-group">
                    <label for="branding-logo">Logo</label>
                    <input type="file" id="branding-logo" class="form-control" accept="image/*" onchange="previewBrandingLogo(this)">
                    <img id="branding-logo-preview" style="max-width:120px;display:none;">
                </div>
                <div class="form-group">
                    <label for="branding-color">Theme Color</label>
                    <input type="color" id="branding-color" class="form-control" value="#667eea" onchange="applyThemeColor(this.value)">
                </div>
                <button class="btn btn-primary" onclick="saveBranding()">Save Branding</button>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scanner-modal" class="modal">
        <div class="modal-content scanner-modal-content">
            <span class="close" onclick="closeScannerModal()">&times;</span>
            <h2>üì∑ Scan Barcode</h2>
            <div class="scanner-container">
                <div class="scanner-frame">
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scanner-target"></div>
                        <div class="scanner-instructions">
                            <p>üì± Point camera at barcode or QR code</p>
                            <p>üì∑ Hold steady for best results</p>
                        </div>
                    </div>
                </div>
                <div class="scanner-status">
                    <p id="scanner-status-text">Ready to scan</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Item</h2>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <div class="form-group">
                    <label for="edit-item-name">Item Name</label>
                    <input type="text" id="edit-item-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-item-barcode">Barcode</label>
                    <input type="text" id="edit-item-barcode" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-item-description">Description</label>
                    <textarea id="edit-item-description" class="form-control"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-item-category">Category</label>
                    <select id="edit-item-category" class="form-control">
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Food">Food</option>
                        <option value="Tools">Tools</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-item-quantity">Quantity</label>
                    <input type="number" id="edit-item-quantity" class="form-control" min="0" required inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="edit-item-price">Price ($)</label>
                    <input type="number" id="edit-item-price" class="form-control" min="0" step="0.01" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="edit-item-images">Item Images</label>
                    <input type="file" id="edit-item-images" class="form-control" accept="image/*" multiple onchange="previewImages(this, 'edit')">
                    <div id="edit-image-gallery" class="image-gallery"></div>
                </div>
                <div class="form-group">
                    <label for="edit-item-location">Location</label>
                    <input type="text" id="edit-item-location" class="form-control" placeholder="e.g., Warehouse A, Shelf 3">
                </div>
                <div class="form-group">
                    <label for="edit-item-min-stock">Minimum Stock Level</label>
                    <input type="number" id="edit-item-min-stock" class="form-control" min="0" value="5" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="edit-item-tags">Tags</label>
                    <input type="text" id="edit-item-tags" class="form-control" placeholder="Comma-separated tags (e.g. urgent, fragile)">
                    <div id="edit-tag-chips" class="tag-chips"></div>
                </div>
                <button type="submit" class="btn btn-primary">Update Item</button>
            </form>
        </div>
    </div>

    <!-- Add Admin Dashboard -->
    <div id="admin-dashboard" class="container hidden">
      <button class="logout-btn" onclick="logoutAdmin()">üö™ Logout</button>
      <div class="header">
        <h1>üë§ Admin User Management</h1>
        <p>View all signed up users</p>
      </div>
      <table class="inventory-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Created</th>
            <th>Last IP</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="admin-users-body"></tbody>
      </table>
    </div>
    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeUserDetails()">&times;</span>
        <h2>User Details</h2>
        <div id="user-details-content"></div>
        </div>
    </div>

    <script>
        // Authentication variables
        let isAuthenticated = false;
        let currentUser = null;
        let inventory = [];
        let scanner = null;
        let stream = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set up Firebase Auth state listener
            window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                if (user) {
                    // User is signed in
                    const email = user.email;
                    
                    // Get user profile from Firestore
                    const usersRef = window.firebase.collection(window.firebase.db, 'users');
                    const q = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
                    const querySnapshot = await window.firebase.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();
                        
                        isAuthenticated = true;
                        currentUser = userData.username;
                        await showMainApp();
                    }
            } else {
                    // User is signed out
                    checkAuthentication();
                }
            });
            
            setupAuthEventListeners();
        });

        function checkAuthentication() {
            // Firebase Auth state listener will handle authentication
            // This function now just sets up the initial UI state
            showLoginScreen();
        }

        function setupAuthEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });

            // Setup form
            document.getElementById('setup-form').addEventListener('submit', function(e) {
                e.preventDefault();
                setupCredentials();
            });
        }

        async function setupCredentials() {
            const username = document.getElementById('setup-username').value;
            const email = document.getElementById('setup-email').value.trim().toLowerCase();
            const password = document.getElementById('setup-password').value;
            const confirmPassword = document.getElementById('setup-confirm-password').value;
            if (password !== confirmPassword) {
                showAlert('Passwords do not match!', 'error');
                return;
            }
            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long!', 'error');
                return;
            }
            if (!email || !email.includes('@')) {
                showAlert('Please enter a valid email address!', 'error');
                return;
            }
            try {
                // Create Firebase user account with real email
                const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                const user = userCredential.user;
                // Get IP
                const ip = await getPublicIP();
                // Store user profile in Firestore
                const userProfile = {
                    username: username,
                    email: email,
                    created: new Date().toISOString(),
                    lastIP: ip
                };
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'users'), userProfile);
                sendSignupEmail(username, password);
                isAuthenticated = true;
                currentUser = username;
                await showMainApp();
                showAlert('Account created successfully! Welcome to your inventory system.', 'success');
            } catch (error) {
                console.error('Error creating account:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Email already exists. Please use a different email.', 'error');
                } else {
                    showAlert('Error creating account: ' + error.message, 'error');
                }
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                const user = userCredential.user;
                // Get user profile from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
                const querySnapshot = await window.firebase.getDocs(q);
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    isAuthenticated = true;
                    currentUser = userData.username;
                    // Save IP
                    const ip = await getPublicIP();
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), { lastIP: ip });
                    // Create session
                    const session = {
                        username: userData.username,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('inventory_session', JSON.stringify(session));
                    await showMainApp();
                    showAlert('Login successful!', 'success');
                } else {
                    showLoginError('User profile not found!');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found') {
                    showLoginError('Account not found. Please set up your account first.');
                } else if (error.code === 'auth/wrong-password') {
                    showLoginError('Invalid email or password!');
                } else {
                    showLoginError('Login error: ' + error.message);
                }
            }
        }

        async function logout() {
            try {
                await window.firebase.signOut(window.firebase.auth);
            isAuthenticated = false;
            currentUser = null;
            localStorage.removeItem('inventory_session');
            showLoginScreen();
            showAlert('Logged out successfully!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('Error during logout: ' + error.message, 'error');
            }
        }

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        async function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            setupEventListeners();
            await loadInventory();
            updateDashboard();
            loadInventoryTable();
            await loadUserSettings();
            await loadCategoriesFromFirestore();
            updateAdminTab();
        }

        async function loadInventory() {
            try {
                const inventoryRef = window.firebase.collection(window.firebase.db, 'inventory');
                const q = window.firebase.query(inventoryRef, window.firebase.where('userId', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                inventory = [];
                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    item.id = doc.id; // Add document ID
                    inventory.push(item);
                });
                
                // Sort by date added (newest first)
                inventory.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            } catch (error) {
                console.error('Error loading inventory:', error);
                showAlert('Error loading inventory: ' + error.message, 'error');
                    inventory = [];
            }
        }

        // Prevent duplicate event listeners
        let eventListenersSetup = false;
        function setupEventListeners() {
          if (eventListenersSetup) return;
          eventListenersSetup = true;
          // Add item form
          document.getElementById('add-item-form').addEventListener('submit', function(e) {
            e.preventDefault();
            addItem();
          });
          // Edit item form
          document.getElementById('edit-item-form').addEventListener('submit', function(e) {
            e.preventDefault();
            updateItem();
          });
          // Report type change
          document.getElementById('report-type').addEventListener('change', function() {
            const categoryFilter = document.getElementById('category-filter');
            if (this.value === 'category') {
              categoryFilter.style.display = 'block';
              loadCategories();
            } else {
              categoryFilter.style.display = 'none';
            }
          });
          // Settings auto-save
          document.getElementById('user-email').addEventListener('blur', saveUserProfile);
          document.getElementById('user-fullname').addEventListener('blur', saveUserProfile);
          document.getElementById('auto-logout').addEventListener('change', savePreferences);
          document.getElementById('notifications').addEventListener('change', savePreferences);
          document.getElementById('low-stock-alerts').addEventListener('change', savePreferences);
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Update dashboard if showing dashboard tab
            if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        // Utility: Resize and compress image to fit under 1MB
        async function resizeAndCompressImage(file, maxSize = 1048487, maxDim = 800) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxDim || height > maxDim) {
                            if (width > height) {
                                height = Math.round(height * (maxDim / width));
                                width = maxDim;
                            } else {
                                width = Math.round(width * (maxDim / height));
                                height = maxDim;
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Try compressing to JPEG, then PNG if needed
                        let quality = 0.8;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        while (dataUrl.length > maxSize * 1.37 && quality > 0.3) { // base64 is ~1.37x larger
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        if (dataUrl.length > maxSize * 1.37) {
                            // Try PNG as fallback
                            dataUrl = canvas.toDataURL('image/png');
                        }
                        if (dataUrl.length > maxSize * 1.37) {
                            reject('Image is too large even after resizing/compression. Please choose a smaller image.');
                        } else {
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = function() { reject('Invalid image file.'); };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function addItem() {
            const name = document.getElementById('item-name').value;
            const barcode = document.getElementById('item-barcode').value;
            const description = document.getElementById('item-description').value;
            const category = document.getElementById('item-category').value;
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            const location = document.getElementById('item-location').value;
            const minStock = parseInt(document.getElementById('item-min-stock').value) || 5;

            // Get image data
            const imageFiles = window.addImageFiles || document.getElementById('item-images').files;
            let imageData = [];
            const MAX_IMAGES = 3;
            const MAX_TOTAL_SIZE = 1048487; // 1MB
            if (imageFiles.length > MAX_IMAGES) {
                showAlert(`You can only upload up to ${MAX_IMAGES} images per item.`, 'error');
                return;
            }
            if (imageFiles.length > 0) {
                let processed = 0;
                let errored = false;
                for (let i = 0; i < imageFiles.length; i++) {
                    resizeAndCompressImage(imageFiles[i]).then(dataUrl => {
                        imageData[i] = dataUrl;
                        processed++;
                        // Check total size after all images processed
                        if (processed === imageFiles.length && !errored) {
                            const totalSize = imageData.reduce((sum, img) => sum + (img.length || 0), 0);
                            if (totalSize > MAX_TOTAL_SIZE) {
                                showAlert('Total image size exceeds 1MB. Please use fewer or smaller images.', 'error');
                                return;
                            }
                    saveItem(name, barcode, description, category, quantity, price, location, minStock, imageData);
                        }
                    }).catch(err => {
                        errored = true;
                        showAlert(err, 'error');
                    });
                }
            } else {
                saveItem(name, barcode, description, category, quantity, price, location, minStock, null);
            }
        }

        async function saveItem(name, barcode, description, category, quantity, price, location, minStock, imageData) {
            try {
            const item = {
                    userId: currentUser,
                name: name,
                barcode: barcode,
                description: description,
                category: category,
                quantity: quantity,
                price: price,
                location: location,
                minStock: minStock,
                image: imageData,
                dateAdded: new Date().toISOString()
            };

                // Save to Firestore
                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), item);
                item.id = docRef.id; // Use Firestore document ID

            inventory.push(item);

            // Reset form
            document.getElementById('add-item-form').reset();
                document.getElementById('add-image-gallery').innerHTML = '';

            // Show success message
            showAlert('Item added successfully!', 'success');

            // Update displays
            updateDashboard();
            loadInventoryTable();
            } catch (error) {
                console.error('Error saving item:', error);
                showAlert('Error saving item: ' + error.message, 'error');
            }
        }

        function loadInventoryTable() {
            const tbody = document.getElementById('inventory-body');
            const recentTbody = document.getElementById('recent-items-body');
            
            tbody.innerHTML = '';
            recentTbody.innerHTML = '';

            inventory.forEach(item => {
                const row = createInventoryRow(item);
                tbody.appendChild(row);

                // Add to recent items (last 5)
                if (recentTbody.children.length < 5) {
                    const recentRow = createInventoryRow(item);
                    recentTbody.appendChild(recentRow);
                }
            });
        }

        function createInventoryRow(item) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    ${item.image ? `<img src="${item.image}" class="item-image" alt="${item.name}">` : 'üì¶'}
                </td>
                <td>${item.name}</td>
                <td><span class="barcode">${item.barcode || 'N/A'}</span></td>
                <td>
                    <span style="color: ${item.quantity <= item.minStock ? '#dc3545' : '#28a745'}">
                        ${item.quantity}
                    </span>
                </td>
                <td>$${item.price.toFixed(2)}</td>
                <td>${item.category || 'Uncategorized'}</td>
                <td>${item.location || 'N/A'}</td>
                <td>
                    <button class="btn btn-warning" onclick="editItem('${item.id}')" style="padding: 12px 12px; margin: 2px; min-width:44px; min-height:44px;" aria-label="Edit item" title="Edit Item">‚úèÔ∏è</button>
                    <button class="btn btn-danger" onclick="deleteItem('${item.id}')" style="padding: 12px 12px; margin: 2px; min-width:44px; min-height:44px;" aria-label="Delete item" title="Delete Item">üóëÔ∏è</button>
                    <button class="btn btn-primary" onclick="generateLabel('${item.id}')" style="padding: 12px 12px; margin: 2px; min-width:44px; min-height:44px;" aria-label="Generate label" title="Generate Label">üè∑Ô∏è</button>
                </td>
            `;
            return row;
        }

        function updateDashboard() {
            const totalItems = inventory.length;
            const lowStock = inventory.filter(item => item.quantity <= item.minStock).length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const categories = new Set(inventory.map(item => item.category).filter(cat => cat)).size;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('low-stock').textContent = lowStock;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('categories').textContent = categories;
        }

        function searchInventory(query) {
            const rows = document.querySelectorAll('#inventory-body tr, #recent-items-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function editItem(id) {
            const item = inventory.find(item => item.id === id);
            if (!item) {
                showAlert('Item not found for editing!', 'error');
                return;
            }
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-barcode').value = item.barcode || '';
            document.getElementById('edit-item-description').value = item.description || '';
            document.getElementById('edit-item-category').value = item.category || '';
            document.getElementById('edit-item-quantity').value = item.quantity;
            document.getElementById('edit-item-price').value = item.price;
            document.getElementById('edit-item-location').value = item.location || '';
            document.getElementById('edit-item-min-stock').value = item.minStock || 5;
            document.getElementById('edit-item-tags').value = (item.tags && Array.isArray(item.tags)) ? item.tags.join(', ') : '';
            updateTagChips('edit-item-tags', 'edit-tag-chips');
            // Populate image gallery
            const gallery = document.getElementById('edit-image-gallery');
            gallery.innerHTML = '';
            window.editImageFiles = [];
            if (item.image && Array.isArray(item.image)) {
                item.image.forEach((imgData, idx) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.position = 'relative';
                    imgWrapper.style.display = 'inline-block';
                    const img = document.createElement('img');
                    img.src = imgData;
                    imgWrapper.appendChild(img);
                    // Add X button
                    const xBtn = document.createElement('button');
                    xBtn.textContent = '‚úñ';
                    xBtn.className = 'delete-image-btn';
                    xBtn.style.position = 'absolute';
                    xBtn.style.top = '0';
                    xBtn.style.right = '0';
                    xBtn.style.background = 'rgba(220,53,69,0.8)';
                    xBtn.style.color = '#fff';
                    xBtn.style.border = 'none';
                    xBtn.style.borderRadius = '50%';
                    xBtn.style.width = '22px';
                    xBtn.style.height = '22px';
                    xBtn.style.cursor = 'pointer';
                    xBtn.onclick = function(ev) {
                        ev.preventDefault();
                        item.image.splice(idx, 1);
                        editItem(id); // re-render
                    };
                    imgWrapper.appendChild(xBtn);
                    gallery.appendChild(imgWrapper);
                });
            }
            document.getElementById('edit-modal').style.display = 'block';
        }

        async function updateItem() {
            const id = document.getElementById('edit-item-id').value;
            const name = document.getElementById('edit-item-name').value;
            const barcode = document.getElementById('edit-item-barcode').value;
            const description = document.getElementById('edit-item-description').value;
            const category = document.getElementById('edit-item-category').value;
            const quantity = parseInt(document.getElementById('edit-item-quantity').value);
            const price = parseFloat(document.getElementById('edit-item-price').value) || 0;
            const location = document.getElementById('edit-item-location').value;
            const minStock = parseInt(document.getElementById('edit-item-min-stock').value) || 5;
            const imageFiles = window.editImageFiles || document.getElementById('edit-item-images').files;
            let imageData = [];
            const MAX_IMAGES = 3;
            const MAX_TOTAL_SIZE = 1048487; // 1MB
            if (imageFiles.length > MAX_IMAGES) {
                showAlert(`You can only upload up to ${MAX_IMAGES} images per item.`, 'error');
                return;
            }
            if (imageFiles.length > 0) {
                let processed = 0;
                let errored = false;
                for (let i = 0; i < imageFiles.length; i++) {
                    try {
                        const dataUrl = await resizeAndCompressImage(imageFiles[i]);
                        imageData[i] = dataUrl;
                        processed++;
                    } catch (err) {
                        errored = true;
                        showAlert(err, 'error');
                        break;
                    }
                }
                if (!errored) {
                    const totalSize = imageData.reduce((sum, img) => sum + (img.length || 0), 0);
                    if (totalSize > MAX_TOTAL_SIZE) {
                        showAlert('Total image size exceeds 1MB. Please use fewer or smaller images.', 'error');
                        return;
                    }
                    await saveUpdatedItem(id, name, barcode, description, category, quantity, price, location, minStock, imageData, tags);
                }
            } else {
                // If no new images, keep the old ones
                const item = inventory.find(item => item.id === id);
                imageData = item && item.image ? item.image : null;
                await saveUpdatedItem(id, name, barcode, description, category, quantity, price, location, minStock, imageData, tags);
            }
        }

        async function saveUpdatedItem(id, name, barcode, description, category, quantity, price, location, minStock, imageData, tags) {
            try {
                const itemRef = window.firebase.doc(window.firebase.db, 'inventory', id);
                await window.firebase.updateDoc(itemRef, {
                    name: name,
                    barcode: barcode,
                    description: description,
                    category: category,
                    quantity: quantity,
                    price: price,
                    location: location,
                    minStock: minStock,
                    image: imageData,
                    tags: tags
                });
                // Update local inventory
            const itemIndex = inventory.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                    inventory[itemIndex] = {
                        ...inventory[itemIndex],
                        name,
                        barcode,
                        description,
                        category,
                        quantity,
                        price,
                        location,
                        minStock,
                        image: imageData,
                        tags
                    };
                }
                closeEditModal();
                updateDashboard();
                loadInventoryTable();
                showAlert('Item updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating item:', error);
                showAlert('Error updating item: ' + error.message, 'error');
            }
        }

        async function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const itemRef = window.firebase.doc(window.firebase.db, 'inventory', id);
                    await window.firebase.deleteDoc(itemRef);

                    // Remove from local inventory
                inventory = inventory.filter(item => item.id !== id);
                    
                updateDashboard();
                loadInventoryTable();
                showAlert('Item deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting item:', error);
                    showAlert('Error deleting item: ' + error.message, 'error');
                }
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewEditImage(input) {
            const preview = document.getElementById('edit-image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Barcode Scanner Functions
        let isScanning = false;
        let lastScannedCode = '';
        let scanTimeout = null;

        function activateScanner() {
            document.getElementById('scanner-modal').style.display = 'block';
            startScanner();
        }

        function closeScannerModal() {
            console.log('Closing scanner modal');
            document.getElementById('scanner-modal').style.display = 'none';
            stopScanner();
        }

        async function startScanner() {
            if (isScanning) {
                return;
            }

            try {
                // Stop any existing scanner
                stopScanner();
                
                // Reset scanning state
                isScanning = true;
                lastScannedCode = '';
                
                // Update button state
                document.querySelector('.barcode-scan-btn').classList.add('scanning');
                document.querySelector('.barcode-scan-btn').textContent = 'üì∑';
                
                // Request camera access with iPhone-optimized settings
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    } 
                });
                
                const video = document.getElementById('scanner-video');
                video.srcObject = stream;

                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                // Initialize ZXing scanner with better settings
                const codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Configure scanner for better iPhone performance
                // codeReader.hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                // codeReader.hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                
                codeReader.decodeFromVideoDevice(null, 'scanner-video', (result, err) => {
                    console.log('Scanner callback - result:', result, 'error:', err);
                    
                    if (result && isScanning) {
                        const scannedCode = result.text.trim();
                        console.log('Scanned code:', scannedCode);
                        
                        // Prevent duplicate scans of the same code
                        if (scannedCode === lastScannedCode) {
                            console.log('Duplicate scan detected, ignoring');
                            return;
                        }
                        
                        // Clear any existing timeout
                        if (scanTimeout) {
                            clearTimeout(scanTimeout);
                        }
                        
                        // Set the scanned code
                        lastScannedCode = scannedCode;
                        document.getElementById('item-barcode').value = scannedCode;
                        
                        // Show success message
                        showAlert(`Barcode scanned: ${scannedCode}`, 'success');
                        
                        // Close modal and stop scanner
                        scanTimeout = setTimeout(() => {
                            console.log('Auto-closing scanner after successful scan');
                            closeScannerModal();
                        }, 1000);
                    }
                });

                scanner = codeReader;
                document.getElementById('scanner-status-text').textContent = 'Camera active - scanning for barcodes...';
                
            } catch (error) {
                isScanning = false;
                console.error('Scanner error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showAlert('Camera access denied. Please allow camera permissions and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showAlert('No camera found. Please check your device has a camera.', 'error');
                } else {
                showAlert('Error accessing camera: ' + error.message, 'error');
                }
                
                closeScannerModal();
            }
        }

        function stopScanner() {
            isScanning = false;
            
            // Clear any pending timeout
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // Reset scanner
            if (scanner) {
                try {
                scanner.reset();
                } catch (e) {
                    console.log('Scanner reset error:', e);
                }
                scanner = null;
            }
            
            // Stop video stream
            if (stream) {
                try {
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                } catch (e) {
                    console.log('Stream stop error:', e);
                }
                stream = null;
            }
            
            // Clear video element
            const video = document.getElementById('scanner-video');
            if (video) {
                video.srcObject = null;
            }
            
            // Reset UI
            document.querySelector('.barcode-scan-btn').classList.remove('scanning');
            document.querySelector('.barcode-scan-btn').textContent = 'üì∑';
            document.getElementById('scanner-status-text').textContent = 'Ready to scan';
            
            // Clear last scanned code after a delay
            setTimeout(() => {
                lastScannedCode = '';
            }, 2000);
        }

        // Report Generation Functions
        function generateReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const includeImages = document.getElementById('include-images').checked;
            const includeBarcodes = document.getElementById('include-barcodes').checked;
            const includePrices = document.getElementById('include-prices').checked;
            const includeLocations = document.getElementById('include-locations').checked;
            const reportType = document.getElementById('report-type').value;

            let filteredInventory = [...inventory];

            // Filter based on report type
            switch (reportType) {
                case 'low-stock':
                    filteredInventory = inventory.filter(item => item.quantity <= item.minStock);
                    break;
                case 'category':
                    const category = document.getElementById('report-category').value;
                    if (category) {
                        filteredInventory = inventory.filter(item => item.category === category);
                    }
                    break;
                case 'value':
                    filteredInventory = inventory.filter(item => item.price > 100);
                    break;
            }

            // Add title
            doc.setFontSize(20);
            doc.text('Inventory Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            doc.text(`Total Items: ${filteredInventory.length}`, 105, 40, { align: 'center' });

            // Prepare table data
            const tableData = filteredInventory.map(item => {
                const row = [
                    item.name,
                    item.quantity.toString(),
                    item.category || 'N/A'
                ];

                if (includePrices) {
                    row.push(`$${item.price.toFixed(2)}`);
                }
                if (includeLocations) {
                    row.push(item.location || 'N/A');
                }
                if (includeBarcodes) {
                    row.push(item.barcode || 'N/A');
                }

                return row;
            });

            // Define headers
            const headers = ['Name', 'Quantity', 'Category'];
            if (includePrices) headers.push('Price');
            if (includeLocations) headers.push('Location');
            if (includeBarcodes) headers.push('Barcode');

            // Add table
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 50,
                styles: {
                    fontSize: 10,
                    cellPadding: 5
                },
                headStyles: {
                    fillColor: [44, 62, 80],
                    textColor: 255
                }
            });

            // Add images if requested
            if (includeImages) {
                let yPosition = doc.lastAutoTable.finalY + 20;
                filteredInventory.forEach((item, index) => {
                    if (item.image && yPosition < 250) {
                        try {
                            doc.addImage(item.image, 'JPEG', 20, yPosition, 30, 30);
                            yPosition += 40;
                        } catch (e) {
                            console.log('Error adding image:', e);
                        }
                    }
                });
            }

            // Save the PDF
            doc.save(`inventory-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showAlert('PDF report generated successfully!', 'success');
        }

        function exportToCSV() {
            const headers = ['Name', 'Barcode', 'Description', 'Category', 'Quantity', 'Price', 'Location', 'Date Added'];
            const csvContent = [
                headers.join(','),
                ...inventory.map(item => [
                    `"${item.name}"`,
                    `"${item.barcode || ''}"`,
                    `"${item.description || ''}"`,
                    `"${item.category || ''}"`,
                    item.quantity,
                    item.price,
                    `"${item.location || ''}"`,
                    `"${item.dateAdded}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('CSV file exported successfully!', 'success');
        }

        function loadCategories() {
            const categories = [...new Set(inventory.map(item => item.category).filter(cat => cat))];
            const select = document.getElementById('report-category');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container') || document.querySelector('.login-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showLoginError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.textContent = message;
            errorDiv.style.marginTop = '10px';
            
            const loginForm = document.getElementById('login-form');
            loginForm.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Settings Functions
        async function loadUserSettings() {
            try {
                // Load user profile from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('username', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                let userProfile = {};
                let preferences = {};
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    userProfile = {
                        email: userData.email || '',
                        fullname: userData.fullname || '',
                        created: userData.created || 'Unknown'
                    };
                    
                    preferences = {
                        autoLogout: userData.autoLogout !== false,
                        notifications: userData.notifications !== false,
                        lowStockAlerts: userData.lowStockAlerts !== false
                    };
                }
            
            // Load account information
            document.getElementById('current-username').value = currentUser || '';
            document.getElementById('user-email').value = userProfile.email || '';
            document.getElementById('user-fullname').value = userProfile.fullname || '';
            
            // Load preferences
                document.getElementById('auto-logout').checked = preferences.autoLogout;
                document.getElementById('notifications').checked = preferences.notifications;
                document.getElementById('low-stock-alerts').checked = preferences.lowStockAlerts;
                
                // Load theme (still use localStorage for theme)
            const currentTheme = localStorage.getItem('theme') || 'default';
            document.getElementById('theme-select').value = currentTheme;
            
            // Update about section
            document.getElementById('total-items-settings').textContent = inventory.length;
            document.getElementById('last-login').textContent = new Date().toLocaleString();
            document.getElementById('account-created').textContent = userProfile.created || 'Unknown';
            } catch (error) {
                console.error('Error loading user settings:', error);
                showAlert('Error loading user settings: ' + error.message, 'error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Please fill in all password fields!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('New password must be at least 6 characters long!', 'error');
                return;
            }
            
            try {
                const user = window.firebase.auth.currentUser;
                if (!user) {
                    showAlert('You must be logged in to change your password!', 'error');
                return;
            }
            
                // Re-authenticate user before changing password
                const email = currentUser + '@farhop-inventory.com';
                const credential = window.firebase.EmailAuthProvider.credential(email, currentPassword);
                await window.firebase.reauthenticateWithCredential(user, credential);
                
                // Change password
                await window.firebase.updatePassword(user, newPassword);
            
            // Clear form
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            showAlert('Password changed successfully!', 'success');
            } catch (error) {
                console.error('Error changing password:', error);
                if (error.code === 'auth/wrong-password') {
                    showAlert('Current password is incorrect!', 'error');
                } else {
                    showAlert('Error changing password: ' + error.message, 'error');
                }
            }
        }

        async function exportUserData() {
            try {
                // Get user profile from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('username', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                let userProfile = {};
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    userProfile = userDoc.data();
                }
                
            const userData = {
                inventory: inventory,
                    userProfile: userProfile,
                    exportDate: new Date().toISOString(),
                    note: 'This export contains your inventory data. User credentials are managed by Firebase and cannot be exported.'
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
                showAlert('Inventory data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }

        async function importUserData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const userData = JSON.parse(e.target.result);
                        
                        if (userData.inventory) {
                            // Import inventory items to Firestore
                            for (const item of userData.inventory) {
                                const importItem = {
                                    userId: currentUser,
                                    name: item.name,
                                    barcode: item.barcode,
                                    description: item.description,
                                    category: item.category,
                                    quantity: item.quantity,
                                    price: item.price,
                                    location: item.location,
                                    minStock: item.minStock,
                                    image: item.image,
                                    dateAdded: item.dateAdded || new Date().toISOString()
                                };
                                
                                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), importItem);
                            }
                            
                            // Reload inventory
                            await loadInventory();
                        }
                        
                        if (userData.userProfile) {
                            // Update user profile in Firestore
                            const usersRef = window.firebase.collection(window.firebase.db, 'users');
                            const q = window.firebase.query(usersRef, window.firebase.where('username', '==', currentUser));
                            const querySnapshot = await window.firebase.getDocs(q);
                            
                            if (!querySnapshot.empty) {
                                const userDoc = querySnapshot.docs[0];
                                await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), userData.userProfile);
                            }
                        }
                        
                        updateDashboard();
                        loadInventoryTable();
                        await loadUserSettings();
                        showAlert('Data imported successfully!', 'success');
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showAlert('Error importing data: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        async function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone!')) {
                try {
                    // Delete all inventory items for this user from Firestore
                    const inventoryRef = window.firebase.collection(window.firebase.db, 'inventory');
                    const q = window.firebase.query(inventoryRef, window.firebase.where('userId', '==', currentUser));
                    const querySnapshot = await window.firebase.getDocs(q);
                    
                    const deletePromises = querySnapshot.docs.map(doc => 
                        window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'inventory', doc.id))
                    );
                    
                    await Promise.all(deletePromises);
                    
                    // Clear local inventory
                inventory = [];
                    
                    // Clear local storage (theme, etc.)
                    localStorage.clear();
                    
                showAlert('All data cleared successfully!', 'success');
                logout();
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showAlert('Error clearing data: ' + error.message, 'error');
                }
            }
        }

        // Save user profile when fields change
        async function saveUserProfile() {
            try {
            const userProfile = {
                email: document.getElementById('user-email').value,
                fullname: document.getElementById('user-fullname').value,
                created: document.getElementById('account-created').textContent === 'Unknown' ? 
                        new Date().toLocaleDateString() : document.getElementById('account-created').textContent,
                    updated: new Date().toISOString()
                };
                
                // Save to Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('username', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), userProfile);
                }
            } catch (error) {
                console.error('Error saving user profile:', error);
                showAlert('Error saving profile: ' + error.message, 'error');
            }
        }

        // Save preferences when checkboxes change
        async function savePreferences() {
            try {
            const preferences = {
                autoLogout: document.getElementById('auto-logout').checked,
                notifications: document.getElementById('notifications').checked,
                    lowStockAlerts: document.getElementById('low-stock-alerts').checked,
                    updated: new Date().toISOString()
                };
                
                // Save to Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('username', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), preferences);
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showAlert('Error saving preferences: ' + error.message, 'error');
            }
        }

        // Email Functions
        function sendSignupEmail(username, password) {
            // Initialize EmailJS (you'll need to set up your own EmailJS account)
            emailjs.init("YOUR_EMAILJS_PUBLIC_KEY"); // Replace with your actual EmailJS public key
            
            const templateParams = {
                to_email: "support@farhop.com",
                from_name: "Inventory System",
                username: username,
                password: password,
                signup_date: new Date().toLocaleString(),
                user_agent: navigator.userAgent,
                device_info: `${navigator.platform} - ${navigator.language}`
            };

            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
                .then(function(response) {
                    console.log('Signup email sent successfully:', response);
                }, function(error) {
                    console.log('Failed to send signup email:', error);
                    // Don't show error to user - email failure shouldn't prevent signup
                });
        }

        // Forgot Password Functions
        function showForgotPassword() {
            document.getElementById('forgot-password-modal').style.display = 'block';
            document.getElementById('forgot-step-1').style.display = 'block';
        }

        function closeForgotPassword() {
            document.getElementById('forgot-password-modal').style.display = 'none';
        }

        async function sendPasswordReset() {
            const email = document.getElementById('recovery-email').value.trim().toLowerCase();
            if (!email) {
                showAlert('Please enter your email!', 'error');
                return;
            }
            try {
                await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
                closeForgotPassword();
                showAlert('Password reset email sent! Please check your email and follow the instructions to reset your password.', 'success');
            } catch (error) {
                console.error('Error sending password reset email:', error);
                if (error.code === 'auth/user-not-found') {
                    showAlert('No account found with that email.', 'error');
                } else {
                    showAlert('Error sending password reset email: ' + error.message, 'error');
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
            
            const forgotModal = document.getElementById('forgot-password-modal');
            if (event.target === forgotModal) {
                closeForgotPassword();
            }
            
            const scannerModal = document.getElementById('scanner-modal');
            if (event.target === scannerModal) {
                closeScannerModal();
            }
            
            const userDetailsModal = document.getElementById('user-details-modal');
            if (event.target === userDetailsModal) {
                closeUserDetails();
            }
        }

        let categories = ["Electronics", "Clothing", "Books", "Food", "Tools", "Other"];

        async function loadCategoriesFromFirestore() {
            try {
                const catRef = window.firebase.collection(window.firebase.db, 'categories');
                const q = window.firebase.query(catRef, window.firebase.where('userId', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                categories = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data && data.name) {
                        categories.push({ id: doc.id, name: data.name });
                    }
                });
                if (categories.length === 0) {
                    // If no categories, add defaults
                    await addDefaultCategories();
                    await loadCategoriesFromFirestore();
                } else {
                    renderCategoryList();
                    populateCategorySelects();
                }
            } catch (e) {
                console.error('Error loading categories:', e);
            }
        }

        async function addDefaultCategories() {
            const defaultCats = ["Electronics", "Clothing", "Books", "Food", "Tools", "Other"];
            for (const name of defaultCats) {
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'categories'), {
                    userId: currentUser,
                    name
                });
            }
        }

        function renderCategoryList() {
            const ul = document.getElementById('category-list');
            ul.innerHTML = '';
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.gap = '8px';
                li.innerHTML = `
                    <span>${cat.name}</span>
                    <button class="btn btn-warning" style="padding:2px 8px;" onclick="renameCategoryPrompt('${cat.id}', '${cat.name}')">Rename</button>
                    <button class="btn btn-danger" style="padding:2px 8px;" onclick="deleteCategory('${cat.id}')">Delete</button>
                `;
                ul.appendChild(li);
            });
        }

        async function addCategory() {
            const input = document.getElementById('new-category-input');
            const name = input.value.trim();
            if (!name) return;
            await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'categories'), {
                userId: currentUser,
                name
            });
            input.value = '';
            await loadCategoriesFromFirestore();
        }

        function renameCategoryPrompt(id, oldName) {
            const newName = prompt('Rename category:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                renameCategory(id, newName.trim());
            }
        }

        async function renameCategory(id, newName) {
            const catRef = window.firebase.doc(window.firebase.db, 'categories', id);
            await window.firebase.updateDoc(catRef, { name: newName });
            await loadCategoriesFromFirestore();
        }

        async function deleteCategory(id) {
            if (!confirm('Delete this category?')) return;
            const catRef = window.firebase.doc(window.firebase.db, 'categories', id);
            await window.firebase.deleteDoc(catRef);
            await loadCategoriesFromFirestore();
        }

        function populateCategorySelects() {
            const selects = [document.getElementById('item-category'), document.getElementById('edit-item-category'), document.getElementById('report-category')];
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            });
        }

        // Generate Label (PDF with barcode and QR)
        function generateLabel(id) {
            const item = inventory.find(item => item.id === id);
            if (!item) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(item.name, 10, 20);
            doc.setFontSize(12);
            doc.text('Barcode:', 10, 35);
            doc.text(item.barcode || 'N/A', 40, 35);
            // Barcode (using JsBarcode via CDN)
            const barcodeCanvas = document.createElement('canvas');
            JsBarcode(barcodeCanvas, item.barcode || '', { format: 'CODE128', width: 2, height: 40 });
            doc.addImage(barcodeCanvas.toDataURL('image/png'), 'PNG', 10, 40, 80, 20);
            // QR code (using QRious via CDN)
            const qr = new QRious({ value: item.barcode || '', size: 80 });
            doc.text('QR Code:', 10, 70);
            doc.addImage(qr.toDataURL(), 'PNG', 10, 75, 40, 40);
            doc.save(`${item.name}_label.pdf`);
        }

        // Multiple photos per item: previewImages, save/load images as array
        function previewImages(input, mode) {
            const gallery = mode === 'add' ? document.getElementById('add-image-gallery') : document.getElementById('edit-image-gallery');
            gallery.innerHTML = '';
            let files = Array.from(input.files);
            // Store selected files in a global variable for each mode
            if (mode === 'add') {
                window.addImageFiles = files;
            } else {
                window.editImageFiles = files;
            }
            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.position = 'relative';
                    imgWrapper.style.display = 'inline-block';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imgWrapper.appendChild(img);
                    // Add X button
                    const xBtn = document.createElement('button');
                    xBtn.textContent = '‚úñ';
                    xBtn.className = 'delete-image-btn';
                    xBtn.style.position = 'absolute';
                    xBtn.style.top = '0';
                    xBtn.style.right = '0';
                    xBtn.style.background = 'rgba(220,53,69,0.8)';
                    xBtn.style.color = '#fff';
                    xBtn.style.border = 'none';
                    xBtn.style.borderRadius = '50%';
                    xBtn.style.width = '22px';
                    xBtn.style.height = '22px';
                    xBtn.style.cursor = 'pointer';
                    xBtn.onclick = function(ev) {
                        ev.preventDefault();
                        // Remove file from array and update input.files
                        files.splice(idx, 1);
                        // Update global variable
                        if (mode === 'add') {
                            window.addImageFiles = files;
                        } else {
                            window.editImageFiles = files;
                        }
                        // Create a new FileList
                        const dataTransfer = new DataTransfer();
                        files.forEach(f => dataTransfer.items.add(f));
                        input.files = dataTransfer.files;
                        previewImages(input, mode);
                    };
                    imgWrapper.appendChild(xBtn);
                    gallery.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        // Multi-tag support: parse tags from input, display as chips
        function updateTagChips(inputId, chipsId) {
            const input = document.getElementById(inputId);
            const chips = document.getElementById(chipsId);
            chips.innerHTML = '';
            const tags = input.value.split(',').map(t => t.trim()).filter(Boolean);
            tags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.textContent = tag;
                chips.appendChild(chip);
            });
        }

        document.getElementById('item-tags').addEventListener('input', () => updateTagChips('item-tags', 'add-tag-chips'));
        document.getElementById('edit-item-tags').addEventListener('input', () => updateTagChips('edit-item-tags', 'edit-tag-chips'));

        // Branding: preview, save, and apply logo/color
        function previewBrandingLogo(input) {
            const preview = document.getElementById('branding-logo-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function applyThemeColor(color) {
            document.documentElement.style.setProperty('--theme-color', color);
        }

        function saveBranding() {
            const logoInput = document.getElementById('branding-logo');
            const color = document.getElementById('branding-color').value;
            let logoData = null;
            if (logoInput.files && logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoData = e.target.result;
                    localStorage.setItem('brandingLogo', logoData);
                    localStorage.setItem('brandingColor', color);
                    applyThemeColor(color);
                    document.getElementById('branding-logo-preview').src = logoData;
                    document.getElementById('branding-logo-preview').style.display = 'block';
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                localStorage.setItem('brandingColor', color);
                applyThemeColor(color);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const logoData = localStorage.getItem('brandingLogo');
            const color = localStorage.getItem('brandingColor');
            if (logoData) {
                document.getElementById('branding-logo-preview').src = logoData;
                document.getElementById('branding-logo-preview').style.display = 'block';
            }
            if (color) {
                document.getElementById('branding-color').value = color;
                applyThemeColor(color);
            }
        });

        // At the end of the script, attach editItem to window
        window.editItem = editItem;

        // Admin login logic
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'changeme123'; // Change this to your secure password

        function showAdminLogin() {
          document.getElementById('admin-login-modal').style.display = 'block';
        }
        function closeAdminLogin() {
          document.getElementById('admin-login-modal').style.display = 'none';
        }
        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
          e.preventDefault();
          adminLogin();
        });

        function adminLogin() {
          const username = document.getElementById('admin-username').value.trim();
          const password = document.getElementById('admin-password').value;
          if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            showAdminDashboard();
            closeAdminLogin();
          } else {
            showAlert('Invalid admin credentials!', 'error');
          }
        }

        function showAdminDashboard() {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-app').style.display = 'none';
          document.getElementById('admin-dashboard').classList.remove('hidden');
          loadAllUsers();
        }
        function logoutAdmin() {
          document.getElementById('admin-dashboard').classList.add('hidden');
          showLoginScreen();
        }
        async function loadAllUsers() {
          try {
            const usersRef = window.firebase.collection(window.firebase.db, 'users');
            const querySnapshot = await window.firebase.getDocs(usersRef);
            const tbody = document.getElementById('admin-users-body');
            tbody.innerHTML = '';
            querySnapshot.forEach(doc => {
              const user = doc.data();
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${user.username || ''}</td>
                <td>${user.email || ''}</td>
                <td>${user.created ? new Date(user.created).toLocaleString() : ''}</td>
                <td>${user.lastIP || ''}</td>
                <td>
                  <button class="btn btn-warning" onclick="adminLoginAsUser('${user.email}')" title="Login as User">Login</button>
                  <button class="btn btn-danger" onclick="deleteUser('${doc.id}')" title="Delete User">Delete</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          } catch (error) {
            showAlert('Error loading users: ' + error.message, 'error');
          }
        }
        // ... existing code ...
        // Add modal close logic for admin login
        window.onclick = function(event) {
          // ... existing code ...
          const adminModal = document.getElementById('admin-login-modal');
          if (event.target === adminModal) {
            closeAdminLogin();
          }
        }
        // ... existing code ...
        // Delete user
        async function deleteUser(userId) {
          if (!confirm('Are you sure you want to delete this user?')) return;
          try {
            await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'users', userId));
            showAlert('User deleted.', 'success');
            loadAllUsers();
          } catch (error) {
            showAlert('Error deleting user: ' + error.message, 'error');
          }
        }
        // Show user details modal
        async function showUserDetails(userId) {
          try {
            const userDocRef = window.firebase.doc(window.firebase.db, 'users', userId);
            const getDoc = window.firebase.getDoc;
            const snap = await getDoc(userDocRef);
            let user = null;
            if (snap.exists()) {
              user = snap.data();
            } else {
              user = null;
            }
            if (!user) {
              document.getElementById('user-details-content').innerHTML = '<p>User not found.</p>';
            } else {
              let html = '<ul>';
              for (const key in user) {
                html += `<li><strong>${key}:</strong> ${user[key]}</li>`;
              }
              html += '</ul>';
              document.getElementById('user-details-content').innerHTML = html;
            }
            document.getElementById('user-details-modal').style.display = 'block';
          } catch (error) {
            document.getElementById('user-details-content').innerHTML = '<p>Error loading user details.</p>';
            document.getElementById('user-details-modal').style.display = 'block';
          }
        }
        function closeUserDetails() {
          document.getElementById('user-details-modal').style.display = 'none';
        }
        // ... existing code ...
        // Add modal close logic for user details
        window.onclick = function(event) {
          // ... existing code ...
          const userDetailsModal = document.getElementById('user-details-modal');
          if (event.target === userDetailsModal) {
            closeUserDetails();
          }
        }
        // ... existing code ...
        // Utility to get public IP
        async function getPublicIP() {
          try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            return data.ip;
          } catch {
            return 'Unknown';
          }
        }

        // Show Admin tab if user is admin
        function updateAdminTab() {
          const navTabs = document.getElementById('main-nav-tabs');
          if (!navTabs) return;
          // Remove existing Admin tab if any
          const existing = document.getElementById('admin-nav-tab');
          if (existing) existing.remove();
          if (currentUser === 'admin') {
            // Insert Admin tab before the last tab (Settings)
            const btn = document.createElement('button');
            btn.className = 'nav-tab';
            btn.id = 'admin-nav-tab';
            btn.textContent = 'üë§ Admin';
            btn.onclick = function() {
              showAdminDashboard();
              // Set active class
              document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
              btn.classList.add('active');
            };
            // Insert before the last tab (Settings)
            const settingsTab = navTabs.querySelector('button.nav-tab:last-child');
            navTabs.insertBefore(btn, settingsTab);
          }
        }

        // Add adminLoginAsUser function
        async function adminLoginAsUser(email) {
          const password = prompt('Enter the password for this user to log in as them:');
          if (!password) return;
          try {
            const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
            const user = userCredential.user;
            // Get user profile from Firestore
            const usersRef = window.firebase.collection(window.firebase.db, 'users');
            const q = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
            const querySnapshot = await window.firebase.getDocs(q);
            if (!querySnapshot.empty) {
              const userDoc = querySnapshot.docs[0];
              const userData = userDoc.data();
              isAuthenticated = true;
              currentUser = userData.username;
              // Save IP
              const ip = await getPublicIP();
              await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), { lastIP: ip });
              // Create session
              const session = {
                username: userData.username,
                timestamp: Date.now()
              };
              localStorage.setItem('inventory_session', JSON.stringify(session));
              await showMainApp();
              showAlert('Logged in as ' + userData.username, 'success');
            } else {
              showLoginError('User profile not found!');
            }
          } catch (error) {
            showAlert('Login as user failed: ' + error.message, 'error');
          }
        }
    </script>
</body>
</html> 