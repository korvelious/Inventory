<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Management System</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, EmailAuthProvider, reauthenticateWithCredential, updatePassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
      import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBVi2H979UqIc0D6t58Z_GwB8ax94UMkak",
        authDomain: "farhop-inventory.firebaseapp.com",
        projectId: "farhop-inventory",
        storageBucket: "farhop-inventory.firebasestorage.app",
        messagingSenderId: "1032603057511",
        appId: "1:1032603057511:web:d3fc28572e40889a8c03c2"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const functions = getFunctions(app);

      // Make Firebase available globally
      window.firebase = {
        auth,
        db,
        functions,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
        sendPasswordResetEmail,
        EmailAuthProvider,
        reauthenticateWithCredential,
        updatePassword,
        collection,
        addDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        doc,
        query,
        where,
        onSnapshot
      };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Login Styles */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            text-align: center;
        }

        .login-container h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .login-form input {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-link {
            background: none;
            border: none;
            color: #667eea;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 5px;
        }

        .btn-link:hover {
            color: #764ba2;
        }

        .security-questions {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }

        .security-questions h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .setup-credentials {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .setup-credentials h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .setup-credentials p {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .hidden {
            display: none;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .nav-tab.active {
            background: white;
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control, .form-control textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
          font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
        }

        .scanner-container {
            text-align: center;
            margin: 20px 0;
        }

        .scanner-frame {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        #scanner-video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: #000;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .scanner-target {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 3px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .scanner-instructions {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 0 0 15px 15px;
        }

        .scanner-instructions p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .scanner-status {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .scanner-status p {
            margin: 0;
            color: #2c3e50;
            font-weight: 500;
        }

        .camera-controls {
            margin: 20px 0;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .inventory-table th,
        .inventory-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .inventory-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-weight: 600;
        }

        .inventory-table tr:hover {
            background: #f8f9fa;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .barcode {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid #e9ecef;
            margin: 10px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (max-width: 600px) {
          .modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            max-height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            padding: 0 !important;
            overflow-y: auto !important;
          }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .report-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10;
        }

        .logout-btn:hover {
            background: rgba(220, 53, 69, 1);
            transform: translateY(-1px);
        }

        .settings-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .settings-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .settings-section p {
            margin: 10px 0;
            color: #6c757d;
        }

        .settings-section .btn {
            margin: 5px;
        }

        .barcode-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .barcode-input-group .form-control {
            flex: 1;
        }

        .barcode-scan-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
        }

        .barcode-scan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .barcode-scan-btn.scanning {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            animation: pulse 1s infinite;
        }

        .scanner-modal-content {
            max-width: 500px;
            text-align: center;
        }

        .scanner-modal-content h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .inventory-table {
                font-size: 0.9em;
            }

            .inventory-table th,
            .inventory-table td {
                padding: 10px 8px;
            }
        }

        @media (max-width: 600px) {
          .scanner-modal-content {
            max-width: 100vw !important;
            width: 100vw !important;
            height: 100vh !important;
            margin: 0 !important;
            border-radius: 0 !important;
            padding: 0 !important;
          }
        }

        .image-gallery { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .image-gallery img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #e9ecef; }
        .tag-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }
        .tag-chip { background: #667eea; color: #fff; border-radius: 12px; padding: 2px 10px; font-size: 0.9em; }
        .delete-image-btn {
            font-size: 1em;
            line-height: 1;
            padding: 0;
            margin: 0;
            z-index: 2;
        }
        .stat-card h3, .stat-card .total-value {
          word-break: break-all;
          overflow-wrap: break-word;
          max-width: 100%;
          font-size: 2.2em;
          white-space: normal;
        }

        /* USB Scanner Styles */
        .scanner-section {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .scanner-section.checkin {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            border-left: 4px solid #4caf50;
        }

        .scanner-input {
            font-size: 1.1em;
            padding: 15px;
            border: 2px solid #2196f3;
            border-radius: 8px;
            font-weight: 500;
        }

        .scanner-input:focus {
            border-color: #1976d2;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .scanner-input.checkin {
            border-color: #4caf50;
        }

        .scanner-input.checkin:focus {
            border-color: #388e3c;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }

        .scanner-status {
            min-height: 24px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scanner-help {
            background: rgba(255, 255, 255, 0.7);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h1>üîê Inventory System</h1>
        <form class="login-form" id="login-form">
            <input type="email" id="login-email" placeholder="Email Address" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit" class="login-btn">Login</button>
            <button type="button" class="btn-link" onclick="showForgotPassword()">Forgot Password?</button>
            <button type="button" class="btn-link" onclick="showSignupForm()">Sign Up</button>
        </form>
        
        <div class="setup-credentials" id="setup-credentials" style="display:none;">
            <h3>Company Account Setup</h3>
            <p>Set up your company's inventory management system. You'll be the admin.</p>
            <form class="login-form" id="setup-form">
                <label for="setup-company-name">Company Name</label>
                <input type="text" id="setup-company-name" placeholder="Your Company Name" required>
                
                <label for="setup-username">Your Username</label>
                <input type="text" id="setup-username" placeholder="Choose a username" required>
                
                <label for="setup-email">Your Email Address</label>
                <input type="email" id="setup-email" placeholder="Your Email Address" required>
                
                <label for="setup-full-name">Your Full Name</label>
                <input type="text" id="setup-full-name" placeholder="Your Full Name" required>
                
                <label for="setup-password">Password</label>
                <input type="password" id="setup-password" placeholder="Choose Password" required>
                
                <label for="setup-confirm-password">Confirm Password</label>
                <input type="password" id="setup-confirm-password" placeholder="Confirm Password" required>
                
                <button type="submit" class="login-btn" onclick="console.log('Create Company Account button clicked');">Create Company Account</button>
                <button type="button" class="btn-link" onclick="showLoginForm()">Back to Login</button>
            </form>
        </div>
        <!-- Add version text at the bottom of the login/setup page -->
        <div id="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
          Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
        </div>
    </div>

        <!-- Forgot Password Modal -->
        <div id="forgot-password-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeForgotPassword()">&times;</span>
                <h2>üîë Password Recovery</h2>
                
                <!-- Step 1: Enter Username -->
                <div id="forgot-step-1">
                    <p>Enter your username to recover your password.</p>
                    <div class="form-group">
                        <input type="text" id="recovery-username" class="form-control" placeholder="Enter your username">
                    </div>
                    <button class="btn btn-primary" onclick="sendPasswordReset()">Send Password Reset Email</button>
                </div>
                
                <!-- Step 2: Set New Password -->
                <div id="forgot-step-3" style="display: none;">
                    <p>Set your new password.</p>
                    <div class="form-group">
                        <input type="password" id="new-password-recovery" class="form-control" placeholder="New Password">
                    </div>
                    <div class="form-group">
                        <input type="password" id="confirm-new-password-recovery" class="form-control" placeholder="Confirm New Password">
                    </div>
                    <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
                </div>
        </div>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="main-app" class="container hidden">
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        
        <div class="header">
            <h1>üì¶ Inventory Management System</h1>
            <p>Scan, Track, and Manage Your Inventory with Ease</p>
        </div>

        <div class="nav-tabs" id="main-nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showTab('add-item')">‚ûï Add Item</button>
            <button class="nav-tab" onclick="showTab('inventory')">üìã Inventory</button>
            <button class="nav-tab" onclick="showTab('checkout')">üì§ Check-Out</button>
            <button class="nav-tab" onclick="showTab('checkin')">üì• Check-In</button>
            <button class="nav-tab" onclick="showTab('employees')">üë• Employees</button>
            <button class="nav-tab" onclick="showTab('equipment-history')">üìú Equipment History</button>
            <button class="nav-tab" onclick="showTab('employee-history')">üë§ Employee History</button>
            <button class="nav-tab" onclick="showTab('reports')">üìÑ Reports</button>
            <button class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
            <!-- Admin tab will be injected by JS if user is admin -->
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="total-items">0</h3>
                    <p>Total Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="low-stock">0</h3>
                    <p>Low Stock Items</p>
                </div>
                <div class="stat-card">
                    <h3 id="total-value">$0</h3>
                    <p>Total Value</p>
                </div>
                <div class="stat-card">
                    <h3 id="categories">0</h3>
                    <p>Categories</p>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="dashboard-search" placeholder="Search inventory..." onkeyup="searchInventory(this.value)">
            </div>

            <div id="recent-items">
                <h3>Recent Items</h3>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Barcode</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Category</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recent-items-body">
                    </tbody>
                </table>
            </div>
            <!-- Add version info to each main tab/page -->
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Add Item Tab -->
        <div id="add-item" class="tab-content">
            <h2>Add New Item</h2>
            <form id="add-item-form">
                <div class="form-group">
                    <label for="item-name">Item Name *</label>
                    <input type="text" id="item-name" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="item-barcode">Barcode</label>
                    <div class="barcode-input-group">
                    <input type="text" id="item-barcode" class="form-control" placeholder="Scan or enter barcode">
                        <button type="button" class="barcode-scan-btn" onclick="activateScanner()" title="Scan Barcode">
                            üì∑
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="item-asset-tag">Asset Tag</label>
                    <input type="text" id="item-asset-tag" class="form-control" placeholder="Unique asset identifier (e.g., LAPTOP001)">
                </div>

                <div class="form-group">
                    <label for="item-condition">Condition</label>
                    <select id="item-condition" class="form-control">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                        <option value="Damaged">Damaged</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="item-description">Description</label>
                    <textarea id="item-description" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="item-category">Category</label>
                    <select id="item-category" class="form-control">
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Food">Food</option>
                        <option value="Tools">Tools</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="item-quantity">Quantity *</label>
                    <input type="number" id="item-quantity" class="form-control" min="0" required inputmode="numeric">
                </div>

                <div class="form-group">
                    <label for="item-price">Price ($)</label>
                    <input type="number" id="item-price" class="form-control" min="0" step="0.01" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label for="item-images">Item Images</label>
                    <input type="file" id="item-images" class="form-control" accept="image/*" multiple onchange="previewImages(this, 'add')">
                    <div id="add-image-gallery" class="image-gallery"></div>
                </div>

                <div class="form-group">
                    <label for="item-location">Location</label>
                    <input type="text" id="item-location" class="form-control" placeholder="e.g., Warehouse A, Shelf 3">
                </div>

                <div class="form-group">
                    <label for="item-min-stock">Minimum Stock Level</label>
                    <input type="number" id="item-min-stock" class="form-control" min="0" value="5">
                </div>

                <div class="form-group">
                    <label for="item-tags">Tags</label>
                    <input type="text" id="item-tags" class="form-control" placeholder="Comma-separated tags (e.g. urgent, fragile)">
                    <div id="add-tag-chips" class="tag-chips"></div>
                </div>

                <button type="submit" class="btn btn-primary">Add Item</button>
            </form>
            <!-- Add version info to each main tab/page -->
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>Inventory List</h2>
            <div class="search-box">
                <input type="text" id="inventory-search" placeholder="Search by name, barcode, or category..." onkeyup="searchInventory(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Barcode</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Category</th>
                        <th>Location</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-body">
                </tbody>
            </table>
            <!-- Add version info to each main tab/page -->
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Equipment Check-Out Tab -->
        <div id="checkout" class="tab-content">
            <h2>Equipment Check-Out</h2>
            
            <!-- USB Scanner Section -->
            <div class="scanner-section">
                <h3>üîç Scan or Enter Equipment</h3>
                <div class="form-group">
                    <label for="checkout-scanner-input">USB Scanner Ready - Scan Barcode/Asset Tag or Type Equipment ID</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" id="checkout-scanner-input" class="form-control scanner-input" 
                               placeholder="Focus here and scan barcode, or type asset tag/barcode" 
                               onkeypress="handleScannerInput(event, 'checkout')" 
                               oninput="searchEquipmentByCode('checkout')"
                               autocomplete="off"
                               style="flex:1;">
                        <button type="button" class="btn btn-primary" onclick="clearScannerInput('checkout')">Clear</button>
                    </div>
                    <div id="checkout-scanner-status" class="scanner-status"></div>
                    <div class="scanner-help">
                        üí° <strong>USB Scanner Tips:</strong> Point your USB scanner at a barcode and trigger. The equipment will be automatically selected. You can also type manually.<br>
                        ‚å®Ô∏è <strong>Shortcuts:</strong> Press F1 to quickly focus this scanner, F2 for check-in scanner, ESC to clear.
                    </div>
                </div>
            </div>

            <form id="checkout-form">
                <div class="form-group">
                    <label for="checkout-equipment">Equipment * (or use scanner above)</label>
                    <select id="checkout-equipment" class="form-control" required onchange="loadEquipmentDetails()">
                        <option value="">Select Equipment</option>
                    </select>
                </div>
                
                <div id="equipment-details" style="display:none; background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0;">
                    <h4>Equipment Details</h4>
                    <div id="equipment-info"></div>
                </div>

                <div class="form-group">
                    <label for="checkout-employee">Employee *</label>
                    <select id="checkout-employee" class="form-control" required onchange="loadEmployeeDetails()">
                        <option value="">Select Employee</option>
                    </select>
                </div>

                <div id="employee-details" style="display:none; background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0;">
                    <h4>Employee Details</h4>
                    <div id="employee-info"></div>
                </div>

                <div class="form-group">
                    <label for="checkout-condition-before">Condition (Before) *</label>
                    <select id="checkout-condition-before" class="form-control" required>
                        <option value="">Select Condition</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                        <option value="Damaged">Damaged</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="checkout-expected-return">Expected Return Date *</label>
                    <input type="date" id="checkout-expected-return" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="checkout-issued-by">Issued By</label>
                    <input type="text" id="checkout-issued-by" class="form-control" placeholder="Your name">
                </div>

                <div class="form-group">
                    <label for="checkout-notes">Notes</label>
                    <textarea id="checkout-notes" class="form-control" rows="3" placeholder="Additional notes or instructions"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Check Out Equipment</button>
            </form>

            <h3 style="margin-top:40px;">Currently Checked Out Equipment</h3>
            <div class="search-box">
                <input type="text" id="checkout-search" placeholder="Search checked out equipment..." onkeyup="searchCheckouts(this.value)">
            </div>
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Equipment</th>
                        <th>Employee</th>
                        <th>Check-Out Date</th>
                        <th>Expected Return</th>
                        <th>Days Out</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="checkout-body">
                </tbody>
            </table>
            
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Equipment Check-In Tab -->
        <div id="checkin" class="tab-content">
            <h2>Equipment Check-In</h2>
            
            <!-- USB Scanner Section -->
            <div class="scanner-section checkin">
                <h3>üì• Scan Equipment to Check In</h3>
                <div class="form-group">
                    <label for="checkin-scanner-input">USB Scanner Ready - Scan Barcode/Asset Tag or Type Equipment ID</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="text" id="checkin-scanner-input" class="form-control scanner-input checkin" 
                               placeholder="Focus here and scan barcode, or type asset tag/barcode" 
                               onkeypress="handleScannerInput(event, 'checkin')" 
                               oninput="searchEquipmentByCode('checkin')"
                               autocomplete="off"
                               style="flex:1;">
                        <button type="button" class="btn btn-success" onclick="clearScannerInput('checkin')">Clear</button>
                    </div>
                    <div id="checkin-scanner-status" class="scanner-status"></div>
                    <div class="scanner-help">
                        üí° <strong>USB Scanner Tips:</strong> Scan equipment to instantly open the check-in form. The system will automatically find who has it checked out.<br>
                        ‚å®Ô∏è <strong>Shortcuts:</strong> Press F2 to quickly focus this scanner, F1 for check-out scanner, ESC to clear.
                    </div>
                </div>
            </div>
            
            <div class="search-box">
                <input type="text" id="checkin-search" placeholder="Search by equipment name, employee, or transaction ID..." onkeyup="searchCheckinsAvailable(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Equipment</th>
                        <th>Employee</th>
                        <th>Check-Out Date</th>
                        <th>Expected Return</th>
                        <th>Days Out</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="checkin-available-body">
                </tbody>
            </table>
            
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Employees Tab -->
        <div id="employees" class="tab-content">
            <h2>Employee Management</h2>
            <button class="btn btn-primary" onclick="showAddEmployeeModal()" style="margin-bottom:20px;">Add New Employee</button>
            
            <div class="search-box">
                <input type="text" id="employee-search" placeholder="Search employees..." onkeyup="searchEmployees(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Employee ID</th>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Job Title</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Equipment Out</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employees-body">
                </tbody>
            </table>
            
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Equipment History Tab -->
        <div id="equipment-history" class="tab-content">
            <h2>Equipment History</h2>
            
            <div class="form-group" style="max-width:300px;">
                <label for="equipment-filter">Filter by Equipment</label>
                <select id="equipment-filter" class="form-control" onchange="filterEquipmentHistory()">
                    <option value="">All Equipment</option>
                </select>
            </div>
            
            <div class="search-box">
                <input type="text" id="equipment-history-search" placeholder="Search equipment history..." onkeyup="searchEquipmentHistory(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Equipment</th>
                        <th>Asset Tag</th>
                        <th>Employee</th>
                        <th>Check-Out Date</th>
                        <th>Return Date</th>
                        <th>Duration</th>
                        <th>Condition Before</th>
                        <th>Condition After</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="equipment-history-body">
                </tbody>
            </table>
            
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Employee History Tab -->
        <div id="employee-history" class="tab-content">
            <h2>Employee Checkout History</h2>
            
            <div class="form-group" style="max-width:300px;">
                <label for="employee-filter">Filter by Employee</label>
                <select id="employee-filter" class="form-control" onchange="filterEmployeeHistory()">
                    <option value="">All Employees</option>
                </select>
            </div>
            
            <div class="search-box">
                <input type="text" id="employee-history-search" placeholder="Search employee history..." onkeyup="searchEmployeeHistory(this.value)">
            </div>
            
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Transaction ID</th>
                        <th>Employee</th>
                        <th>Equipment</th>
                        <th>Check-Out Date</th>
                        <th>Return Date</th>
                        <th>Duration</th>
                        <th>Condition Before</th>
                        <th>Condition After</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employee-history-body">
                </tbody>
            </table>
            
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Generate Reports</h2>
            <div class="report-options">
                <div class="checkbox-group">
                    <input type="checkbox" id="include-images" checked>
                    <label for="include-images">Include Images</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-barcodes" checked>
                    <label for="include-barcodes">Include Barcodes</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-prices" checked>
                    <label for="include-prices">Include Prices</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="include-locations" checked>
                    <label for="include-locations">Include Locations</label>
                </div>
            </div>

            <div class="form-group">
                <label for="report-type">Report Type</label>
                <select id="report-type" class="form-control">
                    <option value="all">All Items</option>
                    <option value="low-stock">Low Stock Items</option>
                    <option value="category">By Category</option>
                    <option value="value">High Value Items</option>
                </select>
            </div>

            <div class="form-group" id="category-filter" style="display: none;">
                <label for="report-category">Category</label>
                <select id="report-category" class="form-control">
                </select>
            </div>

            <button class="btn btn-primary" onclick="generateReport()">Generate PDF Report</button>
            <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
            <!-- Add version info to each main tab/page -->
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>User Settings</h2>
            
            <div class="settings-section">
                <h3>üë§ Account Information</h3>
                <div class="form-group">
                    <label for="current-username">Current Username</label>
                    <input type="text" id="current-username" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label for="user-email">Email Address</label>
                    <input type="email" id="user-email" class="form-control" placeholder="Enter your email" inputmode="email">
                </div>
                <div class="form-group">
                    <label for="user-fullname">Full Name</label>
                    <input type="text" id="user-fullname" class="form-control" placeholder="Enter your full name">
                </div>
            </div>

            <div class="settings-section">
                <h3>üîê Change Password</h3>
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" class="form-control" placeholder="Confirm new password">
                </div>
                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>

            <div class="settings-section">
                <h3>üé® Appearance</h3>
                <div class="form-group">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select" class="form-control" onchange="changeTheme(this.value)">
                        <option value="default">Default Theme</option>
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="language-select">Language</label>
                    <select id="language-select" class="form-control">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>üìä System Preferences</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="auto-logout" checked>
                    <label for="auto-logout">Auto-logout after 24 hours</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="notifications" checked>
                    <label for="notifications">Show notifications</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="low-stock-alerts" checked>
                    <label for="low-stock-alerts">Low stock alerts</label>
                </div>
            </div>

            <div class="settings-section">
                <h3>üíæ Data Management</h3>
                <button class="btn btn-success" onclick="exportUserData()">Export Complete Data</button>
                <button class="btn btn-warning" onclick="importUserData()">Import Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
            </div>

            <div class="settings-section">
                <h3>üì± Multi-Device Setup</h3>
                <p><strong>To use on another device:</strong></p>
                <ol style="text-align: left; margin: 10px 0;">
                    <li>Export complete data from this device</li>
                    <li>Open inventory system on new device</li>
                    <li>Import the backup file</li>
                    <li>Login with your existing credentials</li>
                </ol>
                <button class="btn btn-primary" onclick="exportUserData()">Create Device Backup</button>
            </div>

            <div class="settings-section" id="team-management-section" style="display:none;">
                <h3>üë• Team Management</h3>
                <div style="margin-bottom:20px;">
                    <button class="btn btn-success" onclick="showInviteUserModal()">Invite Team Member</button>
                    <button class="btn btn-primary" onclick="loadTeamMembers()">Refresh Team List</button>
                </div>
                
                <h4>Current Team Members</h4>
                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="team-members-body">
                    </tbody>
                </table>
            </div>

            <div class="settings-section">
                <h3>‚ÑπÔ∏è About</h3>
                <p><strong>Version:</strong> 1.0.0</p>
                <p><strong>Company:</strong> <span id="current-company">Loading...</span></p>
                <p><strong>Your Role:</strong> <span id="current-role">Loading...</span></p>
                <p><strong>Last Login:</strong> <span id="last-login">Never</span></p>
                <p><strong>Total Items:</strong> <span id="total-items-settings">0</span></p>
                <p><strong>Account Created:</strong> <span id="account-created">Unknown</span></p>
            </div>

            <!-- In the Settings Tab, add a Manage Categories section -->
            <div class="settings-section">
                <h3>üìÇ Manage Categories</h3>
                <ul id="category-list"></ul>
                <div style="display:flex;gap:8px;margin-top:10px;">
                    <input type="text" id="new-category-input" class="form-control" placeholder="Add new category">
                    <button class="btn btn-success" onclick="addCategory()">Add</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>üé® Branding</h3>
                <div class="form-group">
                    <label for="branding-logo">Logo</label>
                    <input type="file" id="branding-logo" class="form-control" accept="image/*" onchange="previewBrandingLogo(this)">
                    <img id="branding-logo-preview" style="max-width:120px;display:none;">
                </div>
                <div class="form-group">
                    <label for="branding-color">Theme Color</label>
                    <input type="color" id="branding-color" class="form-control" value="#667eea" onchange="applyThemeColor(this.value)">
                </div>
                <button class="btn btn-primary" onclick="saveBranding()">Save Branding</button>
            </div>

            <!-- Update TSV Import Modal in Settings -->
            <div id="tsv-import-modal" class="modal">
              <div class="modal-content">
                <span class="close" onclick="closeTSVImport()">&times;</span>
                <h2>Import Items (TSV Paste)</h2>
                <p>Paste your TSV data below. Each line should be:<br>
                <code>Name [tab] Barcode [tab] Description [tab] Category [tab] Quantity [tab] Price [tab] Location [tab] MinStock [tab] Tags (comma-separated)</code></p>
                <div style="margin-bottom:10px;">
                  <button class="btn btn-secondary" onclick="downloadTSVTemplate()">Download TSV Template</button>
                  <button class="btn btn-success" onclick="exportInventoryTSV()">Export Inventory as TSV</button>
                </div>
                <textarea id="tsv-import-textarea" class="form-control" rows="8" style="width:100%;font-family:monospace;"></textarea>
                <button class="btn btn-primary" onclick="importTSVItems()">Import</button>
                <div id="tsv-import-summary" style="margin-top:10px;"></div>
              </div>
            </div>

            <!-- Add Import TSV button to Settings tab -->
            <div class="settings-section">
              <h3>üì• Quick Import</h3>
              <button class="btn btn-success" onclick="showTSVImport()">Import Items (TSV Paste)</button>
            </div>
            <!-- Add version info to each main tab/page -->
            <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
              Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div id="scanner-modal" class="modal">
        <div class="modal-content scanner-modal-content">
            <span class="close" onclick="closeScannerModal()">&times;</span>
            <h2>üì∑ Scan Barcode</h2>
            <div class="scanner-container">
                <div class="scanner-frame">
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay">
                        <div class="scanner-target"></div>
                        <div class="scanner-instructions">
                            <p>üì± Point camera at barcode or QR code</p>
                            <p>üì∑ Hold steady for best results</p>
                        </div>
                    </div>
                </div>
                <div class="scanner-status">
                    <p id="scanner-status-text">Ready to scan</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2>Edit Item</h2>
            <form id="edit-item-form">
                <input type="hidden" id="edit-item-id">
                <div class="form-group">
                    <label for="edit-item-name">Item Name</label>
                    <input type="text" id="edit-item-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-item-barcode">Barcode</label>
                    <input type="text" id="edit-item-barcode" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="edit-item-asset-tag">Asset Tag</label>
                    <input type="text" id="edit-item-asset-tag" class="form-control">
                </div>

                <div class="form-group">
                    <label for="edit-item-condition">Condition</label>
                    <select id="edit-item-condition" class="form-control">
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                        <option value="Damaged">Damaged</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-item-description">Description</label>
                    <textarea id="edit-item-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-item-category">Category</label>
                    <select id="edit-item-category" class="form-control">
                        <option value="">Select Category</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Books">Books</option>
                        <option value="Food">Food</option>
                        <option value="Tools">Tools</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-item-quantity">Quantity</label>
                    <input type="number" id="edit-item-quantity" class="form-control" min="0" required inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="edit-item-price">Price ($)</label>
                    <input type="number" id="edit-item-price" class="form-control" min="0" step="0.01" inputmode="decimal">
                </div>
                <div class="form-group">
                    <label for="edit-item-images">Item Images</label>
                    <input type="file" id="edit-item-images" class="form-control" accept="image/*" multiple onchange="previewImages(this, 'edit')">
                    <div id="edit-image-gallery" class="image-gallery"></div>
                </div>
                <div class="form-group">
                    <label for="edit-item-location">Location</label>
                    <input type="text" id="edit-item-location" class="form-control" placeholder="e.g., Warehouse A, Shelf 3">
                </div>
                <div class="form-group">
                    <label for="edit-item-min-stock">Minimum Stock Level</label>
                    <input type="number" id="edit-item-min-stock" class="form-control" min="0" value="5" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label for="edit-item-tags">Tags</label>
                    <input type="text" id="edit-item-tags" class="form-control" placeholder="Comma-separated tags (e.g. urgent, fragile)">
                    <div id="edit-tag-chips" class="tag-chips"></div>
                </div>
                <button type="submit" class="btn btn-primary">Update Item</button>
            </form>
        </div>
    </div>

    <!-- Add Admin Dashboard -->
    <div id="admin-dashboard" class="container hidden">
      <button class="logout-btn" onclick="logoutAdmin()">üö™ Logout</button>
      <button class="logout-btn" onclick="returnToMainApp()" style="right:120px; background: rgba(40, 167, 69, 0.9);">‚Ü©Ô∏è Back to Main App</button>
      <div class="header">
        <h1>üë§ Admin User Management</h1>
        <p>View all signed up users</p>
      </div>
      <table class="inventory-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Created</th>
            <th>Last IP</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="admin-users-body"></tbody>
      </table>
      <!-- Add version info to each main tab/page -->
      <div class="version-info" style="text-align:center; color:#888; font-size:0.95em; margin-top:30px;">
        Version: 1.0.0 &mdash; Commit: <span class="version-commit">abcdef0</span> &mdash; Updated: <span class="version-date"></span>
      </div>
    </div>
    <!-- User Details Modal -->
    <div id="user-details-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeUserDetails()">&times;</span>
        <h2>User Details</h2>
        <div id="user-details-content"></div>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="add-employee-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddEmployeeModal()">&times;</span>
            <h2>Add New Employee</h2>
            <form id="add-employee-form">
                <div class="form-group">
                    <label for="employee-id">Employee ID *</label>
                    <input type="text" id="employee-id" class="form-control" required placeholder="e.g., EMP001">
                </div>
                <div class="form-group">
                    <label for="employee-name">Full Name *</label>
                    <input type="text" id="employee-name" class="form-control" required placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="employee-email">Email</label>
                    <input type="email" id="employee-email" class="form-control" placeholder="john.doe@company.com">
                </div>
                <div class="form-group">
                    <label for="employee-phone">Phone</label>
                    <input type="tel" id="employee-phone" class="form-control" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label for="employee-department">Department *</label>
                    <select id="employee-department" class="form-control" required>
                        <option value="">Select Department</option>
                        <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Operations">Operations</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Sales">Sales</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="employee-job-title">Job Title *</label>
                    <input type="text" id="employee-job-title" class="form-control" required placeholder="Software Developer">
                </div>
                <div class="form-group">
                    <label for="employee-status">Status</label>
                    <select id="employee-status" class="form-control">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="On Leave">On Leave</option>
                        <option value="Terminated">Terminated</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add Employee</button>
            </form>
        </div>
    </div>

    <!-- Edit Employee Modal -->
    <div id="edit-employee-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditEmployeeModal()">&times;</span>
            <h2>Edit Employee</h2>
            <form id="edit-employee-form">
                <input type="hidden" id="edit-employee-doc-id">
                <div class="form-group">
                    <label for="edit-employee-id">Employee ID *</label>
                    <input type="text" id="edit-employee-id" class="form-control" required readonly>
                </div>
                <div class="form-group">
                    <label for="edit-employee-name">Full Name *</label>
                    <input type="text" id="edit-employee-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-employee-email">Email</label>
                    <input type="email" id="edit-employee-email" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-employee-phone">Phone</label>
                    <input type="tel" id="edit-employee-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="edit-employee-department">Department *</label>
                    <select id="edit-employee-department" class="form-control" required>
                        <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Operations">Operations</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Sales">Sales</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-employee-job-title">Job Title *</label>
                    <input type="text" id="edit-employee-job-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit-employee-status">Status</label>
                    <select id="edit-employee-status" class="form-control">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="On Leave">On Leave</option>
                        <option value="Terminated">Terminated</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Update Employee</button>
            </form>
        </div>
    </div>

    <!-- Check-In Modal -->
    <div id="checkin-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeCheckinModal()">&times;</span>
            <h2>Check-In Equipment</h2>
            <form id="checkin-form">
                <input type="hidden" id="checkin-transaction-id">
                
                <div id="checkin-transaction-details" style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <h4>Transaction Details</h4>
                    <div id="checkin-details-content"></div>
                </div>

                <div class="form-group">
                    <label for="checkin-condition-after">Condition (After) *</label>
                    <select id="checkin-condition-after" class="form-control" required>
                        <option value="">Select Condition</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                        <option value="Damaged">Damaged</option>
                        <option value="Lost">Lost</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="checkin-returned-by">Returned By</label>
                    <input type="text" id="checkin-returned-by" class="form-control" placeholder="Your name">
                </div>

                <div class="form-group">
                    <label for="checkin-return-notes">Return Notes</label>
                    <textarea id="checkin-return-notes" class="form-control" rows="3" placeholder="Any issues, damage, or comments"></textarea>
                </div>

                <div class="form-group" id="replacement-cost-group" style="display:none;">
                    <label for="checkin-replacement-cost">Replacement Cost ($)</label>
                    <input type="number" id="checkin-replacement-cost" class="form-control" min="0" step="0.01" placeholder="0.00">
                </div>

                <button type="submit" class="btn btn-primary">Check In Equipment</button>
            </form>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div id="transaction-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTransactionDetails()">&times;</span>
            <h2>Transaction Details</h2>
            <div id="transaction-details-content"></div>
        </div>
    </div>

    <!-- Lost/Damaged Equipment Report Modal -->
    <div id="lost-damaged-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLostDamagedModal()">&times;</span>
            <h2>Lost/Damaged Equipment Report</h2>
            <form id="lost-damaged-form">
                <input type="hidden" id="report-transaction-id">
                
                <div id="report-equipment-details" style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <h4>Equipment Details</h4>
                    <div id="report-equipment-content"></div>
                </div>

                <div class="form-group">
                    <label for="report-type">Report Type *</label>
                    <select id="report-type" class="form-control" required>
                        <option value="">Select Type</option>
                        <option value="Lost">Lost Equipment</option>
                        <option value="Damaged">Damaged Equipment</option>
                        <option value="Stolen">Stolen Equipment</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="report-description">Description *</label>
                    <textarea id="report-description" class="form-control" rows="4" required placeholder="Describe what happened, when it was discovered, circumstances, etc."></textarea>
                </div>

                <div class="form-group">
                    <label for="report-date-discovered">Date Discovered</label>
                    <input type="date" id="report-date-discovered" class="form-control">
                </div>

                <div class="form-group">
                    <label for="report-replacement-cost">Estimated Replacement Cost ($) *</label>
                    <input type="number" id="report-replacement-cost" class="form-control" min="0" step="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="report-action-taken">Action Taken</label>
                    <textarea id="report-action-taken" class="form-control" rows="3" placeholder="What actions have been taken? Police report filed? Insurance claim? etc."></textarea>
                </div>

                <div class="form-group">
                    <label for="report-reported-by">Reported By</label>
                    <input type="text" id="report-reported-by" class="form-control" placeholder="Your name">
                </div>

                <button type="submit" class="btn btn-danger">Submit Report</button>
            </form>
        </div>
    </div>

    <!-- Invite User Modal -->
    <div id="invite-user-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInviteUserModal()">&times;</span>
            <h2>Invite Team Member</h2>
            <form id="invite-user-form">
                <div class="form-group">
                    <label for="invite-email">Email Address *</label>
                    <input type="email" id="invite-email" class="form-control" required placeholder="colleague@company.com">
                </div>

                <div class="form-group">
                    <label for="invite-full-name">Full Name *</label>
                    <input type="text" id="invite-full-name" class="form-control" required placeholder="John Doe">
                </div>

                <div class="form-group">
                    <label for="invite-role">Role *</label>
                    <select id="invite-role" class="form-control" required onchange="showRoleDescription()">
                        <option value="">Select Role</option>
                        <option value="admin">Admin - Full access to everything</option>
                        <option value="manager">Manager - Inventory, equipment, employees, reports</option>
                        <option value="employee">Employee - Check-in/out equipment, view own history</option>
                        <option value="viewer">Viewer - Read-only access to inventory and reports</option>
                    </select>
                </div>

                <div id="role-description" style="background:#f8f9fa; padding:10px; border-radius:5px; margin:10px 0; display:none;">
                    <h4>Role Permissions:</h4>
                    <div id="role-permissions-list"></div>
                </div>

                <div class="form-group">
                    <label for="invite-temporary-password">Temporary Password *</label>
                    <input type="password" id="invite-temporary-password" class="form-control" required placeholder="Temporary password (they'll change it on first login)">
                </div>

                <div class="form-group">
                    <label for="invite-message">Welcome Message (Optional)</label>
                    <textarea id="invite-message" class="form-control" rows="3" placeholder="Welcome to our inventory management system!"></textarea>
                </div>

                <button type="submit" class="btn btn-success">Send Invitation</button>
            </form>
        </div>
    </div>

    <script>
        // Authentication variables
        let isAuthenticated = false;
        let currentUser = null;
        let currentUserData = null;
        let currentCompany = null;
        let inventory = [];
        let scanner = null;
        let stream = null;
        // Add global permission variables
        let isAdmin = false;
        let userRole = 'viewer'; // admin, manager, employee, viewer
        let userPermissions = {};

        // Equipment management variables
        let employees = [];
        let transactions = [];
        let lostDamagedReports = [];

        // Permission levels and their capabilities
        const ROLES = {
            admin: {
                name: 'Admin',
                permissions: ['all']
            },
            manager: {
                name: 'Manager', 
                permissions: ['inventory.manage', 'equipment.manage', 'employees.manage', 'reports.view', 'transactions.manage']
            },
            employee: {
                name: 'Employee',
                permissions: ['equipment.checkout', 'equipment.checkin', 'reports.own', 'inventory.view']
            },
            viewer: {
                name: 'Viewer',
                permissions: ['inventory.view', 'reports.view', 'transactions.view']
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set up Firebase Auth state listener
            window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                if (user) {
                    // User is signed in
                    const email = user.email;
                    
                    // Get user profile from Firestore
                    const usersRef = window.firebase.collection(window.firebase.db, 'users');
                    const q = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
                    const querySnapshot = await window.firebase.getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const userDoc = querySnapshot.docs[0];
                        const userData = userDoc.data();
                        
                        isAuthenticated = true;
                        currentUser = userData.username;
                        isAdmin = userData.username === 'admin';
                        await showMainApp();
                    }
            } else {
                    // User is signed out
                    checkAuthentication();
                }
            });
            
            setupAuthEventListeners();
        });

        function checkAuthentication() {
            // Firebase Auth state listener will handle authentication
            // This function now just sets up the initial UI state
            showLoginScreen();
        }

        function setupAuthEventListeners() {
            // Login form
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                    console.log('Login form submitted');
                    try {
                login();
                    } catch (err) {
                        console.error('Login handler error:', err);
                        showLoginError('A critical error occurred. See console for details.');
                    }
            });
            }

            // Setup form
            const setupForm = document.getElementById('setup-form');
            console.log('Setup form found:', !!setupForm); // Debug log
            if (setupForm) {
                setupForm.addEventListener('submit', function(e) {
                e.preventDefault();
                    console.log('Signup form submitted');
                    try {
                setupCredentials();
                    } catch (err) {
                        console.error('Signup handler error:', err);
                        showAlert('A critical error occurred. See console for details.', 'error');
                    }
                });
                console.log('Setup form event listener attached'); // Debug log
            } else {
                console.error('Setup form not found!'); // Debug log
            }

            // Add event listener for password reset button
            const resetBtn = document.querySelector('#forgot-step-1 .btn.btn-primary');
            if (resetBtn) {
                resetBtn.onclick = function(e) {
                    e.preventDefault();
                    sendPasswordReset();
                };
            }
        }

        async function setupCredentials() {
            console.log('setupCredentials called'); // Debug log
            
            // Show loading state
            const submitBtn = document.querySelector('#setup-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;
            
            try {
                const companyName = document.getElementById('setup-company-name').value.trim();
                const username = document.getElementById('setup-username').value.trim();
                const email = document.getElementById('setup-email').value.trim().toLowerCase();
                const fullName = document.getElementById('setup-full-name').value.trim();
                const password = document.getElementById('setup-password').value;
                const confirmPassword = document.getElementById('setup-confirm-password').value;
                
                console.log('Form values:', { companyName, username, email, fullName, password: '***' }); // Debug log
                
                // Check if Firebase is available
                if (!window.firebase || !window.firebase.auth || !window.firebase.db) {
                    throw new Error('Firebase is not properly initialized. Please refresh the page.');
                }
                
            if (!companyName) {
                showAlert('Please enter a company name!', 'error');
                throw new Error('Company name required');
            }
            if (!username) {
                showAlert('Please enter a username!', 'error');
                throw new Error('Username required');
            }
            if (!fullName) {
                showAlert('Please enter your full name!', 'error');
                throw new Error('Full name required');
            }
            if (password !== confirmPassword) {
                showAlert('Passwords do not match!', 'error');
                throw new Error('Passwords do not match');
            }
            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long!', 'error');
                throw new Error('Password too short');
            }
            if (!email || !email.includes('@')) {
                showAlert('Please enter a valid email address!', 'error');
                throw new Error('Invalid email');
            }
            // Check for duplicate username or email
            const usersRef = window.firebase.collection(window.firebase.db, 'users');
            // Check username
            const qUsername = window.firebase.query(usersRef, window.firebase.where('username', '==', username));
            const usernameSnapshot = await window.firebase.getDocs(qUsername);
            if (!usernameSnapshot.empty) {
                showAlert('Username is already taken. Please choose another.', 'error');
                throw new Error('Username already taken');
            }
            // Check email
            const qEmail = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
            const emailSnapshot = await window.firebase.getDocs(qEmail);
            if (!emailSnapshot.empty) {
                showAlert('Email is already registered. Please use another or log in.', 'error');
                throw new Error('Email already registered');
            }
            try {
                // Create Firebase user account with real email
                const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                const user = userCredential.user;
                // Get IP
                const ip = await getPublicIP();
                
                // First create the company
                const companyData = {
                    name: companyName,
                    created: new Date().toISOString(),
                    createdBy: email,
                    status: 'active',
                    plan: 'basic'
                };
                const companyRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'companies'), companyData);
                const companyId = companyRef.id;
                
                // Store user profile in Firestore with company and admin role
                const userProfile = {
                    username: username,
                    email: email,
                    fullName: fullName,
                    companyId: companyId,
                    companyName: companyName,
                    role: 'admin',
                    permissions: ROLES.admin.permissions,
                    status: 'active',
                    created: new Date().toISOString(),
                    lastIP: ip
                };
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'users'), userProfile);
                
                sendSignupEmail(username, password);
                isAuthenticated = true;
                currentUser = username;
                currentUserData = userProfile;
                currentCompany = companyId;
                userRole = 'admin';
                isAdmin = true;
                userPermissions = ROLES.admin.permissions;
                
                await showMainApp();
                showAlert('Company account created successfully! Welcome to your inventory system.', 'success');
            } catch (error) {
                console.error('Error creating account:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showAlert('Email already exists. Please use a different email.', 'error');
                } else {
                    showAlert('Error creating account: ' + error.message, 'error');
                }
            }
            
            } catch (outerError) {
                console.error('Setup credentials error:', outerError);
                showAlert('An unexpected error occurred: ' + outerError.message, 'error');
            } finally {
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            if (!email || !email.includes('@')) {
                showLoginError('Please enter your full email address, not your username.');
                return;
            }
            try {
                const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                const user = userCredential.user;
                // Get user profile from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
                const querySnapshot = await window.firebase.getDocs(q);
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    // Check if user account is active
                    if (userData.status === 'inactive') {
                        showLoginError('Your account has been deactivated. Please contact your administrator.');
                        return;
                    }
                    
                    isAuthenticated = true;
                    currentUser = userData.username;
                    currentUserData = userData;
                    currentCompany = userData.companyId;
                    userRole = userData.role || 'viewer';
                    isAdmin = userData.role === 'admin';
                    userPermissions = userData.permissions || ROLES[userRole]?.permissions || [];
                    
                    // Save IP
                    const ip = await getPublicIP();
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), { lastIP: ip });
                    // Create session
                    const session = {
                        username: userData.username,
                        role: userData.role,
                        companyId: userData.companyId,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('inventory_session', JSON.stringify(session));
                    await showMainApp();
                    showAlert(`Welcome back, ${userData.fullName || userData.username}!`, 'success');
                } else {
                    showLoginError('User profile not found!');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/user-not-found') {
                    showLoginError('Account not found. Please set up your account first.');
                } else if (error.code === 'auth/wrong-password') {
                    showLoginError('Invalid email or password!');
                } else {
                    showLoginError('Login error: ' + error.message);
                }
            }
        }

        async function logout() {
            try {
                await window.firebase.signOut(window.firebase.auth);
            isAuthenticated = false;
            currentUser = null;
            localStorage.removeItem('inventory_session');
            showLoginScreen();
            showAlert('Logged out successfully!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showAlert('Error during logout: ' + error.message, 'error');
            }
        }

        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'block';
            document.getElementById('main-app').style.display = 'none';
        }

        async function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            setupEventListeners();
            updateNavigationForRole();
            await loadInventory();
            await loadEmployees();
            await loadTransactions();
            await loadLostDamagedReports();
            updateDashboard();
            loadInventoryTable();
            loadEmployeesTable();
            loadCheckoutOptions();
            loadCheckoutTable();
            loadCheckinTable();
            loadEquipmentHistory();
            loadEmployeeHistory();
            await loadUserSettings();
            await loadCategoriesFromFirestore();
            updateAdminTab();
            updateUserInterface();
        }

        async function loadInventory() {
            try {
                const inventoryRef = window.firebase.collection(window.firebase.db, 'inventory');
                const q = window.firebase.query(inventoryRef, window.firebase.where('companyId', '==', currentCompany));
                const querySnapshot = await window.firebase.getDocs(q);
                inventory = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading inventory:', error);
                showAlert('Error loading inventory: ' + error.message, 'error');
            }
        }

        // Prevent duplicate event listeners
        let eventListenersSetup = false;
        function setupEventListeners() {
          if (!eventListenersSetup) {
            const addForm = document.getElementById('add-item-form');
            if (addForm) {
              addForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addItem();
            });
            }

            // Equipment management event listeners
            const addEmployeeForm = document.getElementById('add-employee-form');
            if (addEmployeeForm) {
                addEmployeeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addEmployee();
                });
            }

            const editEmployeeForm = document.getElementById('edit-employee-form');
            if (editEmployeeForm) {
                editEmployeeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateEmployee();
                });
            }

            const checkoutForm = document.getElementById('checkout-form');
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    checkoutEquipment();
                });
            }

            const checkinForm = document.getElementById('checkin-form');
            if (checkinForm) {
                checkinForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    checkinEquipment();
                });
            }

            const lostDamagedForm = document.getElementById('lost-damaged-form');
            if (lostDamagedForm) {
                lostDamagedForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitLostDamagedReport();
                });
            }

            const inviteUserForm = document.getElementById('invite-user-form');
            if (inviteUserForm) {
                inviteUserForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    inviteUser();
                });
            }

            eventListenersSetup = true;
          }
          // Always (re)attach edit form listener
          const editForm = document.getElementById('edit-item-form');
          if (editForm) {
            editForm.onsubmit = function(e) {
                e.preventDefault();
                updateItem();
            };
          }
          const reportType = document.getElementById('report-type');
          if (reportType) {
            reportType.addEventListener('change', function() {
                const categoryFilter = document.getElementById('category-filter');
                if (this.value === 'category') {
                    categoryFilter.style.display = 'block';
                    loadCategories();
                } else {
                    categoryFilter.style.display = 'none';
                }
            });
          }
          const userEmail = document.getElementById('user-email');
          if (userEmail) userEmail.addEventListener('blur', saveUserProfile);
          const userFullname = document.getElementById('user-fullname');
          if (userFullname) userFullname.addEventListener('blur', saveUserProfile);
          const autoLogout = document.getElementById('auto-logout');
          if (autoLogout) autoLogout.addEventListener('change', savePreferences);
          const notifications = document.getElementById('notifications');
          if (notifications) notifications.addEventListener('change', savePreferences);
          const lowStockAlerts = document.getElementById('low-stock-alerts');
          if (lowStockAlerts) lowStockAlerts.addEventListener('change', savePreferences);
        }

        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Update dashboard if showing dashboard tab
            if (tabName === 'dashboard') {
                updateDashboard();
            }

            // Auto-focus scanner inputs when switching to checkout/checkin tabs
            if (tabName === 'checkout') {
                focusScannerInput('checkout');
            } else if (tabName === 'checkin') {
                focusScannerInput('checkin');
            }
        }

        // Utility: Resize and compress image to fit under 1MB
        async function resizeAndCompressImage(file, maxSize = 1048487, maxDim = 800) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.onload = function() {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxDim || height > maxDim) {
                            if (width > height) {
                                height = Math.round(height * (maxDim / width));
                                width = maxDim;
                            } else {
                                width = Math.round(width * (maxDim / height));
                                height = maxDim;
                            }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Try compressing to JPEG, then PNG if needed
                        let quality = 0.8;
                        let dataUrl = canvas.toDataURL('image/jpeg', quality);
                        while (dataUrl.length > maxSize * 1.37 && quality > 0.3) { // base64 is ~1.37x larger
                            quality -= 0.1;
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                        }
                        if (dataUrl.length > maxSize * 1.37) {
                            // Try PNG as fallback
                            dataUrl = canvas.toDataURL('image/png');
                        }
                        if (dataUrl.length > maxSize * 1.37) {
                            reject('Image is too large even after resizing/compression. Please choose a smaller image.');
                        } else {
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = function() { reject('Invalid image file.'); };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function addItem() {
            if (!checkPermission('inventory.manage', 'You do not have permission to add inventory items.')) return;
            
            const name = document.getElementById('item-name').value;
            const barcode = document.getElementById('item-barcode').value;
            const description = document.getElementById('item-description').value;
            const category = document.getElementById('item-category').value;
            const quantity = parseInt(document.getElementById('item-quantity').value);
            const price = parseFloat(document.getElementById('item-price').value) || 0;
            const location = document.getElementById('item-location').value;
            const minStock = parseInt(document.getElementById('item-min-stock').value) || 5;

            // Get image data
            const imageFiles = window.addImageFiles || document.getElementById('item-images').files;
            let imageData = [];
            const MAX_IMAGES = 3;
            const MAX_TOTAL_SIZE = 1048487; // 1MB
            if (imageFiles.length > MAX_IMAGES) {
                showAlert(`You can only upload up to ${MAX_IMAGES} images per item.`, 'error');
                return;
            }
            if (imageFiles.length > 0) {
                let processed = 0;
                let errored = false;
                for (let i = 0; i < imageFiles.length; i++) {
                    resizeAndCompressImage(imageFiles[i]).then(dataUrl => {
                        imageData[i] = dataUrl;
                        processed++;
                        // Check total size after all images processed
                        if (processed === imageFiles.length && !errored) {
                            const totalSize = imageData.reduce((sum, img) => sum + (img.length || 0), 0);
                            if (totalSize > MAX_TOTAL_SIZE) {
                                showAlert('Total image size exceeds 1MB. Please use fewer or smaller images.', 'error');
                                return;
                            }
                    saveItem(name, barcode, description, category, quantity, price, location, minStock, imageData);
                        }
                    }).catch(err => {
                        errored = true;
                        showAlert(err, 'error');
                    });
                }
            } else {
                saveItem(name, barcode, description, category, quantity, price, location, minStock, null);
            }
        }

        async function saveItem(name, barcode, description, category, quantity, price, location, minStock, imageData) {
            try {
            const assetTag = document.getElementById('item-asset-tag').value;
            const condition = document.getElementById('item-condition').value || 'Good';
            
            const item = {
                    userId: currentUser,
                    companyId: currentCompany,
                name: name,
                barcode: barcode,
                assetTag: assetTag,
                description: description,
                category: category,
                quantity: quantity,
                price: price,
                location: location,
                minStock: minStock,
                condition: condition,
                image: imageData,
                dateAdded: new Date().toISOString()
            };

                // Save to Firestore
                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), item);
                item.id = docRef.id; // Use Firestore document ID

            inventory.push(item);

            // Reset form
            document.getElementById('add-item-form').reset();
                document.getElementById('add-image-gallery').innerHTML = '';

            // Show success message
            showAlert('Item added successfully!', 'success');

            // Update displays
            updateDashboard();
            loadInventoryTable();
            } catch (error) {
                console.error('Error saving item:', error);
                showAlert('Error saving item: ' + error.message, 'error');
            }
        }

        function loadInventoryTable() {
            const tbody = document.getElementById('inventory-body');
            const recentTbody = document.getElementById('recent-items-body');
            
            tbody.innerHTML = '';
            recentTbody.innerHTML = '';

            inventory.forEach(item => {
                const row = createInventoryRow(item);
                tbody.appendChild(row);

                // Add to recent items (last 5)
                if (recentTbody.children.length < 5) {
                    const recentRow = createInventoryRow(item);
                    recentTbody.appendChild(recentRow);
                }
            });
        }

        function createInventoryRow(item) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    ${item.image ? `<img src="${item.image}" class="item-image" alt="${item.name}">` : 'üì¶'}
                </td>
                <td>${item.name}</td>
                <td><span class="barcode">${item.barcode || 'N/A'}</span></td>
                <td>
                    <span style="color: ${item.quantity <= item.minStock ? '#dc3545' : '#28a745'}">
                        ${item.quantity}
                    </span>
                </td>
                <td>$${item.price.toFixed(2)}</td>
                <td>${item.category || 'Uncategorized'}</td>
                <td>${item.location || 'N/A'}</td>
                <td>
                    <button class="btn btn-warning" onclick="editItem('${item.id}')" style="padding: 12px 12px; margin: 2px; min-width:44px; min-height:44px;" aria-label="Edit item" title="Edit Item">‚úèÔ∏è</button>
                    <button class="btn btn-danger" onclick="deleteItem('${item.id}')" style="padding: 12px 12px; margin: 2px; min-width:44px; min-height:44px;" aria-label="Delete item" title="Delete Item">üóëÔ∏è</button>
                    <button class="btn btn-primary" onclick="generateLabel('${item.id}')" style="padding: 12px 12px; margin: 2px; min-width:44px; min-height:44px;" aria-label="Generate label" title="Generate Label">üè∑Ô∏è</button>
                </td>
            `;
            return row;
        }

        function updateDashboard() {
            const totalItems = inventory.length;
            const lowStock = inventory.filter(item => item.quantity <= item.minStock).length;
            const totalValue = inventory.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const categories = new Set(inventory.map(item => item.category).filter(cat => cat)).size;

            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('low-stock').textContent = lowStock;
            document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('categories').textContent = categories;
        }

        function searchInventory(query) {
            const rows = document.querySelectorAll('#inventory-body tr, #recent-items-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function editItem(id) {
            const item = inventory.find(item => item.id === id);
            if (!item) {
                showAlert('Item not found for editing!', 'error');
                return;
            }
            document.getElementById('edit-item-id').value = item.id;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-barcode').value = item.barcode || '';
            document.getElementById('edit-item-asset-tag').value = item.assetTag || '';
            document.getElementById('edit-item-condition').value = item.condition || 'Good';
            document.getElementById('edit-item-description').value = item.description || '';
            document.getElementById('edit-item-category').value = item.category || '';
            document.getElementById('edit-item-quantity').value = item.quantity;
            document.getElementById('edit-item-price').value = item.price;
            document.getElementById('edit-item-location').value = item.location || '';
            document.getElementById('edit-item-min-stock').value = item.minStock || 5;
            document.getElementById('edit-item-tags').value = (item.tags && Array.isArray(item.tags)) ? item.tags.join(', ') : '';
            updateTagChips('edit-item-tags', 'edit-tag-chips');
            // Populate image gallery
            const gallery = document.getElementById('edit-image-gallery');
            gallery.innerHTML = '';
            window.editImageFiles = [];
            if (item.image && Array.isArray(item.image)) {
                item.image.forEach((imgData, idx) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.position = 'relative';
                    imgWrapper.style.display = 'inline-block';
                    const img = document.createElement('img');
                    img.src = imgData;
                    imgWrapper.appendChild(img);
                    // Add X button
                    const xBtn = document.createElement('button');
                    xBtn.textContent = '‚úñ';
                    xBtn.className = 'delete-image-btn';
                    xBtn.style.position = 'absolute';
                    xBtn.style.top = '0';
                    xBtn.style.right = '0';
                    xBtn.style.background = 'rgba(220,53,69,0.8)';
                    xBtn.style.color = '#fff';
                    xBtn.style.border = 'none';
                    xBtn.style.borderRadius = '50%';
                    xBtn.style.width = '22px';
                    xBtn.style.height = '22px';
                    xBtn.style.cursor = 'pointer';
                    xBtn.onclick = function(ev) {
                        ev.preventDefault();
                        item.image.splice(idx, 1);
                        editItem(id); // re-render
                    };
                    imgWrapper.appendChild(xBtn);
                    gallery.appendChild(imgWrapper);
                });
            }
            document.getElementById('edit-modal').style.display = 'block';
        }

        async function updateItem() {
            try {
                console.log('updateItem called');
                const id = document.getElementById('edit-item-id').value;
            const name = document.getElementById('edit-item-name').value;
                const barcode = document.getElementById('edit-item-barcode').value;
                const assetTag = document.getElementById('edit-item-asset-tag').value;
                const condition = document.getElementById('edit-item-condition').value;
                const description = document.getElementById('edit-item-description').value;
                const category = document.getElementById('edit-item-category').value;
            const quantity = parseInt(document.getElementById('edit-item-quantity').value);
            const price = parseFloat(document.getElementById('edit-item-price').value) || 0;
                const location = document.getElementById('edit-item-location').value;
                const minStock = parseInt(document.getElementById('edit-item-min-stock').value) || 5;
                const tagsInput = document.getElementById('edit-item-tags');
                const tags = tagsInput ? tagsInput.value.split(',').map(t => t.trim()).filter(Boolean) : [];
                const imageFiles = window.editImageFiles || document.getElementById('edit-item-images').files;
                let imageData = [];
                const MAX_IMAGES = 3;
                const MAX_TOTAL_SIZE = 1048487; // 1MB
                if (imageFiles.length > MAX_IMAGES) {
                    showAlert(`You can only upload up to ${MAX_IMAGES} images per item.`, 'error');
                    return;
                }
                if (imageFiles.length > 0) {
                    let processed = 0;
                    let errored = false;
                    for (let i = 0; i < imageFiles.length; i++) {
                        try {
                            const dataUrl = await resizeAndCompressImage(imageFiles[i]);
                            imageData[i] = dataUrl;
                            processed++;
                        } catch (err) {
                            errored = true;
                            showAlert(err, 'error');
                            break;
                        }
                    }
                    if (!errored) {
                        const totalSize = imageData.reduce((sum, img) => sum + (img.length || 0), 0);
                        if (totalSize > MAX_TOTAL_SIZE) {
                            showAlert('Total image size exceeds 1MB. Please use fewer or smaller images.', 'error');
                            return;
                        }
                        await saveUpdatedItem(id, name, barcode, assetTag, condition, description, category, quantity, price, location, minStock, imageData, tags);
                    }
                } else {
                    // If no new images, keep the old ones
                    const item = inventory.find(item => item.id === id);
                    imageData = item && item.image ? item.image : null;
                    await saveUpdatedItem(id, name, barcode, assetTag, condition, description, category, quantity, price, location, minStock, imageData, tags);
                }
            } catch (error) {
                console.error('Error updating item:', error);
                showAlert('Error updating item: ' + error.message, 'error');
            }
        }

        async function saveUpdatedItem(id, name, barcode, assetTag, condition, description, category, quantity, price, location, minStock, imageData, tags) {
            try {
                const itemRef = window.firebase.doc(window.firebase.db, 'inventory', id);
                await window.firebase.updateDoc(itemRef, {
                    name: name,
                    barcode: barcode,
                    assetTag: assetTag,
                    condition: condition,
                    description: description,
                    category: category,
                    quantity: quantity,
                    price: price,
                    location: location,
                    minStock: minStock,
                    image: imageData,
                    tags: tags
                });
                // Update local inventory
            const itemIndex = inventory.findIndex(item => item.id === id);
            if (itemIndex !== -1) {
                    inventory[itemIndex] = {
                        ...inventory[itemIndex],
                        name,
                        barcode,
                        assetTag,
                        condition,
                        description,
                        category,
                        quantity,
                        price,
                        location,
                        minStock,
                        image: imageData,
                        tags
                    };
                }
                closeEditModal();
                updateDashboard();
                loadInventoryTable();
                showAlert('Item updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating item:', error);
                showAlert('Error updating item: ' + error.message, 'error');
            }
        }

        async         function deleteItem(id) {
            if (!checkPermission('inventory.manage', 'You do not have permission to delete inventory items.')) return;
            
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const itemRef = window.firebase.doc(window.firebase.db, 'inventory', id);
                    await window.firebase.deleteDoc(itemRef);

                    // Remove from local inventory
                inventory = inventory.filter(item => item.id !== id);
                    
                updateDashboard();
                loadInventoryTable();
                showAlert('Item deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting item:', error);
                    showAlert('Error deleting item: ' + error.message, 'error');
                }
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function previewEditImage(input) {
            const preview = document.getElementById('edit-image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Barcode Scanner Functions
        let isScanning = false;
        let lastScannedCode = '';
        let scanTimeout = null;

        function activateScanner() {
            document.getElementById('scanner-modal').style.display = 'block';
            startScanner();
        }

        function closeScannerModal() {
            console.log('Closing scanner modal');
            document.getElementById('scanner-modal').style.display = 'none';
            stopScanner();
        }

        async function startScanner() {
            if (isScanning) {
                return;
            }

            try {
                // Stop any existing scanner
                stopScanner();
                
                // Reset scanning state
                isScanning = true;
                lastScannedCode = '';
                
                // Update button state
                document.querySelector('.barcode-scan-btn').classList.add('scanning');
                document.querySelector('.barcode-scan-btn').textContent = 'üì∑';
                
                // Request camera access with iPhone-optimized settings
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    } 
                });
                
                const video = document.getElementById('scanner-video');
                video.srcObject = stream;

                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                // Initialize ZXing scanner with better settings
                const codeReader = new ZXing.BrowserMultiFormatReader();
                
                // Configure scanner for better iPhone performance
                // codeReader.hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                // codeReader.hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                
                codeReader.decodeFromVideoDevice(null, 'scanner-video', (result, err) => {
                    console.log('Scanner callback - result:', result, 'error:', err);
                    
                    if (result && isScanning) {
                        const scannedCode = result.text.trim();
                        console.log('Scanned code:', scannedCode);
                        
                        // Prevent duplicate scans of the same code
                        if (scannedCode === lastScannedCode) {
                            console.log('Duplicate scan detected, ignoring');
                            return;
                        }
                        
                        // Clear any existing timeout
                        if (scanTimeout) {
                            clearTimeout(scanTimeout);
                        }
                        
                        // Set the scanned code
                        lastScannedCode = scannedCode;
                        document.getElementById('item-barcode').value = scannedCode;
                        
                        // Show success message
                        showAlert(`Barcode scanned: ${scannedCode}`, 'success');
                        
                        // Close modal and stop scanner
                        scanTimeout = setTimeout(() => {
                            console.log('Auto-closing scanner after successful scan');
                            closeScannerModal();
                        }, 1000);
                    }
                });

                scanner = codeReader;
                document.getElementById('scanner-status-text').textContent = 'Camera active - scanning for barcodes...';
                
            } catch (error) {
                isScanning = false;
                console.error('Scanner error:', error);
                
                if (error.name === 'NotAllowedError') {
                    showAlert('Camera access denied. Please allow camera permissions and try again.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showAlert('No camera found. Please check your device has a camera.', 'error');
                } else {
                showAlert('Error accessing camera: ' + error.message, 'error');
                }
                
                closeScannerModal();
            }
        }

        function stopScanner() {
            isScanning = false;
            
            // Clear any pending timeout
            if (scanTimeout) {
                clearTimeout(scanTimeout);
                scanTimeout = null;
            }
            
            // Reset scanner
            if (scanner) {
                try {
                scanner.reset();
                } catch (e) {
                    console.log('Scanner reset error:', e);
                }
                scanner = null;
            }
            
            // Stop video stream
            if (stream) {
                try {
                    stream.getTracks().forEach(track => {
                        track.stop();
                    });
                } catch (e) {
                    console.log('Stream stop error:', e);
                }
                stream = null;
            }
            
            // Clear video element
            const video = document.getElementById('scanner-video');
            if (video) {
                video.srcObject = null;
            }
            
            // Reset UI
            document.querySelector('.barcode-scan-btn').classList.remove('scanning');
            document.querySelector('.barcode-scan-btn').textContent = 'üì∑';
            document.getElementById('scanner-status-text').textContent = 'Ready to scan';
            
            // Clear last scanned code after a delay
            setTimeout(() => {
                lastScannedCode = '';
            }, 2000);
        }

        // Report Generation Functions
        function generateReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const includeImages = document.getElementById('include-images').checked;
            const includeBarcodes = document.getElementById('include-barcodes').checked;
            const includePrices = document.getElementById('include-prices').checked;
            const includeLocations = document.getElementById('include-locations').checked;
            const reportType = document.getElementById('report-type').value;
            let filteredInventory = [...inventory];

            // Filter based on report type
            switch (reportType) {
                case 'low-stock':
                    filteredInventory = inventory.filter(item => item.quantity <= item.minStock);
                    break;
                case 'category':
                    const category = document.getElementById('report-category').value;
                    if (category) {
                        filteredInventory = inventory.filter(item => item.category === category);
                    }
                    break;
                case 'value':
                    filteredInventory = inventory.filter(item => item.price > 100);
                    break;
            }

            // Table headers
            let columns = ['Name', 'Barcode', 'Quantity'];
            if (includeImages) columns.unshift('Image');
            if (includePrices) columns.push('Price');
            if (includeLocations) columns.push('Location');
            let rows = [];
            filteredInventory.forEach(item => {
                let row = [];
                if (includeImages) {
                    // Add thumbnail (first image if available)
                    let img = '';
                    if (item.image && Array.isArray(item.image) && item.image[0]) {
                        img = item.image[0];
                    } else if (typeof item.image === 'string' && item.image) {
                        img = item.image;
                    }
                    row.push(img);
                }
                row.push(item.name || '');
                row.push(item.barcode || '');
                row.push(item.quantity || 0);
                if (includePrices) row.push(item.price ? `$${item.price.toFixed(2)}` : '');
                if (includeLocations) row.push(item.location || '');
                rows.push(row);
            });
            // Draw table with images
            let startY = 20;
            doc.setFontSize(16);
            doc.text('Inventory Report', 10, startY);
            startY += 10;
            let colX = 10;
            let rowHeight = 18;
            // Draw headers
            columns.forEach((col, i) => {
                doc.setFontSize(12);
                doc.text(col, colX + i * 40, startY);
            });
            startY += 8;
            // Draw rows
            rows.forEach((row, rowIdx) => {
                row.forEach((cell, colIdx) => {
                    if (includeImages && colIdx === 0) {
                        // Draw image thumbnail if present
                        if (cell) {
                            try {
                                doc.addImage(cell, 'JPEG', colX + colIdx * 40, startY + rowIdx * rowHeight, 14, 14);
                        } catch (e) {
                                // If not JPEG, try PNG
                                try {
                                    doc.addImage(cell, 'PNG', colX + colIdx * 40, startY + rowIdx * rowHeight, 14, 14);
                                } catch (e2) {
                                    // If still fails, leave blank
                                }
                            }
                        } else {
                            doc.setFontSize(10);
                            doc.text(String(cell), colX + colIdx * 40, startY + rowIdx * rowHeight + 10);
                        }
                    } else {
                        doc.setFontSize(10);
                        doc.text(String(cell), colX + colIdx * 40, startY + rowIdx * rowHeight + 10);
                    }
                });
            });
            doc.save('inventory_report.pdf');
        }

        function exportToCSV() {
            const headers = ['Name', 'Barcode', 'Description', 'Category', 'Quantity', 'Price', 'Location', 'Date Added'];
            const csvContent = [
                headers.join(','),
                ...inventory.map(item => [
                    `"${item.name}"`,
                    `"${item.barcode || ''}"`,
                    `"${item.description || ''}"`,
                    `"${item.category || ''}"`,
                    item.quantity,
                    item.price,
                    `"${item.location || ''}"`,
                    `"${item.dateAdded}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('CSV file exported successfully!', 'success');
        }

        function loadCategories() {
            const categories = [...new Set(inventory.map(item => item.category).filter(cat => cat))];
            const select = document.getElementById('report-category');
            select.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
            });
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container') || document.querySelector('.login-container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function showLoginError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.textContent = message;
            errorDiv.style.marginTop = '10px';
            
            const loginForm = document.getElementById('login-form');
            loginForm.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Settings Functions
        async function loadUserSettings() {
            try {
                // Load user profile from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('email', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                let userProfile = {};
                let preferences = {};
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    
                    userProfile = {
                        email: userData.email || '',
                        fullname: userData.fullname || '',
                        created: userData.created || 'Unknown'
                    };
                    
                    preferences = {
                        autoLogout: userData.autoLogout !== false,
                        notifications: userData.notifications !== false,
                        lowStockAlerts: userData.lowStockAlerts !== false
                    };
                }
            
            // Load account information
            document.getElementById('current-username').value = userProfile.email || '';
            document.getElementById('user-email').value = userProfile.email || '';
            document.getElementById('user-fullname').value = userProfile.fullname || '';
            
            // Load preferences
                document.getElementById('auto-logout').checked = preferences.autoLogout;
                document.getElementById('notifications').checked = preferences.notifications;
                document.getElementById('low-stock-alerts').checked = preferences.lowStockAlerts;
                
                // Load theme (still use localStorage for theme)
            const currentTheme = localStorage.getItem('theme') || 'default';
            document.getElementById('theme-select').value = currentTheme;
            
            // Update about section
            document.getElementById('total-items-settings').textContent = inventory.length;
            document.getElementById('last-login').textContent = new Date().toLocaleString();
            document.getElementById('account-created').textContent = userProfile.created || 'Unknown';
            } catch (error) {
                console.error('Error loading user settings:', error);
                showAlert('Error loading user settings: ' + error.message, 'error');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert('Please fill in all password fields!', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match!', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert('New password must be at least 6 characters long!', 'error');
                return;
            }
            
            try {
                const user = window.firebase.auth.currentUser;
                if (!user) {
                    showAlert('You must be logged in to change your password!', 'error');
                return;
            }
            
                // Re-authenticate user before changing password
                const email = currentUser + '@farhop-inventory.com';
                const credential = window.firebase.EmailAuthProvider.credential(email, currentPassword);
                await window.firebase.reauthenticateWithCredential(user, credential);
                
                // Change password
                await window.firebase.updatePassword(user, newPassword);
            
            // Clear form
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
            
            showAlert('Password changed successfully!', 'success');
            } catch (error) {
                console.error('Error changing password:', error);
                if (error.code === 'auth/wrong-password') {
                    showAlert('Current password is incorrect!', 'error');
                } else {
                    showAlert('Error changing password: ' + error.message, 'error');
                }
            }
        }

        async function exportUserData() {
            try {
                // Get user profile from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('email', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                let userProfile = {};
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    userProfile = userDoc.data();
                }
                
            const userData = {
                inventory: inventory,
                    userProfile: userProfile,
                    exportDate: new Date().toISOString(),
                    note: 'This export contains your inventory data. User credentials are managed by Firebase and cannot be exported.'
            };
            
            const dataStr = JSON.stringify(userData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
                showAlert('Inventory data exported successfully!', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showAlert('Error exporting data: ' + error.message, 'error');
            }
        }

        async function importUserData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const userData = JSON.parse(e.target.result);
                        
                        if (userData.inventory) {
                            // Import inventory items to Firestore
                            for (const item of userData.inventory) {
                                const importItem = {
                                    userId: currentUser,
                                    name: item.name,
                                    barcode: item.barcode,
                                    description: item.description,
                                    category: item.category,
                                    quantity: item.quantity,
                                    price: item.price,
                                    location: item.location,
                                    minStock: item.minStock,
                                    image: item.image,
                                    dateAdded: item.dateAdded || new Date().toISOString()
                                };
                                
                                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), importItem);
                            }
                            
                            // Reload inventory
                            await loadInventory();
                        }
                        
                        if (userData.userProfile) {
                            // Update user profile in Firestore
                            const usersRef = window.firebase.collection(window.firebase.db, 'users');
                            const q = window.firebase.query(usersRef, window.firebase.where('email', '==', currentUser));
                            const querySnapshot = await window.firebase.getDocs(q);
                            
                            if (!querySnapshot.empty) {
                                const userDoc = querySnapshot.docs[0];
                                await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), userData.userProfile);
                            }
                        }
                        
                        updateDashboard();
                        loadInventoryTable();
                        await loadUserSettings();
                        showAlert('Data imported successfully!', 'success');
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showAlert('Error importing data: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        async function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone!')) {
                try {
                    // Delete all inventory items for this user from Firestore
                    const inventoryRef = window.firebase.collection(window.firebase.db, 'inventory');
                    const q = window.firebase.query(inventoryRef, window.firebase.where('userId', '==', currentUser));
                    const querySnapshot = await window.firebase.getDocs(q);
                    
                    const deletePromises = querySnapshot.docs.map(doc => 
                        window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'inventory', doc.id))
                    );
                    
                    await Promise.all(deletePromises);
                    
                    // Clear local inventory
                inventory = [];
                    
                    // Clear local storage (theme, etc.)
                    localStorage.clear();
                    
                showAlert('All data cleared successfully!', 'success');
                logout();
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showAlert('Error clearing data: ' + error.message, 'error');
                }
            }
        }

        // Save user profile when fields change
        async function saveUserProfile() {
            try {
                const newEmail = document.getElementById('user-email').value.trim().toLowerCase();
                const fullname = document.getElementById('user-fullname').value;
                const created = document.getElementById('account-created').textContent === 'Unknown' ? new Date().toLocaleDateString() : document.getElementById('account-created').textContent;
                const user = window.firebase.auth.currentUser;
                // Get current email from Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('email', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userData = userDoc.data();
                    const oldEmail = userData.email;
                    // If email changed, update in Firebase Auth
                    if (newEmail !== oldEmail) {
                        // Prompt for current password
                        const password = prompt('To change your email, please enter your current password:');
                        if (!password) {
                            showAlert('Email not changed. Password required.', 'error');
                            return;
                        }
                        // Re-authenticate
                        const credential = window.firebase.EmailAuthProvider.credential(oldEmail, password);
                        try {
                            await window.firebase.reauthenticateWithCredential(user, credential);
                            await window.firebase.updateEmail(user, newEmail);
                            showAlert('Email updated in authentication system.', 'success');
                        } catch (err) {
                            showAlert('Failed to update email in authentication: ' + err.message, 'error');
                            return;
                        }
                    }
                    // Update in Firestore
            const userProfile = {
                        email: newEmail,
                        fullname: fullname,
                        created: created,
                        updated: new Date().toISOString()
                    };
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), userProfile);
                    showAlert('Profile updated successfully!', 'success');
                }
            } catch (error) {
                console.error('Error saving user profile:', error);
                showAlert('Error saving profile: ' + error.message, 'error');
            }
        }

        // Save preferences when checkboxes change
        async function savePreferences() {
            try {
            const preferences = {
                autoLogout: document.getElementById('auto-logout').checked,
                notifications: document.getElementById('notifications').checked,
                    lowStockAlerts: document.getElementById('low-stock-alerts').checked,
                    updated: new Date().toISOString()
                };
                
                // Save to Firestore
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('email', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                
                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), preferences);
                }
            } catch (error) {
                console.error('Error saving preferences:', error);
                showAlert('Error saving preferences: ' + error.message, 'error');
            }
        }

        // Email Functions
        function sendSignupEmail(username, password) {
            // Initialize EmailJS (you'll need to set up your own EmailJS account)
            emailjs.init("YOUR_EMAILJS_PUBLIC_KEY"); // Replace with your actual EmailJS public key
            
            const templateParams = {
                to_email: "support@farhop.com",
                from_name: "Inventory System",
                username: username,
                password: password,
                signup_date: new Date().toLocaleString(),
                user_agent: navigator.userAgent,
                device_info: `${navigator.platform} - ${navigator.language}`
            };

            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', templateParams)
                .then(function(response) {
                    console.log('Signup email sent successfully:', response);
                }, function(error) {
                    console.log('Failed to send signup email:', error);
                    // Don't show error to user - email failure shouldn't prevent signup
                });
        }

        // Forgot Password Functions
        function showForgotPassword() {
            document.getElementById('forgot-password-modal').style.display = 'block';
            document.getElementById('forgot-step-1').style.display = 'block';
        }

        function closeForgotPassword() {
            document.getElementById('forgot-password-modal').style.display = 'none';
        }

        async function sendPasswordReset() {
            const email = document.getElementById('recovery-email').value.trim().toLowerCase();
            if (!email) {
                showAlert('Please enter your email!', 'error');
                return;
            }
            try {
                await window.firebase.sendPasswordResetEmail(window.firebase.auth, email);
                closeForgotPassword();
                showAlert('Password reset email sent! Please check your email and follow the instructions to reset your password.', 'success');
            } catch (error) {
                console.error('Error sending password reset email:', error);
                if (error.code === 'auth/user-not-found') {
                    showAlert('No account found with that email.', 'error');
                } else {
                    showAlert('Error sending password reset email: ' + error.message, 'error');
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('edit-modal');
            if (event.target === modal) {
                closeEditModal();
            }
            
            const forgotModal = document.getElementById('forgot-password-modal');
            if (event.target === forgotModal) {
                closeForgotPassword();
            }
            
            const scannerModal = document.getElementById('scanner-modal');
            if (event.target === scannerModal) {
                closeScannerModal();
            }
            
            const userDetailsModal = document.getElementById('user-details-modal');
            if (event.target === userDetailsModal) {
                closeUserDetails();
            }

            const addEmployeeModal = document.getElementById('add-employee-modal');
            if (event.target === addEmployeeModal) {
                closeAddEmployeeModal();
            }

            const editEmployeeModal = document.getElementById('edit-employee-modal');
            if (event.target === editEmployeeModal) {
                closeEditEmployeeModal();
            }

            const checkinModal = document.getElementById('checkin-modal');
            if (event.target === checkinModal) {
                closeCheckinModal();
            }

            const transactionDetailsModal = document.getElementById('transaction-details-modal');
            if (event.target === transactionDetailsModal) {
                closeTransactionDetails();
            }

            const lostDamagedModal = document.getElementById('lost-damaged-modal');
            if (event.target === lostDamagedModal) {
                closeLostDamagedModal();
            }

            const inviteUserModal = document.getElementById('invite-user-modal');
            if (event.target === inviteUserModal) {
                closeInviteUserModal();
            }
        }

        let categories = ["Electronics", "Clothing", "Books", "Food", "Tools", "Other"];

        async function loadCategoriesFromFirestore() {
            try {
                const catRef = window.firebase.collection(window.firebase.db, 'categories');
                const q = window.firebase.query(catRef, window.firebase.where('userId', '==', currentUser));
                const querySnapshot = await window.firebase.getDocs(q);
                categories = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data && data.name) {
                        categories.push({ id: doc.id, name: data.name });
                    }
                });
                if (categories.length === 0) {
                    // If no categories, add defaults
                    await addDefaultCategories();
                    await loadCategoriesFromFirestore();
                } else {
                    renderCategoryList();
                    populateCategorySelects();
                }
            } catch (e) {
                console.error('Error loading categories:', e);
            }
        }

        async function addDefaultCategories() {
            const defaultCats = ["Electronics", "Clothing", "Books", "Food", "Tools", "Other"];
            for (const name of defaultCats) {
                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'categories'), {
                    userId: currentUser,
                    name
                });
            }
        }

        function renderCategoryList() {
            const ul = document.getElementById('category-list');
            ul.innerHTML = '';
            categories.forEach(cat => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.gap = '8px';
                li.innerHTML = `
                    <span>${cat.name}</span>
                    <button class="btn btn-warning" style="padding:2px 8px;" onclick="renameCategoryPrompt('${cat.id}', '${cat.name}')">Rename</button>
                    <button class="btn btn-danger" style="padding:2px 8px;" onclick="deleteCategory('${cat.id}')">Delete</button>
                `;
                ul.appendChild(li);
            });
        }

        async function addCategory() {
            const input = document.getElementById('new-category-input');
            const name = input.value.trim();
            if (!name) return;
            await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'categories'), {
                userId: currentUser,
                name
            });
            input.value = '';
            await loadCategoriesFromFirestore();
        }

        function renameCategoryPrompt(id, oldName) {
            const newName = prompt('Rename category:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                renameCategory(id, newName.trim());
            }
        }

        async function renameCategory(id, newName) {
            const catRef = window.firebase.doc(window.firebase.db, 'categories', id);
            await window.firebase.updateDoc(catRef, { name: newName });
            await loadCategoriesFromFirestore();
        }

        async function deleteCategory(id) {
            if (!confirm('Delete this category?')) return;
            const catRef = window.firebase.doc(window.firebase.db, 'categories', id);
            await window.firebase.deleteDoc(catRef);
            await loadCategoriesFromFirestore();
        }

        function populateCategorySelects() {
            const selects = [document.getElementById('item-category'), document.getElementById('edit-item-category'), document.getElementById('report-category')];
            selects.forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            });
        }

        // Generate Label (PDF with barcode and QR)
        function generateLabel(id) {
            const item = inventory.find(item => item.id === id);
            if (!item) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(item.name, 10, 20);
            doc.setFontSize(12);
            doc.text('Barcode:', 10, 35);
            doc.text(item.barcode || 'N/A', 40, 35);
            // Barcode (using JsBarcode via CDN)
            const barcodeCanvas = document.createElement('canvas');
            JsBarcode(barcodeCanvas, item.barcode || '', { format: 'CODE128', width: 2, height: 40 });
            doc.addImage(barcodeCanvas.toDataURL('image/png'), 'PNG', 10, 40, 80, 20);
            // QR code (using QRious via CDN)
            const qr = new QRious({ value: item.barcode || '', size: 80 });
            doc.text('QR Code:', 10, 70);
            doc.addImage(qr.toDataURL(), 'PNG', 10, 75, 40, 40);
            doc.save(`${item.name}_label.pdf`);
        }

        // Multiple photos per item: previewImages, save/load images as array
        function previewImages(input, mode) {
            const gallery = mode === 'add' ? document.getElementById('add-image-gallery') : document.getElementById('edit-image-gallery');
            gallery.innerHTML = '';
            let files = Array.from(input.files);
            // Store selected files in a global variable for each mode
            if (mode === 'add') {
                window.addImageFiles = files;
            } else {
                window.editImageFiles = files;
            }
            files.forEach((file, idx) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.position = 'relative';
                    imgWrapper.style.display = 'inline-block';
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imgWrapper.appendChild(img);
                    // Add X button
                    const xBtn = document.createElement('button');
                    xBtn.textContent = '‚úñ';
                    xBtn.className = 'delete-image-btn';
                    xBtn.style.position = 'absolute';
                    xBtn.style.top = '0';
                    xBtn.style.right = '0';
                    xBtn.style.background = 'rgba(220,53,69,0.8)';
                    xBtn.style.color = '#fff';
                    xBtn.style.border = 'none';
                    xBtn.style.borderRadius = '50%';
                    xBtn.style.width = '22px';
                    xBtn.style.height = '22px';
                    xBtn.style.cursor = 'pointer';
                    xBtn.onclick = function(ev) {
                        ev.preventDefault();
                        // Remove file from array and update input.files
                        files.splice(idx, 1);
                        // Update global variable
                        if (mode === 'add') {
                            window.addImageFiles = files;
                        } else {
                            window.editImageFiles = files;
                        }
                        // Create a new FileList
                        const dataTransfer = new DataTransfer();
                        files.forEach(f => dataTransfer.items.add(f));
                        input.files = dataTransfer.files;
                        previewImages(input, mode);
                    };
                    imgWrapper.appendChild(xBtn);
                    gallery.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        // Multi-tag support: parse tags from input, display as chips
        function updateTagChips(inputId, chipsId) {
            const input = document.getElementById(inputId);
            const chips = document.getElementById(chipsId);
            chips.innerHTML = '';
            const tags = input.value.split(',').map(t => t.trim()).filter(Boolean);
            tags.forEach(tag => {
                const chip = document.createElement('span');
                chip.className = 'tag-chip';
                chip.textContent = tag;
                chips.appendChild(chip);
            });
        }

        document.getElementById('item-tags').addEventListener('input', () => updateTagChips('item-tags', 'add-tag-chips'));
        document.getElementById('edit-item-tags').addEventListener('input', () => updateTagChips('edit-item-tags', 'edit-tag-chips'));

        // Branding: preview, save, and apply logo/color
        function previewBrandingLogo(input) {
            const preview = document.getElementById('branding-logo-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function applyThemeColor(color) {
            document.documentElement.style.setProperty('--theme-color', color);
        }

        function saveBranding() {
            const logoInput = document.getElementById('branding-logo');
            const color = document.getElementById('branding-color').value;
            let logoData = null;
            if (logoInput.files && logoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoData = e.target.result;
                    localStorage.setItem('brandingLogo', logoData);
                    localStorage.setItem('brandingColor', color);
                    applyThemeColor(color);
                    document.getElementById('branding-logo-preview').src = logoData;
                    document.getElementById('branding-logo-preview').style.display = 'block';
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                localStorage.setItem('brandingColor', color);
                applyThemeColor(color);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const logoData = localStorage.getItem('brandingLogo');
            const color = localStorage.getItem('brandingColor');
            if (logoData) {
                document.getElementById('branding-logo-preview').src = logoData;
                document.getElementById('branding-logo-preview').style.display = 'block';
            }
            if (color) {
                document.getElementById('branding-color').value = color;
                applyThemeColor(color);
            }
        });

        // At the end of the script, attach editItem to window
        window.editItem = editItem;

        // Admin login logic
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'changeme123'; // Change this to your secure password

        function showAdminLogin() {
          document.getElementById('admin-login-modal').style.display = 'block';
        }
        function closeAdminLogin() {
          document.getElementById('admin-login-modal').style.display = 'none';
        }
        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
          e.preventDefault();
          adminLogin();
        });

        function adminLogin() {
          const username = document.getElementById('admin-username').value.trim();
          const password = document.getElementById('admin-password').value;
          if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
            showAdminDashboard();
            closeAdminLogin();
          } else {
            showAlert('Invalid admin credentials!', 'error');
          }
        }

        function showAdminDashboard() {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-app').style.display = 'none';
          document.getElementById('admin-dashboard').classList.remove('hidden');
          loadAllUsers();
        }
        function logoutAdmin() {
          document.getElementById('admin-dashboard').classList.add('hidden');
          showLoginScreen();
        }

        function returnToMainApp() {
          document.getElementById('admin-dashboard').classList.add('hidden');
          document.getElementById('main-app').style.display = 'block';
          
          // Reset ALL nav tabs (including admin tab) to inactive
          document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
          
          // Show dashboard tab as default
          const dashboardTab = document.querySelector('button[onclick="showTab(\'dashboard\')"]');
          if (dashboardTab) {
            dashboardTab.classList.add('active');
          }
          document.getElementById('dashboard').classList.add('active');
          
          // Update dashboard data
          updateDashboard();
          
          // Optional: Show success message
          showAlert('Returned to main inventory app', 'success');
        }
        async function loadAllUsers() {
          try {
            const usersRef = window.firebase.collection(window.firebase.db, 'users');
            const querySnapshot = await window.firebase.getDocs(usersRef);
            const tbody = document.getElementById('admin-users-body');
            tbody.innerHTML = '';
            querySnapshot.forEach(doc => {
              const user = doc.data();
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${user.username || ''}</td>
                <td>${user.email || ''}</td>
                <td>${user.created ? new Date(user.created).toLocaleString() : ''}</td>
                <td>${user.lastIP || ''}</td>
                <td>
                  <button class="btn btn-warning" onclick="adminLoginAsUser('${user.email}')" title="Login as User">Login</button>
                  <button class="btn btn-danger" onclick="deleteUser('${doc.id}')" title="Delete User">Delete</button>
                </td>
              `;
              tbody.appendChild(tr);
            });
          } catch (error) {
            showAlert('Error loading users: ' + error.message, 'error');
          }
        }
        // ... existing code ...
        // Add modal close logic for admin login
        window.onclick = function(event) {
          // ... existing code ...
          const adminModal = document.getElementById('admin-login-modal');
          if (event.target === adminModal) {
            closeAdminLogin();
          }
        }
        // ... existing code ...
        // Delete user
        async function deleteUser(userId) {
          if (!confirm('Are you sure you want to delete this user?')) return;
          try {
            await window.firebase.deleteDoc(window.firebase.doc(window.firebase.db, 'users', userId));
            showAlert('User deleted.', 'success');
            loadAllUsers();
          } catch (error) {
            showAlert('Error deleting user: ' + error.message, 'error');
          }
        }
        // Show user details modal
        async function showUserDetails(userId) {
          try {
            const userDocRef = window.firebase.doc(window.firebase.db, 'users', userId);
            const getDoc = window.firebase.getDoc;
            const snap = await getDoc(userDocRef);
            let user = null;
            if (snap.exists()) {
              user = snap.data();
            } else {
              user = null;
            }
            if (!user) {
              document.getElementById('user-details-content').innerHTML = '<p>User not found.</p>';
            } else {
              let html = '<ul>';
              for (const key in user) {
                html += `<li><strong>${key}:</strong> ${user[key]}</li>`;
              }
              html += '</ul>';
              document.getElementById('user-details-content').innerHTML = html;
            }
            document.getElementById('user-details-modal').style.display = 'block';
          } catch (error) {
            document.getElementById('user-details-content').innerHTML = '<p>Error loading user details.</p>';
            document.getElementById('user-details-modal').style.display = 'block';
          }
        }
        function closeUserDetails() {
          document.getElementById('user-details-modal').style.display = 'none';
        }
        // ... existing code ...
        // Add modal close logic for user details
        window.onclick = function(event) {
          // ... existing code ...
          const userDetailsModal = document.getElementById('user-details-modal');
          if (event.target === userDetailsModal) {
            closeUserDetails();
          }
        }
        // ... existing code ...
        // Utility to get public IP
        async function getPublicIP() {
          try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            return data.ip;
          } catch {
            return 'Unknown';
          }
        }

        // Show Admin tab if user is admin
        function updateAdminTab() {
          const navTabs = document.getElementById('main-nav-tabs');
          if (!navTabs) return;
          // Remove existing Admin tab if any
          const existing = document.getElementById('admin-nav-tab');
          if (existing) existing.remove();
          if (isAdmin) {
            // Insert Admin tab before the last tab (Settings)
            const btn = document.createElement('button');
            btn.className = 'nav-tab';
            btn.id = 'admin-nav-tab';
            btn.textContent = 'üë§ Admin';
            btn.onclick = function() {
              showAdminDashboard();
              // Set active class for admin tab
              document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
              btn.classList.add('active');
            };
            // Insert before the last tab (Settings)
            const settingsTab = navTabs.querySelector('button.nav-tab:last-child');
            navTabs.insertBefore(btn, settingsTab);
          }
        }

        // Add adminLoginAsUser function
        async function adminLoginAsUser(email) {
          const password = prompt('Enter the password for this user to log in as them:');
          if (!password) return;
          try {
            const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
            const user = userCredential.user;
            // Get user profile from Firestore
            const usersRef = window.firebase.collection(window.firebase.db, 'users');
            const q = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
            const querySnapshot = await window.firebase.getDocs(q);
            if (!querySnapshot.empty) {
              const userDoc = querySnapshot.docs[0];
              const userData = userDoc.data();
              isAuthenticated = true;
              currentUser = userData.username;
              // Save IP
              const ip = await getPublicIP();
              await window.firebase.updateDoc(window.firebase.doc(window.firebase.db, 'users', userDoc.id), { lastIP: ip });
              // Create session
              const session = {
                username: userData.username,
                timestamp: Date.now()
              };
              localStorage.setItem('inventory_session', JSON.stringify(session));
              await showMainApp();
              showAlert('Logged in as ' + userData.username, 'success');
            } else {
              showLoginError('User profile not found!');
            }
          } catch (error) {
            showAlert('Login as user failed: ' + error.message, 'error');
          }
        }

        function showTSVImport() {
          document.getElementById('tsv-import-modal').style.display = 'block';
          document.getElementById('tsv-import-textarea').value = '';
          document.getElementById('tsv-import-summary').innerHTML = '';
        }
        function closeTSVImport() {
          document.getElementById('tsv-import-modal').style.display = 'none';
        }
        async function importTSVItems() {
          const textarea = document.getElementById('tsv-import-textarea');
          const summary = document.getElementById('tsv-import-summary');
          const lines = textarea.value.trim().split(/\r?\n/);
          let imported = 0, failed = 0;
          for (const line of lines) {
            if (!line.trim()) continue;
            const parts = line.split('\t');
            if (parts.length < 5) { failed++; continue; }
            const [name, barcode, description, category, quantity, price, location, minStock, tags] = parts;
            try {
              const item = {
                userId: currentUser,
                name: name || '',
                barcode: barcode || '',
                description: description || '',
                category: category || '',
                quantity: parseInt(quantity) || 0,
                price: parseFloat(price) || 0,
                location: location || '',
                minStock: parseInt(minStock) || 5,
                tags: tags ? tags.split(',').map(t => t.trim()).filter(Boolean) : [],
                image: [],
                dateAdded: new Date().toISOString()
              };
              // Save to Firestore
              const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'inventory'), item);
              item.id = docRef.id;
              inventory.push(item);
              imported++;
            } catch (e) {
              failed++;
            }
          }
          loadInventoryTable();
          updateDashboard();
          summary.innerHTML = `<span style='color:green;'>Imported: ${imported}</span> <span style='color:red;'>Failed: ${failed}</span>`;
        }
        // Modal close logic for TSV import
        window.onclick = function(event) {
          // ... existing code ...
          const tsvModal = document.getElementById('tsv-import-modal');
          if (event.target === tsvModal) {
            closeTSVImport();
          }
        }
        // ... existing code ...
        function downloadTSVTemplate() {
          const headers = [
            'Name', 'Barcode', 'Description', 'Category', 'Quantity', 'Price', 'Location', 'MinStock', 'Tags'
          ];
          const tsv = headers.join('\t') + '\n';
          const blob = new Blob([tsv], { type: 'text/tab-separated-values' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'inventory-template.tsv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
        function exportInventoryTSV() {
          const headers = [
            'Name', 'Barcode', 'Description', 'Category', 'Quantity', 'Price', 'Location', 'MinStock', 'Tags'
          ];
          let tsv = headers.join('\t') + '\n';
          inventory.forEach(item => {
            const row = [
              item.name || '',
              item.barcode || '',
              item.description || '',
              item.category || '',
              item.quantity != null ? item.quantity : '',
              item.price != null ? item.price : '',
              item.location || '',
              item.minStock != null ? item.minStock : '',
              (item.tags && Array.isArray(item.tags)) ? item.tags.join(', ') : ''
            ];
            tsv += row.join('\t') + '\n';
          });
          const blob = new Blob([tsv], { type: 'text/tab-separated-values' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'inventory-export.tsv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        document.addEventListener('DOMContentLoaded', function() {
          const versionDate = new Date('2024-06-09T12:00:00Z'); // original UTC time
          const options = {
            year: 'numeric', month: 'long', day: 'numeric',
            hour: 'numeric', minute: '2-digit',
            hour12: true,
            timeZoneName: 'short'
          };
          const localString = versionDate.toLocaleString(undefined, options);
          document.querySelectorAll('.version-date').forEach(el => {
            el.textContent = localString;
          });
          // Set commit hash (replace 'abcdef0' with your real commit if desired)
          const commit = 'abcdef0';
          document.querySelectorAll('.version-commit').forEach(el => {
            el.textContent = commit;
          });
        });

        // ========================
        // USB SCANNER FUNCTIONS
        // ========================

        // Handle USB scanner input (usually ends with Enter key)
        function handleScannerInput(event, mode) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const code = input.value.trim();
                
                if (code) {
                    searchEquipmentByCode(mode, code);
                    
                    // Clear input after a short delay to prepare for next scan
                    setTimeout(() => {
                        input.value = '';
                        input.focus();
                    }, 1000);
                }
            }
        }

        // Search for equipment by barcode or asset tag
        function searchEquipmentByCode(mode, code = null) {
            const inputId = mode === 'checkout' ? 'checkout-scanner-input' : 'checkin-scanner-input';
            const statusId = mode === 'checkout' ? 'checkout-scanner-status' : 'checkin-scanner-status';
            const searchCode = code || document.getElementById(inputId).value.trim();
            const statusDiv = document.getElementById(statusId);
            
            if (!searchCode) {
                statusDiv.innerHTML = '';
                return;
            }

            // Search in inventory for barcode or asset tag match
            const foundEquipment = inventory.find(item => 
                (item.barcode && item.barcode.toLowerCase() === searchCode.toLowerCase()) ||
                (item.assetTag && item.assetTag.toLowerCase() === searchCode.toLowerCase())
            );

            if (foundEquipment) {
                if (mode === 'checkout') {
                    handleCheckoutScan(foundEquipment, statusDiv);
                } else if (mode === 'checkin') {
                    handleCheckinScan(foundEquipment, statusDiv);
                }
            } else {
                statusDiv.innerHTML = `<span style="color: #dc3545;">‚ùå Equipment not found: ${searchCode}</span>`;
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }

        // Handle checkout scanning
        function handleCheckoutScan(equipment, statusDiv) {
            // Check if equipment is already checked out
            const isCheckedOut = transactions.some(t => t.equipmentId === equipment.id && !t.returnDate);
            
            if (isCheckedOut) {
                statusDiv.innerHTML = `<span style="color: #ffc107;">‚ö†Ô∏è Equipment "${equipment.name}" is already checked out!</span>`;
                
                // Show in check-in section instead
                setTimeout(() => {
                    statusDiv.innerHTML = `<span style="color: #007bff;">üí° This equipment is checked out. Switch to Check-In tab to return it.</span>`;
                }, 2000);
                
                return;
            }

            // Equipment is available for checkout
            const equipmentSelect = document.getElementById('checkout-equipment');
            equipmentSelect.value = equipment.id;
            loadEquipmentDetails();
            
            statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ Found: ${equipment.name} ${equipment.assetTag ? '(' + equipment.assetTag + ')' : ''}</span>`;
            
            // Auto-focus employee field
            setTimeout(() => {
                document.getElementById('checkout-employee').focus();
            }, 500);
        }

        // Handle checkin scanning
        function handleCheckinScan(equipment, statusDiv) {
            // Find active transaction for this equipment
            const activeTransaction = transactions.find(t => t.equipmentId === equipment.id && !t.returnDate);
            
            if (!activeTransaction) {
                statusDiv.innerHTML = `<span style="color: #ffc107;">‚ö†Ô∏è Equipment "${equipment.name}" is not currently checked out!</span>`;
                
                setTimeout(() => {
                    statusDiv.innerHTML = `<span style="color: #007bff;">üí° This equipment is available. Switch to Check-Out tab to assign it.</span>`;
                }, 2000);
                
                return;
            }

            // Equipment is checked out and can be returned
            statusDiv.innerHTML = `<span style="color: #28a745;">‚úÖ Found: ${equipment.name} - Checked out to ${activeTransaction.employeeName}</span>`;
            
            // Auto-open check-in modal
            setTimeout(() => {
                showCheckinModal(activeTransaction.id);
            }, 1000);
        }

        // Clear scanner input and refocus
        function clearScannerInput(mode) {
            const inputId = mode === 'checkout' ? 'checkout-scanner-input' : 'checkin-scanner-input';
            const statusId = mode === 'checkout' ? 'checkout-scanner-status' : 'checkin-scanner-status';
            
            document.getElementById(inputId).value = '';
            document.getElementById(statusId).innerHTML = '';
            document.getElementById(inputId).focus();
        }

        // Auto-focus scanner input when tab is shown
        function focusScannerInput(mode) {
            const inputId = mode === 'checkout' ? 'checkout-scanner-input' : 'checkin-scanner-input';
            setTimeout(() => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        // Permission checking functions
        function hasPermission(permission) {
            if (!userPermissions) return false;
            return userPermissions.includes('all') || userPermissions.includes(permission);
        }

        function checkPermission(permission, errorMessage = 'You do not have permission to perform this action.') {
            if (!hasPermission(permission)) {
                showAlert(errorMessage, 'error');
                return false;
            }
            return true;
        }

        function updateNavigationForRole() {
            const navTabs = document.getElementById('main-nav-tabs');
            if (!navTabs) return;

            // Define tab permissions
            const tabPermissions = {
                'dashboard': 'inventory.view',
                'add-item': 'inventory.manage',
                'inventory': 'inventory.view',
                'checkout': 'equipment.checkout',
                'checkin': 'equipment.checkin',
                'employees': 'employees.manage',
                'equipment-history': 'transactions.view',
                'employee-history': 'transactions.view',
                'reports': 'reports.view',
                'settings': 'all' // Everyone can access basic settings
            };

            // Show/hide tabs based on permissions
            navTabs.querySelectorAll('.nav-tab').forEach(tab => {
                const tabText = tab.textContent.trim();
                let tabKey = '';
                
                if (tabText.includes('Dashboard')) tabKey = 'dashboard';
                else if (tabText.includes('Add Item')) tabKey = 'add-item';
                else if (tabText.includes('Inventory')) tabKey = 'inventory';
                else if (tabText.includes('Check-Out')) tabKey = 'checkout';
                else if (tabText.includes('Check-In')) tabKey = 'checkin';
                else if (tabText.includes('Employees')) tabKey = 'employees';
                else if (tabText.includes('Equipment History')) tabKey = 'equipment-history';
                else if (tabText.includes('Employee History')) tabKey = 'employee-history';
                else if (tabText.includes('Reports')) tabKey = 'reports';
                else if (tabText.includes('Settings')) tabKey = 'settings';
                else if (tabText.includes('Admin')) {
                    // Admin tab only for admin role
                    tab.style.display = isAdmin ? 'block' : 'none';
                    return;
                }

                if (tabKey && tabPermissions[tabKey]) {
                    const hasAccess = hasPermission(tabPermissions[tabKey]);
                    tab.style.display = hasAccess ? 'block' : 'none';
                }
            });
        }

        // Keyboard shortcuts for scanner inputs
        document.addEventListener('keydown', function(event) {
            // F1 - Focus checkout scanner
            if (event.key === 'F1') {
                event.preventDefault();
                if (hasPermission('equipment.checkout')) {
                    showTab('checkout');
                    focusScannerInput('checkout');
                }
            }
            // F2 - Focus checkin scanner  
            else if (event.key === 'F2') {
                event.preventDefault();
                if (hasPermission('equipment.checkin')) {
                    showTab('checkin');
                    focusScannerInput('checkin');
                }
            }
            // Escape - Clear current scanner input
            else if (event.key === 'Escape') {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.classList.contains('scanner-input')) {
                    if (activeElement.id === 'checkout-scanner-input') {
                        clearScannerInput('checkout');
                    } else if (activeElement.id === 'checkin-scanner-input') {
                        clearScannerInput('checkin');
                    }
                }
            }
        });

        // ========================
        // EQUIPMENT MANAGEMENT FUNCTIONS
        // ========================

        // Load employees from Firestore
        async function loadEmployees() {
            try {
                const employeesRef = window.firebase.collection(window.firebase.db, 'employees');
                const q = window.firebase.query(employeesRef, window.firebase.where('companyId', '==', currentCompany));
                const querySnapshot = await window.firebase.getDocs(q);
                employees = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading employees:', error);
                showAlert('Error loading employees: ' + error.message, 'error');
            }
        }

        // Load transactions from Firestore
        async function loadTransactions() {
            try {
                const transactionsRef = window.firebase.collection(window.firebase.db, 'transactions');
                const q = window.firebase.query(transactionsRef, window.firebase.where('companyId', '==', currentCompany));
                const querySnapshot = await window.firebase.getDocs(q);
                transactions = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading transactions:', error);
                showAlert('Error loading transactions: ' + error.message, 'error');
            }
        }

        // Load lost/damaged reports from Firestore
        async function loadLostDamagedReports() {
            try {
                const reportsRef = window.firebase.collection(window.firebase.db, 'lostDamagedReports');
                const q = window.firebase.query(reportsRef, window.firebase.where('companyId', '==', currentCompany));
                const querySnapshot = await window.firebase.getDocs(q);
                lostDamagedReports = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading reports:', error);
                showAlert('Error loading reports: ' + error.message, 'error');
            }
        }

        // Employee Management Functions
        function showAddEmployeeModal() {
            document.getElementById('add-employee-modal').style.display = 'block';
        }

        function closeAddEmployeeModal() {
            document.getElementById('add-employee-modal').style.display = 'none';
            document.getElementById('add-employee-form').reset();
        }

        function closeEditEmployeeModal() {
            document.getElementById('edit-employee-modal').style.display = 'none';
            document.getElementById('edit-employee-form').reset();
        }

        // Add employee
        async function addEmployee() {
            if (!checkPermission('employees.manage', 'You do not have permission to add employees.')) return;
            
            try {
                const employeeData = {
                    userId: currentUser,
                    companyId: currentCompany,
                    employeeId: document.getElementById('employee-id').value.trim(),
                    name: document.getElementById('employee-name').value.trim(),
                    email: document.getElementById('employee-email').value.trim(),
                    phone: document.getElementById('employee-phone').value.trim(),
                    department: document.getElementById('employee-department').value,
                    jobTitle: document.getElementById('employee-job-title').value.trim(),
                    status: document.getElementById('employee-status').value || 'Active',
                    dateAdded: new Date().toISOString()
                };

                // Check for duplicate employee ID
                const existing = employees.find(emp => emp.employeeId === employeeData.employeeId);
                if (existing) {
                    showAlert('Employee ID already exists!', 'error');
                    return;
                }

                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'employees'), employeeData);
                employeeData.id = docRef.id;
                employees.push(employeeData);

                closeAddEmployeeModal();
                loadEmployeesTable();
                loadCheckoutOptions();
                showAlert('Employee added successfully!', 'success');
            } catch (error) {
                console.error('Error adding employee:', error);
                showAlert('Error adding employee: ' + error.message, 'error');
            }
        }

        // Load employees table
        function loadEmployeesTable() {
            const tbody = document.getElementById('employees-body');
            tbody.innerHTML = '';

            employees.forEach(employee => {
                const equipmentOut = transactions.filter(t => t.employeeId === employee.id && !t.returnDate).length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${employee.employeeId}</td>
                    <td>${employee.name}</td>
                    <td>${employee.department}</td>
                    <td>${employee.jobTitle}</td>
                    <td>${employee.email || 'N/A'}</td>
                    <td><span style="color: ${employee.status === 'Active' ? '#28a745' : '#dc3545'}">${employee.status}</span></td>
                    <td>${equipmentOut}</td>
                    <td>
                        <button class="btn btn-warning" onclick="editEmployee('${employee.id}')" title="Edit Employee">‚úèÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteEmployee('${employee.id}')" title="Delete Employee">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Edit employee
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;

            document.getElementById('edit-employee-doc-id').value = employee.id;
            document.getElementById('edit-employee-id').value = employee.employeeId;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-email').value = employee.email || '';
            document.getElementById('edit-employee-phone').value = employee.phone || '';
            document.getElementById('edit-employee-department').value = employee.department;
            document.getElementById('edit-employee-job-title').value = employee.jobTitle;
            document.getElementById('edit-employee-status').value = employee.status;

            document.getElementById('edit-employee-modal').style.display = 'block';
        }

        // Update employee
        async function updateEmployee() {
            try {
                const id = document.getElementById('edit-employee-doc-id').value;
                const employeeData = {
                    name: document.getElementById('edit-employee-name').value.trim(),
                    email: document.getElementById('edit-employee-email').value.trim(),
                    phone: document.getElementById('edit-employee-phone').value.trim(),
                    department: document.getElementById('edit-employee-department').value,
                    jobTitle: document.getElementById('edit-employee-job-title').value.trim(),
                    status: document.getElementById('edit-employee-status').value,
                    updated: new Date().toISOString()
                };

                const employeeRef = window.firebase.doc(window.firebase.db, 'employees', id);
                await window.firebase.updateDoc(employeeRef, employeeData);

                // Update local array
                const index = employees.findIndex(emp => emp.id === id);
                if (index !== -1) {
                    employees[index] = { ...employees[index], ...employeeData };
                }

                closeEditEmployeeModal();
                loadEmployeesTable();
                showAlert('Employee updated successfully!', 'success');
            } catch (error) {
                console.error('Error updating employee:', error);
                showAlert('Error updating employee: ' + error.message, 'error');
            }
        }

        // Delete employee
        async function deleteEmployee(id) {
            if (!confirm('Are you sure you want to delete this employee?')) return;

            try {
                // Check if employee has outstanding equipment
                const outstandingEquipment = transactions.filter(t => t.employeeId === id && !t.returnDate);
                if (outstandingEquipment.length > 0) {
                    showAlert('Cannot delete employee with outstanding equipment!', 'error');
                    return;
                }

                const employeeRef = window.firebase.doc(window.firebase.db, 'employees', id);
                await window.firebase.deleteDoc(employeeRef);

                employees = employees.filter(emp => emp.id !== id);
                loadEmployeesTable();
                loadCheckoutOptions();
                showAlert('Employee deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting employee:', error);
                showAlert('Error deleting employee: ' + error.message, 'error');
            }
        }

        // Search employees
        function searchEmployees(query) {
            const rows = document.querySelectorAll('#employees-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Checkout Equipment Functions
        function loadCheckoutOptions() {
            const equipmentSelect = document.getElementById('checkout-equipment');
            const employeeSelect = document.getElementById('checkout-employee');

            // Load available equipment (not currently checked out)
            const checkedOutEquipmentIds = transactions.filter(t => !t.returnDate).map(t => t.equipmentId);
            const availableEquipment = inventory.filter(item => !checkedOutEquipmentIds.includes(item.id));

            equipmentSelect.innerHTML = '<option value="">Select Equipment</option>';
            availableEquipment.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} ${item.assetTag ? '(' + item.assetTag + ')' : ''}`;
                equipmentSelect.appendChild(option);
            });

            // Load active employees
            const activeEmployees = employees.filter(emp => emp.status === 'Active');
            employeeSelect.innerHTML = '<option value="">Select Employee</option>';
            activeEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.employeeId})`;
                employeeSelect.appendChild(option);
            });
        }

        function loadEquipmentDetails() {
            const equipmentId = document.getElementById('checkout-equipment').value;
            const detailsDiv = document.getElementById('equipment-details');
            const infoDiv = document.getElementById('equipment-info');

            if (!equipmentId) {
                detailsDiv.style.display = 'none';
                return;
            }

            const equipment = inventory.find(item => item.id === equipmentId);
            if (equipment) {
                infoDiv.innerHTML = `
                    <p><strong>Name:</strong> ${equipment.name}</p>
                    <p><strong>Asset Tag:</strong> ${equipment.assetTag || 'N/A'}</p>
                    <p><strong>Category:</strong> ${equipment.category || 'N/A'}</p>
                    <p><strong>Current Condition:</strong> ${equipment.condition || 'N/A'}</p>
                    <p><strong>Description:</strong> ${equipment.description || 'N/A'}</p>
                    <p><strong>Location:</strong> ${equipment.location || 'N/A'}</p>
                `;
                detailsDiv.style.display = 'block';
            }
        }

        function loadEmployeeDetails() {
            const employeeId = document.getElementById('checkout-employee').value;
            const detailsDiv = document.getElementById('employee-details');
            const infoDiv = document.getElementById('employee-info');

            if (!employeeId) {
                detailsDiv.style.display = 'none';
                return;
            }

            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                infoDiv.innerHTML = `
                    <p><strong>Name:</strong> ${employee.name}</p>
                    <p><strong>Employee ID:</strong> ${employee.employeeId}</p>
                    <p><strong>Department:</strong> ${employee.department}</p>
                    <p><strong>Job Title:</strong> ${employee.jobTitle}</p>
                    <p><strong>Email:</strong> ${employee.email || 'N/A'}</p>
                `;
                                 detailsDiv.style.display = 'block';
             }
         }

        // Checkout Equipment
        async function checkoutEquipment() {
            if (!checkPermission('equipment.checkout', 'You do not have permission to check out equipment.')) return;
            
            try {
                const equipmentId = document.getElementById('checkout-equipment').value;
                const employeeId = document.getElementById('checkout-employee').value;
                const conditionBefore = document.getElementById('checkout-condition-before').value;
                const expectedReturn = document.getElementById('checkout-expected-return').value;
                const issuedBy = document.getElementById('checkout-issued-by').value || currentUser;
                const notes = document.getElementById('checkout-notes').value;

                if (!equipmentId || !employeeId || !conditionBefore || !expectedReturn) {
                    showAlert('Please fill in all required fields!', 'error');
                    return;
                }

                const equipment = inventory.find(item => item.id === equipmentId);
                const employee = employees.find(emp => emp.id === employeeId);

                const transaction = {
                    userId: currentUser,
                    companyId: currentCompany,
                    transactionId: generateTransactionId(),
                    equipmentId: equipmentId,
                    equipmentName: equipment.name,
                    assetTag: equipment.assetTag || '',
                    employeeId: employeeId,
                    employeeName: employee.name,
                    employeeIdNumber: employee.employeeId,
                    department: employee.department,
                    jobTitle: employee.jobTitle,
                    description: equipment.description || '',
                    category: equipment.category || '',
                    conditionBefore: conditionBefore,
                    issuedBy: issuedBy,
                    checkoutDate: new Date().toISOString(),
                    expectedReturnDate: expectedReturn,
                    notes: notes,
                    status: 'Checked Out'
                };

                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'transactions'), transaction);
                transaction.id = docRef.id;
                transactions.push(transaction);

                // Reset form
                document.getElementById('checkout-form').reset();
                document.getElementById('equipment-details').style.display = 'none';
                document.getElementById('employee-details').style.display = 'none';

                loadCheckoutOptions();
                loadCheckoutTable();
                loadCheckinTable();
                showAlert('Equipment checked out successfully!', 'success');
            } catch (error) {
                console.error('Error checking out equipment:', error);
                showAlert('Error checking out equipment: ' + error.message, 'error');
            }
        }

        // Generate unique transaction ID
        function generateTransactionId() {
            const date = new Date();
            const dateStr = date.getFullYear().toString() + 
                          (date.getMonth() + 1).toString().padStart(2, '0') + 
                          date.getDate().toString().padStart(2, '0');
            const timeStr = Date.now().toString().slice(-6);
            return `TXN${dateStr}${timeStr}`;
        }

        // Load checkout table
        function loadCheckoutTable() {
            const tbody = document.getElementById('checkout-body');
            tbody.innerHTML = '';

            const activeCheckouts = transactions.filter(t => !t.returnDate);

            activeCheckouts.forEach(transaction => {
                const checkoutDate = new Date(transaction.checkoutDate);
                const expectedReturn = new Date(transaction.expectedReturnDate);
                const today = new Date();
                const daysOut = Math.ceil((today - checkoutDate) / (1000 * 60 * 60 * 24));
                const isOverdue = today > expectedReturn;

                const row = document.createElement('tr');
                if (isOverdue) {
                    row.style.backgroundColor = '#ffe6e6';
                }

                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${transaction.equipmentName} ${transaction.assetTag ? '(' + transaction.assetTag + ')' : ''}</td>
                    <td>${transaction.employeeName} (${transaction.employeeIdNumber})</td>
                    <td>${checkoutDate.toLocaleDateString()}</td>
                    <td>${expectedReturn.toLocaleDateString()}</td>
                    <td>${daysOut}</td>
                    <td><span style="color: ${isOverdue ? '#dc3545' : '#28a745'}">${isOverdue ? 'Overdue' : 'Active'}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="showCheckinModal('${transaction.id}')" title="Check In">üì•</button>
                        <button class="btn btn-warning" onclick="showTransactionDetails('${transaction.id}')" title="View Details">üëÅÔ∏è</button>
                        <button class="btn btn-danger" onclick="showLostDamagedModal('${transaction.id}')" title="Report Lost/Damaged">‚ö†Ô∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load check-in table
        function loadCheckinTable() {
            const tbody = document.getElementById('checkin-available-body');
            tbody.innerHTML = '';

            const activeCheckouts = transactions.filter(t => !t.returnDate);

            activeCheckouts.forEach(transaction => {
                const checkoutDate = new Date(transaction.checkoutDate);
                const expectedReturn = new Date(transaction.expectedReturnDate);
                const today = new Date();
                const daysOut = Math.ceil((today - checkoutDate) / (1000 * 60 * 60 * 24));
                const isOverdue = today > expectedReturn;

                const row = document.createElement('tr');
                if (isOverdue) {
                    row.style.backgroundColor = '#ffe6e6';
                }

                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${transaction.equipmentName} ${transaction.assetTag ? '(' + transaction.assetTag + ')' : ''}</td>
                    <td>${transaction.employeeName} (${transaction.employeeIdNumber})</td>
                    <td>${checkoutDate.toLocaleDateString()}</td>
                    <td>${expectedReturn.toLocaleDateString()}</td>
                    <td>${daysOut}</td>
                    <td><span style="color: ${isOverdue ? '#dc3545' : '#28a745'}">${isOverdue ? 'Overdue' : 'Active'}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="showCheckinModal('${transaction.id}')" title="Check In">üì• Check In</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show check-in modal
        function showCheckinModal(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            document.getElementById('checkin-transaction-id').value = transactionId;

            const detailsContent = document.getElementById('checkin-details-content');
            detailsContent.innerHTML = `
                <p><strong>Transaction ID:</strong> ${transaction.transactionId}</p>
                <p><strong>Equipment:</strong> ${transaction.equipmentName} ${transaction.assetTag ? '(' + transaction.assetTag + ')' : ''}</p>
                <p><strong>Employee:</strong> ${transaction.employeeName} (${transaction.employeeIdNumber})</p>
                <p><strong>Department:</strong> ${transaction.department}</p>
                <p><strong>Check-Out Date:</strong> ${new Date(transaction.checkoutDate).toLocaleDateString()}</p>
                <p><strong>Expected Return:</strong> ${new Date(transaction.expectedReturnDate).toLocaleDateString()}</p>
                <p><strong>Condition (Before):</strong> ${transaction.conditionBefore}</p>
                <p><strong>Issued By:</strong> ${transaction.issuedBy}</p>
            `;

            // Show/hide replacement cost field based on condition
            const conditionSelect = document.getElementById('checkin-condition-after');
            const replacementCostGroup = document.getElementById('replacement-cost-group');
            
            conditionSelect.addEventListener('change', function() {
                if (this.value === 'Lost' || this.value === 'Damaged') {
                    replacementCostGroup.style.display = 'block';
                } else {
                    replacementCostGroup.style.display = 'none';
                }
            });

            document.getElementById('checkin-modal').style.display = 'block';
        }

        function closeCheckinModal() {
            document.getElementById('checkin-modal').style.display = 'none';
            document.getElementById('checkin-form').reset();
            document.getElementById('replacement-cost-group').style.display = 'none';
        }

        // Check-in equipment
        async function checkinEquipment() {
            if (!checkPermission('equipment.checkin', 'You do not have permission to check in equipment.')) return;
            
            try {
                const transactionId = document.getElementById('checkin-transaction-id').value;
                const conditionAfter = document.getElementById('checkin-condition-after').value;
                const returnedBy = document.getElementById('checkin-returned-by').value || currentUser;
                const returnNotes = document.getElementById('checkin-return-notes').value;
                const replacementCost = document.getElementById('checkin-replacement-cost').value;

                if (!conditionAfter) {
                    showAlert('Please select the equipment condition!', 'error');
                    return;
                }

                const updateData = {
                    returnDate: new Date().toISOString(),
                    conditionAfter: conditionAfter,
                    returnedBy: returnedBy,
                    returnNotes: returnNotes,
                    status: 'Returned'
                };

                if (conditionAfter === 'Lost' || conditionAfter === 'Damaged') {
                    updateData.replacementCost = parseFloat(replacementCost) || 0;
                    updateData.status = conditionAfter;
                }

                const transactionRef = window.firebase.doc(window.firebase.db, 'transactions', transactionId);
                await window.firebase.updateDoc(transactionRef, updateData);

                // Update local array
                const index = transactions.findIndex(t => t.id === transactionId);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], ...updateData };
                }

                closeCheckinModal();
                loadCheckoutTable();
                loadCheckinTable();
                loadEquipmentHistory();
                loadEmployeeHistory();
                showAlert('Equipment checked in successfully!', 'success');

                // If lost or damaged, automatically create a report
                if (conditionAfter === 'Lost' || conditionAfter === 'Damaged') {
                    showLostDamagedModal(transactionId);
                }
            } catch (error) {
                console.error('Error checking in equipment:', error);
                showAlert('Error checking in equipment: ' + error.message, 'error');
            }
        }

        // Show transaction details modal
        function showTransactionDetails(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            const content = document.getElementById('transaction-details-content');
            content.innerHTML = `
                <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
                    <h4>Transaction Information</h4>
                    <p><strong>Transaction ID:</strong> ${transaction.transactionId}</p>
                    <p><strong>Status:</strong> ${transaction.status}</p>
                    <p><strong>Check-Out Date:</strong> ${new Date(transaction.checkoutDate).toLocaleDateString()}</p>
                    ${transaction.returnDate ? `<p><strong>Return Date:</strong> ${new Date(transaction.returnDate).toLocaleDateString()}</p>` : ''}
                    <p><strong>Expected Return:</strong> ${new Date(transaction.expectedReturnDate).toLocaleDateString()}</p>
                    <p><strong>Issued By:</strong> ${transaction.issuedBy}</p>
                    ${transaction.returnedBy ? `<p><strong>Returned By:</strong> ${transaction.returnedBy}</p>` : ''}
                </div>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Equipment Information</h4>
                    <p><strong>Name:</strong> ${transaction.equipmentName}</p>
                    <p><strong>Asset Tag:</strong> ${transaction.assetTag || 'N/A'}</p>
                    <p><strong>Category:</strong> ${transaction.category}</p>
                    <p><strong>Description:</strong> ${transaction.description || 'N/A'}</p>
                    <p><strong>Condition (Before):</strong> ${transaction.conditionBefore}</p>
                    ${transaction.conditionAfter ? `<p><strong>Condition (After):</strong> ${transaction.conditionAfter}</p>` : ''}
                </div>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Employee Information</h4>
                    <p><strong>Name:</strong> ${transaction.employeeName}</p>
                    <p><strong>Employee ID:</strong> ${transaction.employeeIdNumber}</p>
                    <p><strong>Department:</strong> ${transaction.department}</p>
                    <p><strong>Job Title:</strong> ${transaction.jobTitle}</p>
                </div>
                ${transaction.notes || transaction.returnNotes ? `
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Notes</h4>
                    ${transaction.notes ? `<p><strong>Checkout Notes:</strong> ${transaction.notes}</p>` : ''}
                    ${transaction.returnNotes ? `<p><strong>Return Notes:</strong> ${transaction.returnNotes}</p>` : ''}
                </div>` : ''}
                ${transaction.replacementCost ? `
                <div style="background:#ffe6e6; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Replacement Cost</h4>
                    <p><strong>Cost:</strong> $${transaction.replacementCost}</p>
                </div>` : ''}
            `;

            document.getElementById('transaction-details-modal').style.display = 'block';
        }

        function closeTransactionDetails() {
            document.getElementById('transaction-details-modal').style.display = 'none';
        }

        // Lost/Damaged Equipment Reports
        function showLostDamagedModal(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;

            document.getElementById('report-transaction-id').value = transactionId;

            const detailsContent = document.getElementById('report-equipment-content');
            detailsContent.innerHTML = `
                <p><strong>Transaction ID:</strong> ${transaction.transactionId}</p>
                <p><strong>Equipment:</strong> ${transaction.equipmentName} ${transaction.assetTag ? '(' + transaction.assetTag + ')' : ''}</p>
                <p><strong>Employee:</strong> ${transaction.employeeName} (${transaction.employeeIdNumber})</p>
                <p><strong>Department:</strong> ${transaction.department}</p>
                <p><strong>Check-Out Date:</strong> ${new Date(transaction.checkoutDate).toLocaleDateString()}</p>
                <p><strong>Condition (Before):</strong> ${transaction.conditionBefore}</p>
            `;

            // Pre-fill fields if already damaged/lost
            if (transaction.conditionAfter === 'Lost') {
                document.getElementById('report-type').value = 'Lost';
            } else if (transaction.conditionAfter === 'Damaged') {
                document.getElementById('report-type').value = 'Damaged';
            }

            if (transaction.replacementCost) {
                document.getElementById('report-replacement-cost').value = transaction.replacementCost;
            }

            document.getElementById('lost-damaged-modal').style.display = 'block';
        }

        function closeLostDamagedModal() {
            document.getElementById('lost-damaged-modal').style.display = 'none';
            document.getElementById('lost-damaged-form').reset();
        }

        async function submitLostDamagedReport() {
            try {
                const transactionId = document.getElementById('report-transaction-id').value;
                const reportType = document.getElementById('report-type').value;
                const description = document.getElementById('report-description').value;
                const dateDiscovered = document.getElementById('report-date-discovered').value;
                const replacementCost = document.getElementById('report-replacement-cost').value;
                const actionTaken = document.getElementById('report-action-taken').value;
                const reportedBy = document.getElementById('report-reported-by').value || currentUser;

                if (!reportType || !description || !replacementCost) {
                    showAlert('Please fill in all required fields!', 'error');
                    return;
                }

                const transaction = transactions.find(t => t.id === transactionId);
                const report = {
                    userId: currentUser,
                    companyId: currentCompany,
                    transactionId: transactionId,
                    transactionIdNumber: transaction.transactionId,
                    equipmentId: transaction.equipmentId,
                    equipmentName: transaction.equipmentName,
                    assetTag: transaction.assetTag,
                    employeeId: transaction.employeeId,
                    employeeName: transaction.employeeName,
                    employeeIdNumber: transaction.employeeIdNumber,
                    department: transaction.department,
                    reportType: reportType,
                    description: description,
                    dateDiscovered: dateDiscovered || new Date().toISOString().split('T')[0],
                    replacementCost: parseFloat(replacementCost),
                    actionTaken: actionTaken,
                    reportedBy: reportedBy,
                    reportDate: new Date().toISOString(),
                    status: 'Open'
                };

                const docRef = await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'lostDamagedReports'), report);
                report.id = docRef.id;
                lostDamagedReports.push(report);

                closeLostDamagedModal();
                showAlert(`${reportType} equipment report submitted successfully!`, 'success');
            } catch (error) {
                console.error('Error submitting report:', error);
                showAlert('Error submitting report: ' + error.message, 'error');
            }
        }

        // Equipment History Functions
        function loadEquipmentHistory() {
            const tbody = document.getElementById('equipment-history-body');
            const equipmentFilter = document.getElementById('equipment-filter');
            
            tbody.innerHTML = '';
            
            // Populate equipment filter
            equipmentFilter.innerHTML = '<option value="">All Equipment</option>';
            const uniqueEquipment = [...new Set(transactions.map(t => t.equipmentName))];
            uniqueEquipment.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                equipmentFilter.appendChild(option);
            });

            transactions.forEach(transaction => {
                const checkoutDate = new Date(transaction.checkoutDate);
                const returnDate = transaction.returnDate ? new Date(transaction.returnDate) : null;
                const duration = returnDate ? 
                    Math.ceil((returnDate - checkoutDate) / (1000 * 60 * 60 * 24)) + ' days' : 
                    'Still out';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${transaction.equipmentName}</td>
                    <td>${transaction.assetTag || 'N/A'}</td>
                    <td>${transaction.employeeName} (${transaction.employeeIdNumber})</td>
                    <td>${checkoutDate.toLocaleDateString()}</td>
                    <td>${returnDate ? returnDate.toLocaleDateString() : 'Not returned'}</td>
                    <td>${duration}</td>
                    <td>${transaction.conditionBefore}</td>
                    <td>${transaction.conditionAfter || 'N/A'}</td>
                    <td><span style="color: ${getStatusColor(transaction.status)}">${transaction.status}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="showTransactionDetails('${transaction.id}')" title="View Details">üëÅÔ∏è</button>
                        ${transaction.status === 'Lost' || transaction.status === 'Damaged' ? 
                            `<button class="btn btn-danger" onclick="viewLostDamagedReport('${transaction.id}')" title="View Report">üìã</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterEquipmentHistory() {
            const filter = document.getElementById('equipment-filter').value;
            const rows = document.querySelectorAll('#equipment-history-body tr');

            rows.forEach(row => {
                if (!filter || row.cells[1].textContent.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Employee History Functions
        function loadEmployeeHistory() {
            const tbody = document.getElementById('employee-history-body');
            const employeeFilter = document.getElementById('employee-filter');
            
            tbody.innerHTML = '';
            
            // Populate employee filter
            employeeFilter.innerHTML = '<option value="">All Employees</option>';
            const uniqueEmployees = [...new Set(transactions.map(t => t.employeeName))];
            uniqueEmployees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeFilter.appendChild(option);
            });

            transactions.forEach(transaction => {
                const checkoutDate = new Date(transaction.checkoutDate);
                const returnDate = transaction.returnDate ? new Date(transaction.returnDate) : null;
                const duration = returnDate ? 
                    Math.ceil((returnDate - checkoutDate) / (1000 * 60 * 60 * 24)) + ' days' : 
                    'Still out';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.transactionId}</td>
                    <td>${transaction.employeeName} (${transaction.employeeIdNumber})</td>
                    <td>${transaction.equipmentName} ${transaction.assetTag ? '(' + transaction.assetTag + ')' : ''}</td>
                    <td>${checkoutDate.toLocaleDateString()}</td>
                    <td>${returnDate ? returnDate.toLocaleDateString() : 'Not returned'}</td>
                    <td>${duration}</td>
                    <td>${transaction.conditionBefore}</td>
                    <td>${transaction.conditionAfter || 'N/A'}</td>
                    <td><span style="color: ${getStatusColor(transaction.status)}">${transaction.status}</span></td>
                    <td>
                        <button class="btn btn-warning" onclick="showTransactionDetails('${transaction.id}')" title="View Details">üëÅÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterEmployeeHistory() {
            const filter = document.getElementById('employee-filter').value;
            const rows = document.querySelectorAll('#employee-history-body tr');

            rows.forEach(row => {
                if (!filter || row.cells[1].textContent.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Helper function for status colors
        function getStatusColor(status) {
            switch(status) {
                case 'Checked Out': return '#007bff';
                case 'Returned': return '#28a745';
                case 'Overdue': return '#dc3545';
                case 'Lost': return '#dc3545';
                case 'Damaged': return '#ffc107';
                default: return '#6c757d';
            }
        }

        // Search Functions
        function searchCheckouts(query) {
            const rows = document.querySelectorAll('#checkout-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function searchCheckinsAvailable(query) {
            const rows = document.querySelectorAll('#checkin-available-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function searchEquipmentHistory(query) {
            const rows = document.querySelectorAll('#equipment-history-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function searchEmployeeHistory(query) {
            const rows = document.querySelectorAll('#employee-history-body tr');
            const searchTerm = query.toLowerCase();

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function viewLostDamagedReport(transactionId) {
            const report = lostDamagedReports.find(r => r.transactionId === transactionId);
            if (!report) {
                showAlert('No report found for this transaction', 'error');
                return;
            }

            const content = document.getElementById('transaction-details-content');
            content.innerHTML = `
                <div style="background:#ffe6e6; padding:15px; border-radius:8px;">
                    <h4>Lost/Damaged Equipment Report</h4>
                    <p><strong>Report Type:</strong> ${report.reportType}</p>
                    <p><strong>Report Date:</strong> ${new Date(report.reportDate).toLocaleDateString()}</p>
                    <p><strong>Date Discovered:</strong> ${new Date(report.dateDiscovered).toLocaleDateString()}</p>
                    <p><strong>Reported By:</strong> ${report.reportedBy}</p>
                    <p><strong>Status:</strong> ${report.status}</p>
                </div>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Equipment Information</h4>
                    <p><strong>Name:</strong> ${report.equipmentName}</p>
                    <p><strong>Asset Tag:</strong> ${report.assetTag || 'N/A'}</p>
                    <p><strong>Employee:</strong> ${report.employeeName} (${report.employeeIdNumber})</p>
                    <p><strong>Department:</strong> ${report.department}</p>
                </div>
                <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px;">
                    <h4>Report Details</h4>
                    <p><strong>Description:</strong> ${report.description}</p>
                    <p><strong>Replacement Cost:</strong> $${report.replacementCost}</p>
                    ${report.actionTaken ? `<p><strong>Action Taken:</strong> ${report.actionTaken}</p>` : ''}
                </div>
            `;

            document.getElementById('transaction-details-modal').style.display = 'block';
        }

        // ========================
        // TEAM MANAGEMENT FUNCTIONS
        // ========================

        function updateUserInterface() {
            // Show/hide team management for admins
            const teamSection = document.getElementById('team-management-section');
            if (teamSection) {
                teamSection.style.display = hasPermission('all') ? 'block' : 'none';
            }

            // Update about section with current user info
            if (currentUserData) {
                document.getElementById('current-company').textContent = currentUserData.companyName || 'Unknown';
                document.getElementById('current-role').textContent = ROLES[userRole]?.name || userRole;
            }

            // Load team members if admin
            if (hasPermission('all')) {
                loadTeamMembers();
            }
        }

        function showInviteUserModal() {
            if (!checkPermission('all', 'Only admins can invite team members.')) return;
            document.getElementById('invite-user-modal').style.display = 'block';
        }

        function closeInviteUserModal() {
            document.getElementById('invite-user-modal').style.display = 'none';
            document.getElementById('invite-user-form').reset();
            document.getElementById('role-description').style.display = 'none';
        }

        function showRoleDescription() {
            const roleSelect = document.getElementById('invite-role');
            const descDiv = document.getElementById('role-description');
            const permissionsList = document.getElementById('role-permissions-list');
            
            const selectedRole = roleSelect.value;
            if (selectedRole && ROLES[selectedRole]) {
                const role = ROLES[selectedRole];
                let permissionsHtml = '<ul>';
                
                if (role.permissions.includes('all')) {
                    permissionsHtml += '<li><strong>Full System Access</strong> - Can manage everything</li>';
                } else {
                    role.permissions.forEach(permission => {
                        const descriptions = {
                            'inventory.manage': 'Add, edit, delete inventory items',
                            'inventory.view': 'View inventory items',
                            'equipment.manage': 'Full equipment management',
                            'equipment.checkout': 'Check out equipment to employees',
                            'equipment.checkin': 'Check in equipment from employees',
                            'employees.manage': 'Add, edit, delete employees',
                            'reports.view': 'View all reports and analytics',
                            'reports.own': 'View only own transaction history',
                            'transactions.manage': 'Manage all transactions',
                            'transactions.view': 'View transaction history'
                        };
                        permissionsHtml += `<li>${descriptions[permission] || permission}</li>`;
                    });
                }
                
                permissionsHtml += '</ul>';
                permissionsList.innerHTML = permissionsHtml;
                descDiv.style.display = 'block';
            } else {
                descDiv.style.display = 'none';
            }
        }

        async function inviteUser() {
            if (!checkPermission('all', 'Only admins can invite team members.')) return;
            
            try {
                const email = document.getElementById('invite-email').value.trim().toLowerCase();
                const fullName = document.getElementById('invite-full-name').value.trim();
                const role = document.getElementById('invite-role').value;
                const tempPassword = document.getElementById('invite-temporary-password').value;
                const message = document.getElementById('invite-message').value.trim();

                if (!email || !fullName || !role || !tempPassword) {
                    showAlert('Please fill in all required fields!', 'error');
                    return;
                }

                // Check if user already exists
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const existingUserQuery = window.firebase.query(usersRef, window.firebase.where('email', '==', email));
                const existingUserSnapshot = await window.firebase.getDocs(existingUserQuery);
                
                if (!existingUserSnapshot.empty) {
                    showAlert('A user with this email already exists!', 'error');
                    return;
                }

                // Create Firebase auth account
                const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, tempPassword);
                const user = userCredential.user;

                // Create user profile
                const userProfile = {
                    username: email.split('@')[0], // Use part before @ as username
                    email: email,
                    fullName: fullName,
                    companyId: currentCompany,
                    companyName: currentUserData.companyName,
                    role: role,
                    permissions: ROLES[role]?.permissions || [],
                    status: 'active',
                    invitedBy: currentUser,
                    invitedAt: new Date().toISOString(),
                    mustChangePassword: true,
                    created: new Date().toISOString()
                };

                await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'users'), userProfile);

                // TODO: Send invitation email (would need email service setup)
                // sendInvitationEmail(email, fullName, tempPassword, message);

                closeInviteUserModal();
                loadTeamMembers();
                showAlert(`Invitation sent to ${fullName} (${email})! They can now log in with the temporary password.`, 'success');
            } catch (error) {
                console.error('Error inviting user:', error);
                showAlert('Error sending invitation: ' + error.message, 'error');
            }
        }

        async function loadTeamMembers() {
            if (!hasPermission('all')) return;

            try {
                const usersRef = window.firebase.collection(window.firebase.db, 'users');
                const q = window.firebase.query(usersRef, window.firebase.where('companyId', '==', currentCompany));
                const querySnapshot = await window.firebase.getDocs(q);
                
                const tbody = document.getElementById('team-members-body');
                tbody.innerHTML = '';

                querySnapshot.forEach(doc => {
                    const userData = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${userData.fullName || userData.username}</td>
                        <td>${userData.email}</td>
                        <td><span style="color: ${getRoleColor(userData.role)}">${ROLES[userData.role]?.name || userData.role}</span></td>
                        <td><span style="color: ${userData.status === 'active' ? '#28a745' : '#dc3545'}">${userData.status}</span></td>
                        <td>${userData.lastIP ? new Date(userData.created).toLocaleDateString() : 'Never'}</td>
                        <td>
                            ${userData.email !== currentUserData.email ? `
                                <button class="btn btn-warning" onclick="editTeamMember('${doc.id}')" title="Edit User">‚úèÔ∏è</button>
                                <button class="btn btn-danger" onclick="toggleUserStatus('${doc.id}', '${userData.status}')" title="${userData.status === 'active' ? 'Deactivate' : 'Activate'} User">${userData.status === 'active' ? 'üö´' : '‚úÖ'}</button>
                            ` : '<em>You</em>'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading team members:', error);
                showAlert('Error loading team members: ' + error.message, 'error');
            }
        }

        function getRoleColor(role) {
            const colors = {
                admin: '#dc3545',
                manager: '#007bff',
                employee: '#28a745',
                viewer: '#6c757d'
            };
            return colors[role] || '#6c757d';
        }

        async function toggleUserStatus(userId, currentStatus) {
            if (!checkPermission('all', 'Only admins can manage user status.')) return;
            
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            const action = newStatus === 'active' ? 'activate' : 'deactivate';
            
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;

            try {
                const userRef = window.firebase.doc(window.firebase.db, 'users', userId);
                await window.firebase.updateDoc(userRef, { 
                    status: newStatus,
                    updatedBy: currentUser,
                    updatedAt: new Date().toISOString()
                });
                
                loadTeamMembers();
                showAlert(`User ${action}d successfully!`, 'success');
            } catch (error) {
                console.error('Error updating user status:', error);
                showAlert('Error updating user status: ' + error.message, 'error');
            }
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            showAlert('A JavaScript error occurred: ' + event.message, 'error');
            console.error('Global error:', event.error);
        });

        // Add Sign Up button to login form
        function showSignupForm() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('setup-credentials').style.display = 'block';
        }
        function showLoginForm() {
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('setup-credentials').style.display = 'none';
        }
    </script>
</body>
</html> 